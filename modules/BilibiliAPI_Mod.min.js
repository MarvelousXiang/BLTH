// ==UserScript==
// @name          BilibiliAPI_mod
// @namespace     https://github.com/SeaLoong
// @version       2.0.6
// @description   BilibiliAPI，PC端抓包研究所得，原作者是SeaLoong。我在此基础上补充新的API。
// @author        SeaLoong, andywang425
// @require       https://cdn.bootcss.com/jquery/3.2.1/jquery.min.js
// @grant         none
// @include       *
// @license       MIT
// ==/UserScript==
let BilibiliAPI_csrf_token,BilibiliAPI_visit_id,BilibiliAPI_ts_ms=()=>Date.now(),BilibiliAPI_ts_s=()=>Math.round(BilibiliAPI_ts_ms()/1e3);var BilibiliAPI={setCommonArgs:(i="",e="")=>{BilibiliAPI_csrf_token=i,BilibiliAPI_visit_id=e},TreasureBox:{getAward:(i,e,a)=>BilibiliAPI.lottery.SilverBox.getAward(i,e,a),getCaptcha:i=>BilibiliAPI.lottery.SilverBox.getCaptcha(i),getCurrentTask:()=>BilibiliAPI.lottery.SilverBox.getCurrentTask()},Exchange:{coin2silver:(i,e)=>BilibiliAPI.pay.coin2silver(i,e),silver2coin:i=>BilibiliAPI.pay.silver2coin(i),old:{coin2silver:i=>BilibiliAPI.exchange.coin2silver(i),silver2coin:()=>BilibiliAPI.exchange.silver2coin()}},Lottery:{Gift:{check:i=>BilibiliAPI.xlive.smalltv.check(i),join:(i,e,a)=>BilibiliAPI.xlive.smalltv.join(i,e,a),notice:(i,e)=>BilibiliAPI.xlive.smalltv.notice(i,e)},Raffle:{check:i=>BilibiliAPI.activity.check(i),join:(i,e)=>BilibiliAPI.activity.join(i,e),notice:(i,e)=>BilibiliAPI.activity.notice(i,e)},MaterialObject:{getRoomActivityByRoomid:i=>BilibiliAPI.lottery.box.getRoomActivityByRoomid(i),getStatus:(i,e)=>BilibiliAPI.lottery.box.getStatus(i,e),draw:(i,e)=>BilibiliAPI.lottery.box.draw(i,e),getWinnerGroupInfo:(i,e)=>BilibiliAPI.lottery.box.getWinnerGroupInfo(i,e)},Guard:{check:i=>BilibiliAPI.lottery.lottery.check_guard(i),join:(i,e,a)=>BilibiliAPI.xlive.guard.join(i,e,a)},Pk:{check:i=>BilibiliAPI.xlive.pk.check(i),join:(i,e)=>BilibiliAPI.xlive.pk.join(i,e)}},Group:{my_groups:()=>BilibiliAPI.link_group.my_groups(),sign_in:(i,e)=>BilibiliAPI.link_group.sign_in(i,e)},Storm:{check:i=>BilibiliAPI.lottery.Storm.check(i),join:(i,e,a,t,l)=>BilibiliAPI.lottery.Storm.join(i,e,a,t,l),join_ex:(i,e,a,t,l,r="",o="",n=16777215)=>BilibiliAPI.lottery.Storm.join_ex(i,e,a,t,l,"","",16777215)},HeartBeat:{web:()=>BilibiliAPI.user.userOnlineHeart(),mobile:()=>BilibiliAPI.mobile.userOnlineHeart()},DailyReward:{task:()=>BilibiliAPI.home.reward(),exp:()=>BilibiliAPI.exp(),login:()=>BilibiliAPI.x.now(),watch:(i,e,a,t,l,r,o,n,s)=>BilibiliAPI.x.heartbeat(i,e,a,t,l,r,o,n,s),coin:(i,e)=>BilibiliAPI.x.coin_add(i,e),share:i=>BilibiliAPI.x.share_add(i)},runUntilSucceed:(i,e=0,a=2)=>{a>0&&setTimeout(()=>{i()||BilibiliAPI.runUntilSucceed(i,500,--a)},e)},processing:0,ajax:i=>{void 0===i.xhrFields&&(i.xhrFields={}),i.xhrFields.withCredentials=!0,jQuery.extend(i,{url:("//"===i.url.substr(0,2)?"":"//api.live.bilibili.com/")+i.url,method:i.method||"GET",crossDomain:!0,dataType:i.dataType||"json"});const e=jQuery.Deferred();return BilibiliAPI.runUntilSucceed(()=>!(BilibiliAPI.processing>8)&&(++BilibiliAPI.processing,jQuery.ajax(i).then((i,a,t)=>(--BilibiliAPI.processing,e.resolve(i,a,t),!0),(i,a,t)=>(--BilibiliAPI.processing,e.reject(i,a,t),!0)))),e},ajaxWithCommonArgs:i=>(i.data||(i.data={}),i.data.csrf=BilibiliAPI_csrf_token,i.data.csrf_token=BilibiliAPI_csrf_token,i.data.visit_id=BilibiliAPI_visit_id,BilibiliAPI.ajax(i)),ajaxGetCaptchaKey:()=>BilibiliAPI.ajax({url:"//www.bilibili.com/plus/widget/ajaxGetCaptchaKey.php?js"}),exp:()=>BilibiliAPI.ajax({url:"//www.bilibili.com/plus/account/exp.php"}),msg:i=>BilibiliAPI.ajaxWithCommonArgs({method:"POST",url:"ajax/msg",data:{roomid:i}}),ajaxCapsule:()=>BilibiliAPI.ajax({url:"api/ajaxCapsule"}),player:(i,e,a="pc",t="web")=>BilibiliAPI.ajax({url:"api/player",data:{id:"string"==typeof i&&"cid:"===i.substr(0,4)?i:"cid:"+i,ts:"string"==typeof e?e:e.toString(16),platform:a,player_type:t},dataType:"text"}),create:(i,e)=>BilibiliAPI.ajax({url:"captcha/v1/Captcha/create",data:{width:i||"112",height:e||"32"},cache:!1}),topList:(i,e,a)=>BilibiliAPI.ajax({url:"guard/topList",data:{roomid:i,page:e,ruid:a}}),getSuser:()=>BilibiliAPI.ajax({url:"msg/getSuser"}),refresh:(i="all")=>BilibiliAPI.ajax({url:"index/refresh?area="+i}),get_ip_addr:()=>BilibiliAPI.ajax({url:"ip_service/v1/ip_service/get_ip_addr"}),getuserinfo:()=>BilibiliAPI.ajax({url:"user/getuserinfo"}),activity:{mobileActivity:()=>BilibiliAPI.ajax({url:"activity/v1/Common/mobileActivity"}),mobileRoomInfo:i=>BilibiliAPI.ajax({url:"activity/v1/Common/mobileRoomInfo",data:{roomid:i}}),roomInfo:(i,e,a,t)=>BilibiliAPI.ajax({url:"activity/v1/Common/roomInfo",data:{roomid:i,ruid:e,area_v2_id:a,area_v2_parent_id:t}}),welcomeInfo:(i,e)=>BilibiliAPI.ajax({url:"activity/v1/Common/welcomeInfo",data:{roomid:i,ruid:e}}),check:i=>BilibiliAPI.ajax({url:"activity/v1/Raffle/check?roomid="+i}),join:(i,e)=>BilibiliAPI.ajax({url:"activity/v1/Raffle/join",data:{roomid:i,raffleId:e}}),notice:(i,e)=>BilibiliAPI.ajax({url:"activity/v1/Raffle/notice",data:{roomid:i,raffleId:e}}),receive_award:i=>BilibiliAPI.ajaxWithCommonArgs({method:"POST",url:"activity/v1/task/receive_award",data:{task_id:i}})},av:{getTimestamp:(i="pc")=>BilibiliAPI.ajaxWithCommonArgs({method:"POST",url:"av/v1/Time/getTimestamp",data:{platform:i}})},dynamic_svr:{dynamic_new:(i,e=8)=>BilibiliAPI.ajax({url:"dynamic_svr/v1/dynamic_svr/dynamic_new",data:{uid:i,type:e}}),space_history:(i,e,a,t)=>BilibiliAPI.ajax({url:"dynamic_svr/v1/dynamic_svr/space_history",data:{visitor_uid:i,host_uid:e,offset_dynamic_id:a,need_top:t}})},exchange:{coin2silver:i=>BilibiliAPI.ajax({method:"POST",url:"exchange/coin2silver",data:{coin:i}}),silver2coin:()=>BilibiliAPI.ajax({type:"GET",url:"exchange/silver2coin"})},fans_medal:{get_fans_medal_info:(i,e,a=1)=>BilibiliAPI.ajaxWithCommonArgs({method:"POST",url:"fans_medal/v1/fans_medal/get_fans_medal_info",data:{source:a,uid:i,target_id:e}})},feed_svr:{notice:()=>BilibiliAPI.ajaxWithCommonArgs({method:"POST",url:"feed_svr/v1/feed_svr/notice",data:{}}),my:(i,e=0,a=0,t=0)=>BilibiliAPI.ajaxWithCommonArgs({method:"POST",url:"feed_svr/v1/feed_svr/my",data:{live_status:e,type:a,page_size:i,offset:t}})},gift:{bag_list:()=>BilibiliAPI.ajax({url:"gift/v2/gift/bag_list"}),send:(i,e,a,t,l,r,o="silver",n="pc",s="live",d=0,m=0)=>BilibiliAPI.ajaxWithCommonArgs({method:"POST",url:"gift/v2/gift/send",data:{uid:i,gift_id:e,ruid:a,gift_num:t,coin_type:o,bag_id:0,platform:n,biz_code:s,biz_id:l,rnd:r,storm_beat_id:d,metadata:"",price:m}}),bag_send:(i,e,a,t,l,r,o,n="pc",s="live",d=0,m=0)=>BilibiliAPI.ajaxWithCommonArgs({method:"POST",url:"gift/v2/live/bag_send",data:{uid:i,gift_id:e,ruid:a,gift_num:t,bag_id:l,platform:n,biz_code:s,biz_id:r,rnd:o,storm_beat_id:d,metadata:"",price:m}}),gift_config:()=>BilibiliAPI.ajax({url:"gift/v3/live/gift_config"}),heart_gift_receive:(i,e)=>BilibiliAPI.ajax({url:"gift/v2/live/heart_gift_receive",data:{roomid:i,area_v2_id:e}}),heart_gift_status:(i,e)=>BilibiliAPI.ajax({url:"gift/v2/live/heart_gift_status",data:{roomid:i,area_v2_id:e}}),receive_daily_bag:()=>BilibiliAPI.ajax({url:"gift/v2/live/receive_daily_bag"}),room_gift_list:(i,e)=>BilibiliAPI.ajax({url:"gift/v2/live/room_gift_list",data:{roomid:i,area_v2_id:e}}),smalltv:{check:i=>BilibiliAPI.ajax({url:"gift/v3/smalltv/check",data:{roomid:i}}),join:(i,e,a="Gift")=>BilibiliAPI.ajaxWithCommonArgs({method:"POST",url:"gift/v3/smalltv/join",data:{roomid:i,raffleId:e,type:a}}),notice:(i,e="small_tv")=>BilibiliAPI.ajax({url:"gift/v3/smalltv/notice",data:{type:e,raffleId:i}})}},giftBag:{getSendGift:()=>BilibiliAPI.ajax({url:"giftBag/getSendGift"}),sendDaily:()=>BilibiliAPI.ajax({url:"giftBag/sendDaily"})},home:{reward:()=>BilibiliAPI.ajax({url:"//account.bilibili.com/home/reward"})},i:{ajaxCancelWear:()=>BilibiliAPI.ajax({url:"i/ajaxCancelWear"}),ajaxGetAchieve:(i,e,a=6,t="normal",l=0,r="all")=>BilibiliAPI.ajax({url:"i/api/ajaxGetAchieve",data:{type:t,status:l,category:r,keywords:i,page:e,pageSize:a}}),ajaxGetMyMedalList:()=>BilibiliAPI.ajax({url:"i/ajaxGetMyMedalList"}),ajaxWearFansMedal:i=>BilibiliAPI.ajax({url:"i/ajaxWearFansMedal?medal_id="+i}),following:(i=1,e=9)=>BilibiliAPI.ajax({url:"i/api/following",data:{page:i,pageSize:e}}),guard:(i,e=10)=>BilibiliAPI.ajax({url:"i/api/guard",data:{page:i,pageSize:e}}),liveinfo:()=>BilibiliAPI.ajax({url:"i/api/liveinfo"}),medal:(i=1,e=10)=>BilibiliAPI.ajax({url:"i/api/medal",data:{page:i,pageSize:e}}),operation:(i=1)=>BilibiliAPI.ajax({url:"i/api/operation?page="+i}),taskInfo:()=>BilibiliAPI.ajax({url:"i/api/taskInfo"})},link_group:{my_groups:()=>BilibiliAPI.ajax({url:"link_group/v1/member/my_groups"}),sign_in:(i,e)=>BilibiliAPI.ajax({url:"link_setting/v1/link_setting/sign_in",data:{group_id:i,owner_id:e}}),buy_medal:(i,e="metal",a="android")=>BilibiliAPI.ajaxWithCommonArgs({method:"POST",url:"//api.vc.bilibili.com/link_group/v1/member/buy_medal",data:{master_uid:i,coin_type:e,platform:a}})},live:{getRoomKanBanModel:i=>BilibiliAPI.ajax({url:"live/getRoomKanBanModel?roomid"+i}),rankTab:i=>BilibiliAPI.ajax({url:"live/rankTab?roomid="+i}),roomAdList:()=>BilibiliAPI.ajax({url:"live/roomAdList"})},live_user:{get_anchor_in_room:i=>BilibiliAPI.ajax({url:"live_user/v1/UserInfo/get_anchor_in_room?roomid="+i}),get_info_in_room:i=>BilibiliAPI.ajax({url:"live_user/v1/UserInfo/get_info_in_room?roomid="+i}),get_weared_medal:(i,e,a=1)=>BilibiliAPI.ajaxWithCommonArgs({method:"POST",url:"live_user/v1/UserInfo/get_weared_medal",data:{source:a,uid:i,target_id:e}}),governorShow:i=>BilibiliAPI.ajax({url:"live_user/v1/Master/governorShow?target_id="+i})},lottery:{box:{getRoomActivityByRoomid:i=>BilibiliAPI.ajax({url:"lottery/v1/box/getRoomActivityByRoomid?roomid="+i}),getStatus:(i,e="")=>BilibiliAPI.ajax({url:"lottery/v2/box/getStatus",data:{aid:i,times:e}}),draw:(i,e=1)=>BilibiliAPI.ajax({url:"/xlive/lottery-interface/v2/Box/draw",data:{aid:i,number:e}}),getWinnerGroupInfo:(i,e=1)=>BilibiliAPI.ajax({url:"lottery/v2/box/getWinnerGroupInfo",data:{aid:i,number:e}})},SilverBox:{getAward:(i,e,a)=>BilibiliAPI.ajax({url:"lottery/v1/SilverBox/getAward",data:{time_start:i,end_time:e,captcha:a}}),getCaptcha:i=>BilibiliAPI.ajax({url:"lottery/v1/SilverBox/getCaptcha?ts="+i}),getCurrentTask:()=>BilibiliAPI.ajax({url:"lottery/v1/SilverBox/getCurrentTask"})},Storm:{check:i=>BilibiliAPI.ajax({url:"lottery/v1/Storm/check?roomid="+i}),join:(i,e,a,t,l=16777215)=>BilibiliAPI.ajaxWithCommonArgs({method:"POST",url:"lottery/v1/Storm/join",data:{id:i,color:l,captcha_token:e,captcha_phrase:a,roomid:t}}),join_ex:(i,e,a,t,l)=>{let r=TokenUtil.signQuery(KeySign.sort({id:i,access_key:a,appkey:t,actionKey:"appkey",build:5561e3,channel:"bili",device:"android",mobi_app:"android",platform:"android"}));return BilibiliAPI.ajaxWithCommonArgs({method:"POST",url:"xlive/lottery-interface/v1/storm/Join?"+r,headers:l,roomid:e})}},lottery:{check_guard:i=>BilibiliAPI.ajax({url:"lottery/v1/Lottery/check_guard?roomid="+i}),join:(i,e,a="guard")=>BilibiliAPI.ajaxWithCommonArgs({method:"POST",url:"lottery/v2/Lottery/join",data:{roomid:i,id:e,type:a}})}},mobile:{userOnlineHeart:()=>BilibiliAPI.ajaxWithCommonArgs({method:"POST",url:"mobile/userOnlineHeart",data:{}})},pay:{coin2silver:(i,e="pc")=>BilibiliAPI.ajaxWithCommonArgs({method:"POST",url:"pay/v1/Exchange/coin2silver",data:{num:i,platform:e}}),getRule:(i="pc")=>BilibiliAPI.ajax({url:"pay/v1/Exchange/getRule?platform="+i}),getStatus:(i="pc")=>BilibiliAPI.ajax({url:"pay/v1/Exchange/getStatus?platform="+i}),silver2coin:(i="pc")=>BilibiliAPI.ajaxWithCommonArgs({method:"POST",url:"pay/v1/Exchange/silver2coin",data:{platform:i}}),myWallet:(i=1,e=1,a="pc")=>BilibiliAPI.ajax({url:"pay/v2/Pay/myWallet",data:{need_bp:i,need_metal:e,platform:a}})},rankdb:{roomInfo:(i,e,a)=>BilibiliAPI.ajax({url:"rankdb/v1/Common/roomInfo",data:{ruid:i,roomid:e,areaId:a}}),getTopRealTimeHour:i=>BilibiliAPI.ajax({url:"rankdb/v1/Rank2018/getTop?type=master_realtime_hour&type_id=areaid_realtime_hour&area_id="+i})},relation:{getList:(i,e)=>BilibiliAPI.ajax({url:"relation/v1/feed/getList",data:{page:i,page_size:e},cache:!1}),heartBeat:()=>BilibiliAPI.ajax({url:"relation/v1/feed/heartBeat",cache:!1}),GetUserFc:i=>BilibiliAPI.ajax({url:"relation/v1/Feed/GetUserFc?follow="+i}),IsUserFollow:i=>BilibiliAPI.ajax({url:"relation/v1/Feed/IsUserFollow?follow="+i}),getFollowings:(i,e=1,a=20,t="desc",l="jsonp",r="")=>BilibiliAPI.ajax({url:"//api.bilibili.com/x/relation/followings",data:{vmid:i,pn:e,ps:a,order:t,jsonp:l,callback:r}}),getTags:()=>BilibiliAPI.ajax({url:"//api.bilibili.com/x/relation/tags",data:{jsonp:"jsonp",callback:""}}),getUpInTag:(i,e,a=1,t=20,l="jsonp",r="")=>BilibiliAPI.ajax({url:"//api.bilibili.com/x/relation/tag",data:{mid:i,tagid:e,pn:a,ps:t,jsonp:l,callback:r}}),createTag:(i,e="jsonp")=>BilibiliAPI.ajaxWithCommonArgs({method:"POST",url:"//api.bilibili.com/x/relation/tag/create",data:{tag:i,jsonp:e}}),getTagIDByName:i=>BilibiliAPI.ajax({url:"//api.bilibili.com/x/tag/info",data:{tag_name:i}}),delTag:(i,e="jsonp")=>BilibiliAPI.ajaxWithCommonArgs({method:"POST",url:"//api.bilibili.com/x/relation/tag/del",data:{tagid:i,jsonp:e}}),modify:(i,e,a=11)=>BilibiliAPI.ajaxWithCommonArgs({method:"POST",url:"//api.bilibili.com/x/relation/modify",data:{fid:i,act:e,re_src:a,jsonp:"jsonp",callback:""}}),addUsers:(i,e)=>BilibiliAPI.ajaxWithCommonArgs({method:"POST",url:"//api.bilibili.com/x/relation/tags/addUsers?cross_domain=true",data:{fids:i,tagids:e}}),moveUsers:(i,e,a,t="jsonp")=>BilibiliAPI.ajaxWithCommonArgs({method:"POST",url:"//api.bilibili.com/x/relation/tags/moveUsers",data:{beforeTagids:i,afterTagids:e,fids:a,jsonp:t}})},room:{get_info:(i,e="room")=>BilibiliAPI.ajax({url:"room/v1/Room/get_info",data:{room_id:i,from:e}}),get_recommend_by_room:(i,e,a)=>BilibiliAPI.ajax({url:"room/v1/room/get_recommend_by_room",data:{room_id:i,count:e,rnd:a||Math.floor(Date.now()/1e3)}}),playUrl:(i,e="0",a="web")=>BilibiliAPI.ajax({url:"room/v1/Room/playUrl",data:{cid:i,quality:e,platform:a}}),room_entry_action:(i,e="pc")=>BilibiliAPI.ajaxWithCommonArgs({method:"POST",url:"room/v1/Room/room_entry_action",data:{room_id:i,platform:e}}),room_init:i=>BilibiliAPI.ajax({url:"room/v1/Room/room_init?id="+i}),getConf:(i,e="pc",a="web")=>BilibiliAPI.ajax({url:"room/v1/Danmu/getConf",data:{room_id:i,platform:e,player:a}}),getList:()=>BilibiliAPI.ajax({url:"room/v1/Area/getList"}),getRoomList:(i=1,e=0,a=0,t=1,l=30,r="online",o="web",n=1)=>BilibiliAPI.ajax({url:"room/v3/area/getRoomList",data:{platform:o,parent_area_id:i,cate_id:e,area_id:a,sort_type:r,page:t,page_size:l,tag_version:n}}),update:(i,e)=>BilibiliAPI.ajaxWithCommonArgs({method:"POST",url:"room/v1/Room/update",data:{room_id:i,description:e}}),getRoomInfoOld:i=>BilibiliAPI.ajax({url:"room/v1/Room/getRoomInfoOld",data:{mid:i}}),getRoomBaseInfo:(i,e="link-center")=>BilibiliAPI.ajax({url:"xlive/web-room/v1/index/getRoomBaseInfo",data:{room_ids:i,req_biz:e}}),verify_room_pwd:(i,e="")=>BilibiliAPI.ajax({url:"room/v1/Room/verify_room_pwd",data:{room_id:i,pwd:e}})},sign:{doSign:()=>BilibiliAPI.ajax({url:"sign/doSign"}),GetSignInfo:()=>BilibiliAPI.ajax({url:"sign/GetSignInfo"}),getLastMonthSignDays:()=>BilibiliAPI.ajax({url:"sign/getLastMonthSignDays"})},user:{getWear:i=>BilibiliAPI.ajax({url:"user/v1/user_title/getWear?uid="+i}),isBiliVip:i=>BilibiliAPI.ajax({url:"user/v1/user/isBiliVip?uid="+i}),userOnlineHeart:()=>BilibiliAPI.ajaxWithCommonArgs({method:"POST",url:"User/userOnlineHeart",data:{}}),getUserInfo:i=>BilibiliAPI.ajax({url:"User/getUserInfo?ts="+i})},x:{getUserSpace:(i,e,a,t,l,r,o)=>BilibiliAPI.ajax({url:"//api.bilibili.com/x/space/arc/search",data:{mid:i,ps:e,tid:a,pn:t,keyword:l,order:r,jsonp:o}}),getAccInfo:(i,e="jsonp")=>BilibiliAPI.ajax({url:"//api.bilibili.com/x/space/acc/info",data:{mid:i,jsonp:e}}),getCoinInfo:(i,e,a,t)=>BilibiliAPI.ajax({url:"//api.bilibili.com/x/web-interface/archive/coins",data:{callback:i,jsonp:e,aid:a,_:t}}),getTodayExp:()=>BilibiliAPI.ajax({url:"//api.bilibili.com/x/web-interface/coin/today/exp"}),coin_add:(i,e=1,a=0)=>BilibiliAPI.ajaxWithCommonArgs({method:"POST",url:"//api.bilibili.com/x/web-interface/coin/add",data:{aid:i,multiply:e,select_like:a,cross_domain:!0}}),share_add:i=>BilibiliAPI.ajaxWithCommonArgs({method:"POST",url:"//api.bilibili.com/x/web-interface/share/add",data:{aid:i,jsonp:"jsonp"}}),heartbeat:(i,e,a,t,l=0,r=0,o=3,n=1,s=2)=>BilibiliAPI.ajaxWithCommonArgs({method:"POST",url:"//api.bilibili.com/x/report/web/heartbeat",data:{aid:i,cid:e,mid:a,start_ts:t||Date.now()/1e3,played_time:l,realtime:r,type:o,play_type:n,dt:s}}),now:()=>BilibiliAPI.ajax({url:"//api.bilibili.com/x/report/click/now",data:{jsonp:"jsonp"}})},xlive:{guard:{join:(i,e,a="guard")=>BilibiliAPI.ajaxWithCommonArgs({method:"POST",url:"xlive/lottery-interface/v3/guard/join",data:{roomid:i,id:e,type:a}})},lottery:{check:i=>BilibiliAPI.ajax({url:"xlive/lottery-interface/v1/lottery/Check",data:{roomid:i}})},smalltv:{check:i=>BilibiliAPI.ajax({url:"xlive/lottery-interface/v3/smalltv/Check",data:{roomid:i}}),join:(i,e,a="small_tv")=>BilibiliAPI.ajaxWithCommonArgs({method:"POST",url:"xlive/lottery-interface/v5/smalltv/join",data:{roomid:i,id:e,type:a}}),notice:(i,e="small_tv")=>BilibiliAPI.ajax({url:"xlive/lottery-interface/v3/smalltv/Notice",data:{type:e,raffleId:i}})},pk:{check:i=>BilibiliAPI.ajax({url:"xlive/lottery-interface/v1/pk/check",data:{roomid:i}}),join:(i,e)=>BilibiliAPI.ajaxWithCommonArgs({method:"POST",url:"xlive/lottery-interface/v1/pk/join",data:{roomid:i,id:e}})},dosign:()=>BilibiliAPI.ajax({url:"xlive/web-ucenter/v1/sign/DoSign"}),getDanmuInfo:(i,e=0)=>BilibiliAPI.ajax({url:"xlive/web-room/v1/index/getDanmuInfo",data:{id:i,type:e}}),getInfoByUser:i=>BilibiliAPI.ajax({url:"xlive/web-room/v1/index/getInfoByUser",data:{room_id:i}}),anchor:{check:i=>BilibiliAPI.ajax({url:"xlive/lottery-interface/v1/Anchor/Check?roomid="+i}),join:(i,e,a,t="pc")=>{var l={id:i,platform:t};return void 0!==e&&void 0!==a&&(l.gift_id=e,l.gift_num=a),BilibiliAPI.ajaxWithCommonArgs({method:"POST",url:"xlive/lottery-interface/v1/Anchor/Join",data:l})},randTime:i=>BilibiliAPI.ajax({url:"xlive/lottery-interface/v1/Anchor/RandTime?id="+i})}},YearWelfare:{checkFirstCharge:()=>BilibiliAPI.ajax({url:"YearWelfare/checkFirstCharge"}),inviteUserList:()=>BilibiliAPI.ajax({url:"YearWelfare/inviteUserList/1"})},DanmuWebSocket:class extends WebSocket{static stringToUint(i){const e=i.split(""),a=[];for(var t=0;t<e.length;++t)a.push(e[t].charCodeAt(0));return new Uint8Array(a)}static uintToString(i){return decodeURIComponent(escape(String.fromCharCode.apply(null,i)))}constructor(i,e,a,t){let l="wss://broadcastlv.chat.bilibili.com/sub";if(Array.isArray(a)&&a.length>0){let i=!1;do{const e=a.shift();e.wss_port?l=`wss://${e.host}:${e.wss_port}/sub`:i=!0}while(i&&a.length>0)}else"string"==typeof a&&a.length>0&&(l=a);super(l),this.binaryType="arraybuffer",this.handlers={reconnect:[],login:[],heartbeat:[],cmd:[],receive:[]},this.host_server_list=a,this.token=t,this.closed=!1,this.addEventListener("open",()=>{this.sendLoginPacket(i,e).sendHeartBeatPacket(),this.heartBeatHandler=setInterval(()=>{this.sendHeartBeatPacket()},3e4)}),this.addEventListener("close",()=>{this.heartBeatHandler&&clearInterval(this.heartBeatHandler),this.closed||setTimeout(()=>{const a=new BilibiliAPI.DanmuWebSocket(i,e,this.host_server_list,this.token);a.handlers=this.handlers,a.unzip=this.unzip;for(const i in this.handlers)this.handlers.hasOwnProperty(i)&&this.handlers[i].forEach(e=>{switch(i){case"reconnect":a.addEventListener("reconnect",i=>{e.call(a,i.detail.ws)});break;case"login":a.addEventListener("login",()=>{e.call(a)});break;case"heartbeat":a.addEventListener("heartbeat",i=>{e.call(a,i.detail.num)});break;case"cmd":a.addEventListener("cmd",i=>{e.call(a,i.detail.obj,i.detail.str)});break;case"receive":a.addEventListener("receive",i=>{e.call(a,i.detail.len,i.detail.headerLen,i.detail.protover,i.detail.operation,i.detail.sequence,i.detail.data)});break}});this.dispatchEvent(new CustomEvent("reconnect",{detail:{ws:a}}))},1e4)}),this.addEventListener("message",i=>{const e=new DataView(i.data);let a=0;for(let t=0;t<i.data.byteLength;t+=a){a=e.getUint32(t);const l=e.getUint16(t+4),r=e.getUint16(t+6),o=e.getUint32(t+8),n=e.getUint32(t+12);let s=i.data.slice(t+l,t+a);if(2===r&&this.unzip&&(s=this.unzip(s)),this.dispatchEvent(new CustomEvent("receive",{detail:{len:a,headerLen:l,protover:r,operation:o,sequence:n,data:s}})),2===r&&!this.unzip)continue;const d=new DataView(s);switch(o){case 3:{const i=d.getUint32(0);this.dispatchEvent(new CustomEvent("heartbeat",{detail:{num:i}}));break}case 5:{const i=BilibiliAPI.DanmuWebSocket.uintToString(new Uint8Array(s)),e=JSON.parse(i);this.dispatchEvent(new CustomEvent("cmd",{detail:{obj:e,str:i}}));break}case 8:this.dispatchEvent(new CustomEvent("login"));break}}})}close(i,e){this.closed=!0,super.close(i,e)}setUnzip(i){this.unzip=i}bind(i,e,a,t,l){"function"==typeof i&&(this.addEventListener("reconnect",e=>{i.call(this,e.detail.ws)}),this.handlers.reconnect.push(i)),"function"==typeof e&&(this.addEventListener("login",()=>{e.call(this)}),this.handlers.login.push(e)),"function"==typeof a&&(this.addEventListener("heartbeat",i=>{a.call(this,i.detail.num)}),this.handlers.heartbeat.push(a)),"function"==typeof t&&(this.addEventListener("cmd",i=>{t.call(this,i.detail.obj,i.detail.str)}),this.handlers.cmd.push(t)),"function"==typeof l&&(this.addEventListener("receive",i=>{l.call(this,i.detail.len,i.detail.headerLen,i.detail.protover,i.detail.operation,i.detail.sequence,i.detail.data)}),this.handlers.receive.push(l))}sendData(i,e,a,t){if(this.readyState!==WebSocket.OPEN)throw new Error("DanmuWebSocket未连接");switch(Object.prototype.toString.call(i)){case"[object Object]":return this.sendData(JSON.stringify(i),e,a,t);case"[object String]":{let l=BilibiliAPI.DanmuWebSocket.stringToUint(i),r=new ArrayBuffer(BilibiliAPI.DanmuWebSocket.headerLength+l.byteLength),o=new DataView(r);o.setUint32(0,BilibiliAPI.DanmuWebSocket.headerLength+l.byteLength),o.setUint16(4,BilibiliAPI.DanmuWebSocket.headerLength),o.setUint16(6,parseInt(e,10)),o.setUint32(8,parseInt(a,10)),o.setUint32(12,parseInt(t,10));for(let i=0;i<l.byteLength;++i)o.setUint8(BilibiliAPI.DanmuWebSocket.headerLength+i,l[i]);this.send(r)}return this;default:this.send(i)}return this}sendLoginPacket(i,e){const a={uid:parseInt(i,10),roomid:parseInt(e,10),protover:2,platform:"web",clientver:"1.8.5",type:2,key:this.token};return this.sendData(a,1,7,1)}sendHeartBeatPacket(){return this.sendData("[object Object]",1,2,1)}},sendLiveDanmu:(i,e,a="16777215",t="25",l="1",r="0")=>BilibiliAPI.ajaxWithCommonArgs({method:"POST",url:"msg/send",data:{color:a,fontsize:t,mode:l,msg:i,rnd:BilibiliAPI_ts_ms(),roomid:e,bubble:r}}),sendMsg:(i,e=0,a="web")=>BilibiliAPI.ajaxWithCommonArgs({method:"POST",url:"//api.vc.bilibili.com/web_im/v1/web_im/send_msg ",data:{"msg[sender_uid]":i.sender_uid,"msg[receiver_id]":i.receiver_id,"msg[receiver_type]":i.receiver_type||1,"msg[msg_type]":i.msg_type||1,"msg[msg_status]":i.msg_status||0,"msg[content]":i.content,"msg[timestamp]":BilibiliAPI_ts_s(),"msg[dev_id]":i.dev_id,build:e,mobi_app:a}}),getCookie:i=>{let e,a=document.cookie.split(";");for(var t=0;t<a.length;t++)if(e=a[t].split("="),e[0].replace(" ","")==i)return decodeURIComponent(e[1])},KeySign:{sort:i=>{let e=Object.keys(i).sort(),a=[];for(let t of e)a.push(`${t}=${i[t]}`);return a.join("&")}}};BilibiliAPI.DanmuWebSocket.headerLength=16;