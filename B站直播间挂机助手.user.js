// ==UserScript==
// @name           B站直播间挂机助手
// @name:en        B站直播间挂机助手
// @namespace      https://github.com/andywang425
// @author         andywang425
// @description    自动获取小心心，参加天选时刻抽奖，直播区签到，应援团签到，银瓜子换硬币，完成主站每日任务(登录,观看视频,投币,分享视频)，批量送礼，发送粉丝勋章打卡弹幕，参与实物抽奖，参与Bilibili直播区礼物抽奖，参加被广播的节奏风暴，定时发弹幕，快捷购买粉丝勋章
// @description:en 自动获取小心心，参加天选时刻抽奖，直播区签到，应援团签到，银瓜子换硬币，完成主站每日任务(登录,观看视频,投币,分享视频)，批量送礼，发送粉丝勋章打卡弹幕，参与实物抽奖，参与Bilibili直播区礼物抽奖，参加被广播的节奏风暴，定时发弹幕，快捷购买粉丝勋章
// @updateURL      https://raw.githubusercontent.com/andywang425/BLTH/master/B%E7%AB%99%E7%9B%B4%E6%92%AD%E9%97%B4%E6%8C%82%E6%9C%BA%E5%8A%A9%E6%89%8B.user.js
// @downloadURL    https://raw.githubusercontent.com/andywang425/BLTH/master/B%E7%AB%99%E7%9B%B4%E6%92%AD%E9%97%B4%E6%8C%82%E6%9C%BA%E5%8A%A9%E6%89%8B.user.js
// @homepageURL    https://github.com/andywang425/BLTH
// @supportURL     https://github.com/andywang425/BLTH/issues
// @icon           https://cdn.jsdelivr.net/gh/andywang425/BLTH@7d7ca494edd314806460e24c6b59be8ae1bd7dc6/img/script-icon.png
// @copyright      2020, andywang425 (https://github.com/andywang425)
// @license        MIT
// @compatible     chrome 80 or later
// @compatible     firefox 77 or later
// @compatible     opera 69 or later
// @version        5.6.5
// @include        /https?:\/\/live\.bilibili\.com\/[blanc\/]?[^?]*?\d+\??.*/
// @run-at         document-end
// @connect        passport.bilibili.com
// @connect        api.live.bilibili.com
// @connect        live-trace.bilibili.com
// @connect        sc.ftqq.com
// @require        https://cdn.jsdelivr.net/gh/andywang425/BLTH@adad0a90c758fd1cb441784f01e7ea4aa8bed123/modules/Ajax-hook.min.js
// @require        https://cdn.bootcss.com/jquery/3.2.1/jquery.min.js
// @require        https://cdn.jsdelivr.net/gh/andywang425/BLTH@10156de79624566f6c5adeb85019b0a77b307186/modules/BilibiliAPI_Mod.min.js
// @require        https://cdn.jsdelivr.net/gh/andywang425/BLTH@4716930900e64769f19dd7aa00b0824a4961cdd0/modules/layer.js
// @require        https://cdn.jsdelivr.net/gh/andywang425/BLTH@adad0a90c758fd1cb441784f01e7ea4aa8bed123/modules/libBilibiliToken.min.js
// @require        https://cdn.jsdelivr.net/gh/andywang425/BLTH@adad0a90c758fd1cb441784f01e7ea4aa8bed123/modules/libWasmHash.min.js
// @require        https://cdn.jsdelivr.net/gh/andywang425/BLTH@97bf818a906154a418f72ecbb644de9cf19c80b1/modules/base64.min.js
// @resource       layerCss https://cdn.jsdelivr.net/gh/andywang425/BLTH@e5661a11516ac85ad185e267dca600fc142a0bcd/css/layer.css
// @resource       myCss    https://cdn.jsdelivr.net/gh/andywang425/BLTH@fac387eee85da806fd96bb26abaf0c38f1f51fbf/css/myCss-min.css
// @resource       main     https://cdn.jsdelivr.net/gh/andywang425/BLTH@ab7b6a1246dfb87ca1a564b03bd3a24d2d1bec4f/html/main-min.html
// @resource       eula     https://cdn.jsdelivr.net/gh/andywang425/BLTH@512a0bd5d39ffcbe79186aac9977d5073974b4ea/html/eula-min.html
// @grant          unsafeWindow
// @grant          GM_xmlhttpRequest
// @grant          GM_getResourceText
// @grant          GM_notification
// ==/UserScript==
(function(){const NAME="IGIFTMSG",W="undefined"==typeof unsafeWindow?window:unsafeWindow,eventListener=window.addEventListener,ts_ms=()=>Date.now(),ts_s=()=>Math.round(ts_ms()/1e3),anchorFollowTagName="BLTH天选关注UP",anchorPrizeTagName="BLTH天选中奖UP",delayCall=(e,t=12e4)=>{const o=$.Deferred();return setTimeout(()=>{const t=e();t&&t.then?t.then((e,t,i,r,a,n)=>o.resolve(e,t,i,r,a,n)):o.resolve()},t),o},MYDEBUG=(e,...t)=>{if(!debugSwitch)return;let o=new Date;o=`%c[${NAME}]%c[${o.getHours()}:${o.getMinutes()}:${o.getSeconds()}:${o.getMilliseconds()}]%c`,1!==t.length?console.log(o,"font-weight: bold;","color: #0920e6;","",e+":",t):console.log(o,"font-weight: bold;","color: #0920e6;","",e+":",t[0])},MYERROR=(e,...t)=>{let o=new Date;o=`[${NAME}][${o.getHours()}:${o.getMinutes()}:${o.getSeconds()}:${o.getMilliseconds()}]`,1!==t.length?console.error(o,e+":",t):console.error(o,e+":",t[0])},runMidnight=(e,t)=>{const o=new Date;let i=t||" ";o.setDate(o.getDate()+1),o.setHours(0,1,0,0),setTimeout(e,o-ts_ms()),MYDEBUG("runMidnight",i+" "+o.toString())},runExactMidnight=(e,t)=>{const o=new Date;let i=t||" ";o.setDate(o.getDate()+1),o.setHours(0,0,0,0),setTimeout(e,o-ts_ms()),MYDEBUG("runExactMidnight",i+" "+o.toString())},runTomorrow=(e,t,o,i)=>{const r=new Date;let a=i||" ";r.setDate(r.getDate()+1),r.setHours(t,o,0,0),setTimeout(e,r-ts_ms()),MYDEBUG("runTomorrow",a+" "+r.toString())},appToken=new BilibiliToken,baseQuery=`actionKey=appkey&appkey=${BilibiliToken.appKey}&build=5561000&channel=bili&device=android&mobi_app=android&platform=android&statistics=%7B%22appId%22%3A1%2C%22platform%22%3A3%2C%22version%22%3A%225.57.0%22%2C%22abtest%22%3A%22%22%7D`,setToken=async()=>(tokenData.time>ts_s()||(tokenData=await appToken.getToken(),tokenData.time=ts_s()+tokenData.expires_in,localStorage.setItem(NAME+"_Token",JSON.stringify(tokenData))),userToken=tokenData,MYDEBUG(NAME+"_Token",tokenData),"OK"),newWindow={init:()=>newWindow.Toast.init(),Toast:{init:()=>{try{const e=[];return window.toast=(t,o="info",i=5e3)=>{switch(o){case"success":case"info":case"caution":case"error":break;default:o="info"}const r=$(`<div class="link-toast ${o} fixed" style="z-index:2001"><span class="toast-text">${t}</span></div>`)[0];document.body.appendChild(r),MYDEBUG("toast-"+o,t),r.style.top=document.body.scrollTop+40*e.length+10+"px",r.style.left=document.body.offsetWidth+document.body.scrollLeft-r.offsetWidth-5+"px",windowToast||$(".link-toast").hide(),e.push(r),setTimeout(()=>{r.className+=" out",setTimeout(()=>{e.shift(),e.forEach(e=>{e.style.top=parseInt(e.style.top,10)-40+"px"}),$(r).remove()},200)},i)},$.Deferred().resolve()}catch(e){return MYERROR("初始化浮动提示时出现异常",e),$.Deferred().reject()}}}},addStyle=()=>{const e=GM_getResourceText("layerCss")+GM_getResourceText("myCss"),t=document.createElement("style");return t.innerHTML=e,document.getElementsByTagName("head")[0].appendChild(t)},getScrollPosition=(e=window)=>({x:void 0!==e.pageXOffset?e.pageXOffset:e.scrollLeft,y:void 0!==e.pageYOffset?e.pageYOffset:e.scrollTop}),linkMsg=(e,t)=>'<a href="'+t+'"target="_blank" style="color:">'+e+"</a>",liveRoomUrl="https://live.bilibili.com/",storageLastFixVersion=localStorage.getItem(NAME+"_lastFixVersion")||"0";let mainDisplay=localStorage.getItem(NAME+"_msgHide")||"hide",layerTimes=0,winPrizeNum=0,winPrizeTotalCount=0,SEND_GIFT_NOW=!1,SEND_DANMU_NOW=!1,LIGHT_MEDAL_NOW=!1,hideBtnClickable=!0,getFollowBtnClickable=!0,unFollowBtnClickable=!0,mainSiteTasksBtnClickable=!0,danmuTaskRunning=!1,medalDanmuRunning=!1,debugSwitch="true"===localStorage.getItem(NAME+"_debugSwitch"),windowToast="false"!==localStorage.getItem(NAME+"_windowToast"),Live_info={room_id:void 0,uid:void 0,ruid:void 0,gift_list:void 0,rnd:void 0,visit_id:void 0,bili_jct:void 0,tid:void 0,uname:void 0,user_level:void 0,level:void 0},userToken=void 0,tokenData=JSON.parse(localStorage.getItem(NAME+"_Token"))||{time:0},mainIndex=void 0,logIndex=void 0,layerUiMain=void 0,layerLogWindow=void 0,logDiv=void 0,tabContent=void 0,JQlogRedPoint=void 0,JQmenuWindow=void 0,layerLogWindow_Height=void 0,layerLogWindow_ScrollHeight=void 0,layerLogWindow_ScrollTop=void 0,layerLogWindow_ScrollY=void 0,awardScrollCount=0,nosleepConfig="true"===localStorage.getItem(NAME+"_NOSLEEP"),INVISIBLE_ENTER_config="true"===localStorage.getItem(NAME+"_INVISIBLE_ENTER"),readConfigArray=[void 0];function init(){const MY_API={CONFIG_DEFAULT:{AUTO_DANMU:!1,AUTO_GIFT:!1,AUTO_GIFT_ROOMID:["0"],AUTO_GROUP_SIGN:!0,ANCHOR_LOTTERY:!1,ANCHOR_AUTO_DEL_FOLLOW:!1,ANCHOR_MAXROOM:600,ANCHOR_MAXLIVEROOM_SAVE:100,ANCHOR_CHECK_INTERVAL:5,ANCHOR_IGNORE_BLACKLIST:!0,ANCHOR_IGNORE_PWDROOM:!0,ANCHOR_BLACKLIST_WORD:["测试","钓鱼","炸鱼","大航海","上船","舰长","返现","抵用","代金","黑屋","上车","上反船","照片","素颜","自拍","cos","写真","皂片","开舰","上舰","自画像","封面照","封面","取关","美照","随机照","随机照片","好友"],ANCHOR_INTERVAL:250,AHCHOR_NEED_GOLD:0,ANCHOR_WAIT_REPLY:!0,ANCHOR_UPLOAD_DATA:!1,ANCHOR_UPLOAD_DATA_INTERVAL:10,ANCHOR_UPLOAD_MSG:!1,ANCHOR_UPLOAD_MSG_CONTENT:"",ANCHOR_IGNORE_UPLOAD_MSG:!0,ANCHOR_TYPE:"ANCHOR_POLLING",ANCHOR_TYPE_POLLING:!0,ANCHOR_TYPE_LIVEROOM:!1,ANCHOR_TYPE_FOLLOWING:!1,ANCHOR_GETDATA_ROOM:22474988,ANCHOR_IGNORE_ROOM:!0,ANCHOR_IGNORE_ROOMLIST:["22647871"],ANCHOR_PRIVATE_LETTER:!1,ANCHOR_LETTER_CONTENT:"UP我中天选了，请问怎么领奖[doge]",ANCHOR_ADD_TO_WHITELIST:!1,ANCHOR_MOVETO_FOLLOW_TAG:!0,ANCHOR_MOVETO_PRIZE_TAG:!0,ANCHOR_DANMU:!1,ANCHOR_DANMU_CONTENT:["我中啦！","芜湖"],ANCHOR_IGNORE_MONEY:0,ANCHOR_MONEY_ONLY:!1,CHECK_HOUR_ROOM:!1,CHECK_HOUR_ROOM_INTERVAL:600,COIN:!1,COIN_NUMBER:0,COIN_TYPE:"COIN_DYN",COIN_UID:["0"],DANMU_CONTENT:["这是一条弹幕"],DANMU_ROOMID:["22474988"],DANMU_INTERVAL_TIME:["10m"],EXCLUDE_ROOMID:["0"],FT_NOTICE:!1,FT_SCKEY:"SCKEY",GIFT_LIMIT:1,GIFT_SEND_HOUR:23,GIFT_SEND_MINUTE:59,GIFT_INTERVAL:5,GIFT_METHOD:"GIFT_SEND_TIME",GIFT_SORT:"GIFT_SORT_HIGH",GIFT_ALLOW_TYPE:["1","6","30607"],GM_NOTICE:!1,IN_TIME_RELOAD_DISABLE:!1,LOTTERY:!1,LIVE_SIGN:!0,LOGIN:!0,LITTLE_HEART:!0,LIGHT_MEDALS:["0"],LIGHT_METHOD:"LIGHT_WHITE",MEDAL_DANMU_ROOM:["0"],MEDAL_DANMU_METHOD:"MEDAL_DANMU_BLACK",MEDAL_DANMU_INTERVAL:2,MATERIAL_LOTTERY:!0,MATERIAL_LOTTERY_CHECK_INTERVAL:60,MATERIAL_LOTTERY_IGNORE_QUESTIONABLE_LOTTERY:!0,MEDAL_DANMU:!1,MATERIAL_LOTTERY_REM:10,MEDAL_DANMU_CONTENT:["(⌒▽⌒)","（￣▽￣）","(=・ω・=)","(｀・ω・´)","(〜￣△￣)〜","(･∀･)","(°∀°)ﾉ","(￣3￣)","╮(￣▽￣)╭","_(:3」∠)_","(^・ω・^ )","(●￣(ｴ)￣●)","ε=ε=(ノ≧∇≦)ノ","⁄(⁄ ⁄•⁄ω⁄•⁄ ⁄)⁄","←◡←"],QUESTIONABLE_LOTTERY:["test","encrypt","测试","钓鱼","加密","炸鱼"],RANDOM_DELAY:!0,RANDOM_SEND_DANMU:0,RANDOM_SKIP:0,REMOVE_ELEMENT_2233:!1,REMOVE_ELEMENT_activity:!0,REMOVE_ELEMENT_rank:!0,REMOVE_ELEMENT_followSideBar:!1,REMOVE_ELEMENT_flipView:!0,RND_DELAY_END:5,RND_DELAY_START:2,SEND_ALL_GIFT:!1,SHARE:!0,SILVER2COIN:!1,COIN2SILVER:!1,COIN2SILVER_NUM:1,SPARE_GIFT_ROOM:"0",STORM:!1,STORM_MAX_COUNT:100,STORM_ONE_LIMIT:200,STORM_QUEUE_SIZE:3,TIME_AREA_DISABLE:!0,TIME_AREA_END_H0UR:8,TIME_AREA_END_MINUTE:0,TIME_AREA_START_H0UR:2,TIME_AREA_START_MINUTE:0,TIME_RELOAD:!1,TIME_RELOAD_MINUTE:120,UPDATE_TIP:!0,WATCH:!0},CACHE_DEFAULT:{AUTO_SEND_DANMU_TS:[],AUTO_GROUP_SIGH_TS:0,DailyReward_TS:0,LiveReward_TS:0,Silver2Coin_TS:0,Coin2Sliver_TS:0,Gift_TS:0,GiftInterval_TS:0,LittleHeart_TS:0,MaterialObject_TS:0,AnchorLottery_TS:0,last_aid:665,MedalDanmu_TS:0},CONFIG:{},CACHE:{},GIFT_COUNT:{COUNT:0,ANCHOR_COUNT:0,MATERIAL_COUNT:0,CLEAR_TS:0},init:async()=>{addStyle();const e=$(".tab-list.dp-flex"),t=$(".chat-history-panel").width(),o=$("#aside-area-vm").height(),i=$("#chat-control-panel-vm").height();tabContent=$(".tab-content"),logDiv=$('<li data-v-2fdbecb2="" data-v-d2be050a="" class="item dp-i-block live-skin-separate-border border-box t-center pointer live-skin-normal-text" style = \'font-weight:bold;color: #999;\' id = "logDiv"><span id="logDivText">日志</span><div class="igiftMsg_num" style="display: none;" id = \'logRedPoint\'>0</div></li>');let r=0,a=0,n=0;([".chat-history-list",".attention-btn-ctnr",".live-player-mounter"].some(e=>0===e.length)||0===e.length||0===tabContent.length)&&window.toast("必要页面元素缺失，强制运行（可能会看不到控制面板，提示信息）","error"),e.append(logDiv),JQlogRedPoint=$("#logRedPoint");let l=[];for(let t=0;t<e.children("li").length;t++)l.push(e.children("li")[t]);logIndex=layer.open({type:1,title:!1,offset:[String(a)+"px",String(n)+"px"],closeBtn:0,shade:0,zIndex:2e3,fixed:!1,area:[String(t)+"px",String(o-i)+"px"],anim:-1,isOutAnim:!1,resize:!1,content:'<div id = "menuWindow"></div>',success:()=>{layerLogWindow=$("#layui-layer1 .layui-layer-content"),JQmenuWindow=$("#menuWindow");let e=$("#logDivText");layerLogWindow.on("DOMNodeInserted",(function(){layerLogWindow_Height=$(this).height(),layerLogWindow_ScrollHeight=$(this)[0].scrollHeight,layerLogWindow_ScrollHeight>layerLogWindow_Height&&(layerLogWindow.scrollTop(layerLogWindow.prop("scrollHeight")),$(this).off("DOMNodeInserted"))})),layerLogWindow.scroll((function(){layerLogWindow_Height=$(this).height(),layerLogWindow_ScrollHeight=$(this)[0].scrollHeight,layerLogWindow_ScrollTop=$(this)[0].scrollTop,layerLogWindow_ScrollY=layerLogWindow_ScrollTop+layerLogWindow_Height+1,layerLogWindow_ScrollY<layerLogWindow_ScrollHeight&&0===winPrizeNum?e.text("日志🚀"):e.text("日志")}))}}),layer.style(logIndex,{"box-shadow":"none",display:"none","background-color":"#f2f3f5"});for(const e of l){let t=$(e);t.click(()=>{for(const o of l){let i=$(o);o!=e?("rgb(153, 153, 153)"!==i.css("color")&&i.css("color","#999"),i.hasClass("live-skin-main-text")&&i.removeClass("live-skin-main-text"),i.hasClass("active")&&i.removeClass("active"),i.hasClass("live-skin-normal-text")||i.addClass("live-skin-normal-text")):("rgb(51, 51, 51)"!==i.css("color")&&t.css("color","#333"),i.hasClass("live-skin-main-text")||t.addClass("live-skin-main-text"),i.hasClass("active")||t.addClass("active"),i.hasClass("live-skin-normal-text")&&t.removeClass("live-skin-normal-text"))}"logDiv"===t.attr("id")?(r||(r=$(".tab-content").offset(),a=r.top,n=r.left,layer.style(logIndex,{top:String(a)+"px",left:String(n)+"px"})),layer.style(logIndex,{display:"block"}),0===winPrizeNum?(JQlogRedPoint.hide(),(layerLogWindow_ScrollY<layerLogWindow_ScrollHeight||void 0===layerLogWindow_ScrollY)&&layerLogWindow.scrollTop(layerLogWindow.prop("scrollHeight"))):winPrizeNum>0&&awardScrollCount<winPrizeTotalCount&&$(".chatLogWinPrize").length>0&&($(".chatLogWinPrize")[awardScrollCount++].scrollIntoView(!1),$(window).scrollTop(0),JQlogRedPoint.text(--winPrizeNum),0===winPrizeNum&&JQlogRedPoint.hide())):layer.style(logIndex,{display:"none"})})}let s=$.Deferred(),_=$.Deferred(),d=$.Deferred();try{BAPI.setCommonArgs(Live_info.bili_jct),s.resolve()}catch(e){MYERROR("设置token错误",e),s.reject()}try{MY_API.loadConfig().then(()=>{MY_API.chatLog("脚本载入配置成功","success"),_.resolve()})}catch(e){MYERROR("API初始化出错",e),MY_API.chatLog("API初始化出错","error"),_.reject()}try{MY_API.loadCache().then(()=>{window.toast("CACHE载入成功","success"),d.resolve()})}catch(e){MYERROR("CACHE初始化出错",e),window.toast("CACHE初始化出错","error"),d.reject()}return $.when(s,_,d)},loadConfig:()=>{let e=$.Deferred();try{const t=JSON.parse(localStorage.getItem(NAME+"_CONFIG"));$.extend(!0,MY_API.CONFIG,MY_API.CONFIG_DEFAULT);for(const e in MY_API.CONFIG)void 0!==t[e]&&null!==t[e]&&(MY_API.CONFIG[e]=t[e]);MY_API.loadGiftCount(),e.resolve()}catch(t){MYDEBUG("API载入配置失败，加载默认配置",t),MY_API.setDefaults(),e.reject()}return e},loadCache:()=>{let e=$.Deferred();try{const t=JSON.parse(localStorage.getItem(NAME+"_CACHE"));$.extend(!0,MY_API.CACHE,MY_API.CACHE_DEFAULT);for(const e in MY_API.CACHE)void 0!==t[e]&&null!==t[e]&&(MY_API.CACHE[e]=t[e]);e.resolve()}catch(t){MYDEBUG("CACHE载入配置失败，加载默认配置",t),MY_API.setDefaults(),e.reject()}return e},newMessage:e=>{try{const t=localStorage.getItem(NAME+"_NEWMSG_CACHE");if(null==t||!versionStringCompare(t,e)){const t=["取关BLTH关注分组内up时不再取关白名单内up。","修复控制面板隐藏后依然碰不到音量按钮的bug。","部分重构（主要是天选时刻部分）。","修复在带有iframe的直播间运行脚本时重复运行检测出错的bug。","如果开启控制台日志，右上角提示信息内容会输出在控制台中。","<strong>天选时刻抽奖支持多种数据获取方式并存，并新增一种方式【从已关注且正在直播的直播间获取天选时刻数据 】。</strong>"];let o="";for(const e of t)o=o+"<mli>"+e+"</mli>";layer.open({title:e+"更新提示",area:[String(.382*$(window).width())+"px",String(.618*$(window).height())+"px"],content:`<mol>${o}</mol>\n                            <hr><em style="color:grey;">\n                            如果使用过程中遇到问题，欢迎去${linkMsg("github","https://github.com/andywang425/BLTH/issues")}\n                            反馈。也可以进q群讨论：${linkMsg("1106094437（已满）","https://jq.qq.com/?_wv=1027&amp;k=fCSfWf1O")}，${linkMsg("907502444","https://jq.qq.com/?_wv=1027&k=Bf951teI")}\n                            </em>`,success:()=>{layerTimes++}}),localStorage.setItem(NAME+"_NEWMSG_CACHE",e)}}catch(e){MYDEBUG("提示信息CACHE载入失败",e)}},saveConfig:(e=!0)=>{try{return localStorage.setItem(NAME+"_CONFIG",JSON.stringify(MY_API.CONFIG)),e&&window.toast("配置已保存，部分设置需刷新后才能生效","info"),MYDEBUG("MY_API.CONFIG",MY_API.CONFIG),!0}catch(e){return MYDEBUG("API保存出错",e),!1}},saveCache:(e=!0)=>{try{return localStorage.setItem(NAME+"_CACHE",JSON.stringify(MY_API.CACHE)),e&&MYDEBUG("CACHE已保存",MY_API.CACHE),!0}catch(e){return MYDEBUG("CACHE保存出错",e),!1}},setDefaults:()=>{MY_API.CONFIG=MY_API.CONFIG_DEFAULT,MY_API.CACHE=MY_API.CACHE_DEFAULT,MY_API.saveConfig(),MY_API.saveCache(),MY_API.chatLog("配置和CACHE已重置为默认。3秒后刷新页面"),setTimeout(()=>{window.location.reload()},3e3)},ReDoAllTasks:()=>{window.toast("3秒后再次执行所有任务","info");runAllTasks(3e3,200,[function(){MY_API.CACHE=MY_API.CACHE_DEFAULT},MY_API.GroupSign.run,MY_API.DailyReward.run,MY_API.LiveReward.run,MY_API.Exchange.runS2C,MY_API.Exchange.runC2S,MY_API.Gift.run,MY_API.LITTLE_HEART.run,MY_API.AUTO_DANMU.run,MY_API.MaterialObject.run,MY_API.AnchorLottery.run,MY_API.MEDAL_DANMU.run])},loadGiftCount:()=>{try{const e=JSON.parse(localStorage.getItem(NAME+"_GIFT_COUNT"));for(const t in MY_API.GIFT_COUNT)MY_API.GIFT_COUNT.hasOwnProperty(t)&&void 0!==e[t]&&null!==e[t]&&(MY_API.GIFT_COUNT[t]=e[t]);MYDEBUG("MY_API.GIFT_COUNT",MY_API.GIFT_COUNT)}catch(e){MYDEBUG("读取统计失败",e)}},saveGiftCount:(e=!0)=>{try{return localStorage.setItem(NAME+"_GIFT_COUNT",JSON.stringify(MY_API.GIFT_COUNT)),e&&MYDEBUG("统计保存成功",MY_API.GIFT_COUNT),!0}catch(e){return MYDEBUG("统计保存出错",e),!1}},addAnchor:(e=1)=>{MY_API.GIFT_COUNT.ANCHOR_COUNT+=e,$("#giftCount .anchor .statNum").text(MY_API.GIFT_COUNT.ANCHOR_COUNT),MY_API.saveGiftCount(!1)},addMaterial:(e=1)=>{MY_API.GIFT_COUNT.MATERIAL_COUNT+=e,$("#giftCount .material .statNum").text(MY_API.GIFT_COUNT.MATERIAL_COUNT),MY_API.saveGiftCount(!1)},removeUnnecessary:()=>{const e=[{settingName:"REMOVE_ELEMENT_2233",rmJQpath:["#my-dear-haruna-vm"]},{settingName:"REMOVE_ELEMENT_activity",rmJQpath:[".activity-entry"]},{settingName:"REMOVE_ELEMENT_rank",rmJQpath:[".activity-rank"]},{settingName:"REMOVE_ELEMENT_followSideBar",rmJQpath:['div[data-upgrade-intro="Follow"]',".side-bar-popup-cntr.ts-dot-4"]},{settingName:"REMOVE_ELEMENT_flipView",rmJQpath:[".flip-view"]}],t=e=>{if(MY_API.CONFIG[e.settingName])for(const t of e.rmJQpath){let e=setInterval(()=>{const o=$(t);o.length>0&&(o.remove(),clearInterval(e))},200)}};for(const o of e)t(o)},buyFanMedal:e=>BAPI.live_user.get_anchor_in_room(e).then((function(t){if(MYDEBUG("API.live_user.get_anchor_in_room response",t),0===t.code&&t.data.info){const o=String(t.data.info.uid),i=t.data.info.uname;layer.confirm(`<div style = "text-align:center">是否消耗20硬币购买UP主<br>${linkMsg(i,"https://space.bilibili.com/"+o)}<br>的粉丝勋章？</div>`,{title:"购买勋章 房间号："+e,btn:["是","否"]},(function(){BAPI.link_group.buy_medal(t.data.info.uid).then(e=>{MYDEBUG("API.link_group.buy_medal re",e),0===e.code?layer.msg("购买成功",{time:2e3,icon:1}):layer.msg("购买失败 "+e.message,{time:2500,icon:2})},()=>{MY_API.chatLog("购买粉丝勋章出错，请检查网络","error")})}),(function(){layer.msg("已取消购买",{time:2e3})}))}else 0===t.code&&void 0===t.data.info?layer.msg("房间不存在",{time:2500}):layer.msg("检查房间出错 "+t.message,{time:2500})})),creatSetBox:async()=>{const e=$(`<button class="igiftMsg_btn" style="display: inline-block; float: left; margin-right: 7px;cursor: pointer;box-shadow: 1px 1px 2px #00000075;" id="hiderbtn">${"hide"==mainDisplay?"显示控制面板":"隐藏控制面板"}<br></button>`),t=$(".bilibili-live-player.relative"),o=GM_getResourceText("main");const i=e=>{let t=void 0,o=void 0,i=parseInt(e.find('div[data-toggle="TIME_AREA_DISABLE"] .startHour').val()),r=parseInt(e.find('div[data-toggle="TIME_AREA_DISABLE"] .endHour').val()),a=parseInt(e.find('div[data-toggle="TIME_AREA_DISABLE"] .startMinute').val()),n=parseInt(e.find('div[data-toggle="TIME_AREA_DISABLE"] .endMinute').val());if(i>=24||r>=24||a>=60||n>=60||i<0||r<0||a<0||n<0)return window.toast("[定时休眠]时间错误","caution");if(MY_API.CONFIG.TIME_AREA_START_H0UR=i,MY_API.CONFIG.TIME_AREA_END_H0UR=r,MY_API.CONFIG.TIME_AREA_START_MINUTE=a,MY_API.CONFIG.TIME_AREA_END_MINUTE=n,t=parseFloat(e.find('div[data-toggle="RANDOM_SKIP"] .per').val()),t<0||t>100)return window.toast("[随机跳过礼物]数据小于0或大于100","caution");if(MY_API.CONFIG.RANDOM_SKIP=t,t=parseFloat(e.find('div[data-toggle="RANDOM_SEND_DANMU"] .per').val()),t>5)return window.toast("[活跃弹幕]为维护直播间弹幕氛围,弹幕发送概率不得大于5%","caution");if(t<0)return Y_API.chatLog("[活跃弹幕]数据小于0","caution");if(MY_API.CONFIG.RANDOM_SEND_DANMU=t,t=parseInt(e.find('div[data-toggle="TIME_RELOAD"] .delay-seconds').val()),t<=0||t>1e4)return window.toast("[直播间重载时间]数据小于等于0或大于10000","caution");if(MY_API.CONFIG.TIME_RELOAD_MINUTE=t,t=parseFloat(e.find('div[data-toggle="RANDOM_DELAY"] .RND_DELAY_START').val()),r=parseFloat(e.find('div[data-toggle="RANDOM_DELAY"] .RND_DELAY_END').val()),t<0||r>100)return window.toast("[抽奖延时]数据小于0或大于100","caution");if(r<=t)return window.toast("[抽奖延时]数据大小关系不正确","caution");if(MY_API.CONFIG.RND_DELAY_START=t,MY_API.CONFIG.RND_DELAY_END=r,t=parseInt(e.find('div[data-toggle="COIN"] .coin_number').val()),t<0||t>5)return window.toast("[自动投币]数据小于0或大于5","caution");if(MY_API.CONFIG.COIN_NUMBER=t,t=parseInt(e.find('div[data-toggle="CHECK_HOUR_ROOM"] .num').val()),t<=0)return window.toast("[检查小时榜间隔]数据小于等于0","caution");MY_API.CONFIG.CHECK_HOUR_ROOM_INTERVAL=t,t=e.find('div[data-toggle="AUTO_GIFT_ROOMID"] .num').val(),o=t.split(",");for(let e=0;e<o.length;e++)""===o[e]&&(o[e]=22474988);MY_API.CONFIG.AUTO_GIFT_ROOMID=o,t=e.find('div[data-toggle="EXCLUDE_ROOMID"] .num').val(),o=t.split(",");for(let e=0;e<o.length;e++)""===o[e]&&(o[e]=0);if(MY_API.CONFIG.EXCLUDE_ROOMID=o,t=parseInt(e.find('div[data-toggle="GIFT_LIMIT"] .num').val()),MY_API.CONFIG.GIFT_LIMIT=t,t=parseInt(e.find('div[data-toggle="GIFT_INTERVAL"] .num').val()),MY_API.CONFIG.GIFT_INTERVAL=t,i=parseInt(e.find('div[data-toggle="GIFT_SEND_TIME"] .Hour').val()),r=parseInt(e.find('div[data-toggle="GIFT_SEND_TIME"] .Minute').val()),i<0||r<0||i>=24||r>=60)return window.toast("[送礼时间]时间错误","caution");MY_API.CONFIG.GIFT_SEND_HOUR=i,MY_API.CONFIG.GIFT_SEND_MINUTE=r,t=e.find('div[data-toggle="LIGHT_MEDALS"] .num').val(),o=t.split(",");for(let e=0;e<o.length;e++)""===o[e]&&(o[e]=0);MY_API.CONFIG.LIGHT_MEDALS=o,t=e.find('div[data-toggle="SPARE_GIFT_ROOM"] .num').val(),MY_API.CONFIG.SPARE_GIFT_ROOM=t,t=parseInt(e.find('div[data-toggle="STORM_QUEUE_SIZE"] .num').val()),MY_API.CONFIG.STORM_QUEUE_SIZE=t,t=parseInt(e.find('div[data-toggle="STORM_MAX_COUNT"] .num').val()),MY_API.CONFIG.STORM_MAX_COUNT=t,t=parseInt(e.find('div[data-toggle="STORM_ONE_LIMIT"] .num').val()),MY_API.CONFIG.STORM_ONE_LIMIT=t,t=e.find('div[data-toggle="COIN_UID"] .num').val(),o=t.split(",");for(let e=0;e<o.length;e++)""===o[e]&&(o[e]=0);MY_API.CONFIG.COIN_UID=o,i=e.find('div[data-toggle="AUTO_DANMU_SETTINGS"] .Danmu').val(),o=i.split(",");for(let e=0;e<o.length;e++)""===o[e]&&(o[e]="这是一条弹幕");i=o,r=e.find('div[data-toggle="AUTO_DANMU_SETTINGS"] .Roomid').val(),o=r.split(",");for(let e=0;e<o.length;e++)""===o[e]&&(o[e]="22474988");r=o,a=e.find('div[data-toggle="AUTO_DANMU_SETTINGS"] .Time').val(),o=a.split(",");for(let e=0;e<o.length;e++)""===o[e]&&(o[e]="10m");if(a=o,MY_API.CONFIG.DANMU_CONTENT=i,MY_API.CONFIG.DANMU_ROOMID=r,MY_API.CONFIG.DANMU_INTERVAL_TIME=a,t=parseInt(e.find('div[data-toggle="MATERIAL_LOTTERY_CHECK_INTERVAL"] .num').val()),MY_API.CONFIG.MATERIAL_LOTTERY_CHECK_INTERVAL=t,t=parseInt(e.find('div[data-toggle="MATERIAL_LOTTERY_REM"] .num').val()),isNaN(t)&&(t=9),MY_API.CONFIG.MATERIAL_LOTTERY_REM=t,t=parseFloat(e.find('div[data-toggle="ANCHOR_CHECK_INTERVAL"] .num').val()),MY_API.CONFIG.ANCHOR_CHECK_INTERVAL=t,t=e.find('div[data-toggle="ANCHOR_MAXROOM"] .roomNum').val(),t<=0)return window.toast("[检查房间最大数量] 数据小于等于0","caution");if(MY_API.CONFIG.ANCHOR_MAXROOM=t,t=parseInt(e.find('div[data-toggle="AHCHOR_NEED_GOLD"] .num').val()),MY_API.CONFIG.AHCHOR_NEED_GOLD=t,t=parseInt(e.find('div[data-toggle="ANCHOR_INTERVAL"] .num').val()),isNaN(t)||t<0)return window.toast("[请求间隔] 错误输入","caution");if(MY_API.CONFIG.ANCHOR_INTERVAL=t,t=e.find('div[data-toggle="ANCHOR_TYPE_LIVEROOM"] .num').val(),isNaN(t)||t<0)return window.toast("[从直播间获取天选数据] 直播间号格式错误","caution");if(MY_API.CONFIG.ANCHOR_GETDATA_ROOM=t,t=parseInt(e.find('[data-toggle="ANCHOR_UPLOAD_DATA"] .num').val()),isNaN(t)||t<0)return window.toast("[上传天选数据至直播间个人简介间隔] 错误输入","caution");if(MY_API.CONFIG.ANCHOR_UPLOAD_DATA_INTERVAL=t,t=e.find('[data-toggle="ANCHOR_MAXLIVEROOM_SAVE"] .roomNum').val(),isNaN(t)||t<0)return window.toast("[个人简介储存房间最大数量] 错误输入","caution");if(MY_API.CONFIG.ANCHOR_MAXLIVEROOM_SAVE=t,t=parseFloat(e.find('[data-toggle="ANCHOR_IGNORE_MONEY"] .num').val()),isNaN(t)||t<0)return window.toast("[忽略小于指定金额天选] 错误输入","caution");if(MY_API.CONFIG.ANCHOR_IGNORE_MONEY=t,t=parseFloat(e.find('[data-toggle="MEDAL_DANMU_INTERVAL"] .num').val()),isNaN(t)||t<0)return window.toast("[打卡弹幕发送间隔] 错误输入","caution");if(MY_API.CONFIG.MEDAL_DANMU_INTERVAL=t,t=parseInt(e.find('[data-toggle="COIN2SILVER"] .coin_number').val()),isNaN(t)||t<0)return window.toast("[硬币换银瓜子] 错误输入","caution");MY_API.CONFIG.COIN2SILVER_NUM=t,t=e.find('[data-toggle="GIFT_ALLOW_TYPE"] .str').val(),o=t.split(",");for(let e=0;e<o.length;e++)""===o[e]&&(o[e]="0");return MY_API.CONFIG.GIFT_ALLOW_TYPE=o,MY_API.saveConfig()},r=["AUTO_DANMU","RANDOM_DELAY","TIME_AREA_DISABLE","AUTO_GROUP_SIGN","LOGIN","WATCH","COIN","SHARE","SILVER2COIN","LIVE_SIGN","IN_TIME_RELOAD_DISABLE","TIME_RELOAD","AUTO_GIFT","SEND_ALL_GIFT","STORM","LITTLE_HEART","REMOVE_ELEMENT_2233","REMOVE_ELEMENT_activity","REMOVE_ELEMENT_rank","LOTTERY","CHECK_HOUR_ROOM","MATERIAL_LOTTERY","MATERIAL_LOTTERY_IGNORE_QUESTIONABLE_LOTTERY","ANCHOR_IGNORE_BLACKLIST","ANCHOR_LOTTERY","FT_NOTICE","ANCHOR_WAIT_REPLY","ANCHOR_AUTO_DEL_FOLLOW","ANCHOR_UPLOAD_DATA","ANCHOR_PRIVATE_LETTER","GM_NOTICE","ANCHOR_ADD_TO_WHITELIST","ANCHOR_MOVETO_FOLLOW_TAG","MEDAL_DANMU","ANCHOR_DANMU","ANCHOR_MOVETO_PRIZE_TAG","ANCHOR_IGNORE_PWDROOM","UPDATE_TIP","REMOVE_ELEMENT_followSideBar","REMOVE_ELEMENT_flipView","ANCHOR_UPLOAD_MSG","ANCHOR_IGNORE_UPLOAD_MSG","ANCHOR_IGNORE_ROOM","ANCHOR_MONEY_ONLY","FORCE_LIGHT","COIN2SILVER","ANCHOR_TYPE_POLLING","ANCHOR_TYPE_LIVEROOM","ANCHOR_TYPE_FOLLOWING"],a=[{name:"COIN_TYPE",toggle1:"COIN_DYN",toggle2:"COIN_UID"},{name:"GIFT_METHOD",toggle1:"GIFT_INTERVAL",toggle2:"GIFT_SEND_TIME"},{name:"GIFT_SORT",toggle1:"GIFT_SORT_HIGH",toggle2:"GIFT_SORT_LOW"},{name:"MEDAL_DANMU_METHOD",toggle1:"MEDAL_DANMU_WHITE",toggle2:"MEDAL_DANMU_BLACK"},{name:"LIGHT_METHOD",toggle1:"LIGHT_WHITE",toggle2:"LIGHT_BLACK"}],n={ANCHOR_IGNORE_MONEY:"脚本会尝试识别天选标题中是否有金额并忽略金额小于设置值的天选。<mh3>注意：</mh3><mul><mli>支持识别阿拉伯数字和汉字数字。</mli><mli>识别的单位有限。</mli><mli>不支持识别外币。</mli><mli>由于一些天选时刻的奖品名比较特殊，可能会出现遗漏或误判。</mli></mul>",LOTTERY:"参与大乱斗抽奖。",MEDAL_DANMU:"在拥有粉丝勋章的直播间内，每天发送的首条弹幕将点亮对应勋章并给该勋章+100亲密度。<mh3>注意：</mh3><mul><mli>如果要填写多条弹幕，每条弹幕间请用半角逗号<code>,</code>隔开，发弹幕时将依次选取弹幕进行发送（若弹幕数量不足则循环选取）。</mli><mli>本功能运行时【自动发弹幕】和【自动送礼】将暂停运行。</mli></mul>",AUTO_DANMU:"发送直播间弹幕。<mh3>注意：</mh3><mul><mli>本功能运行时【粉丝勋章打卡弹幕】将暂停运行。</mli><mli><mp>弹幕内容，房间号，发送时间可填多个，数据之间用半角逗号<code>,</code>隔开(数组格式)。脚本会按顺序将这三个值一一对应，发送弹幕。</mp></mli><mli><mp>由于B站服务器限制，每秒最多只能发1条弹幕。若在某一时刻有多条弹幕需要发送，脚本会在每条弹幕间加上1.5秒间隔时间（对在特定时间点发送的弹幕无效）。</mp></mli><mli><mp>如果数据没对齐，缺失的数据会自动向前对齐。如填写<code>弹幕内容 lalala</code>，<code>房间号 3,4</code>，<code>发送时间 5m,10:30</code>，少填一个弹幕内容。那么在发送第二条弹幕时，第二条弹幕的弹幕内容会自动向前对齐（即第二条弹幕的弹幕内容是lalala）。</mp></mli><mli><mp>可以用默认值所填的房间号来测试本功能。</mp></mli><mli><mp>发送时间有两种填写方法</mp><mp>1.【小时】h【分钟】m【秒】s</mp><mul><mli>每隔一段时间发送一条弹幕</mli><mli>例子：<code>1h2m3s</code>, <code>300m</code>, <code>30s</code>, <code>1h50s</code>, <code>2m6s</code>, <code>0.5h</code></mli><mli>可以填小数</mli><mli>可以只填写其中一项或两项</mli></mul><mp>脚本会根据输入数据计算出间隔时间，每隔一个间隔时间就会发送一条弹幕。如果不加单位，如填写<code>10</code>则默认单位是分钟（等同于<code>10m</code>）。</mp><mp><em>注意：必须按顺序填小时，分钟，秒，否则会出错(如<code>3s5h</code>就是错误的写法)</em></mp><mp>2.【小时】:【分钟】:【秒】</mp><mul><mli>在特定时间点发一条弹幕</mli><mli>例子： <code>10:30:10</code>, <code>0:40</code></mli><mli>只能填整数</mli><mli>小时分钟必须填写，秒数可以不填</mli></mul><mp>脚本会在该时间点发一条弹幕（如<code>13:30:10</code>就是在下午1点30分10秒的时候发弹幕）。</mp></mli></mul>",NOSLEEP:"屏蔽B站的挂机检测。不开启本功能时，标签页后台或长时间无操作就会触发B站的挂机检测。<mh3>原理：</mh3><mul><mli>劫持页面上的<code>addEventListener</code>绕过页面可见性检测，每5分钟触发一次鼠标移动事件规避鼠标移动检测。</mli><mul>",INVISIBLE_ENTER:"开启后进任意直播间其他人都不会看到你进直播间的提示【xxx 进入直播间】（只有你自己能看到）。<mh3>缺点：</mh3>开启后无法获取自己是否是当前直播间房管的数据，关注按钮状态均为未关注。所以开启本功能后进任意直播间都会有【禁言】按钮（如果不是房管点击后会提示接口返回错误），发弹幕时弹幕旁边会有房管标识（如果不是房管则只有你能看到此标识）。",MATERIAL_LOTTERY:"实物抽奖，即金宝箱抽奖。某些特殊的直播间会有金宝箱抽奖。<mh3>注意：</mh3><mul><mli>【忽略关键字】中每一项之间用半角逗号<code>,</code>隔开。</mli></mul>",MATERIAL_LOTTERY_REM:"aid是活动的编号。如果你不理解此项保持默认配置即可。",ANCHOR_IGNORE_BLACKLIST:"忽略奖品名中含特定关键字或匹配特定正则表达式的存疑天选。<mh3>注意：</mh3><mul><mli>若要填写多个，每一项之间用半角逗号<code>,</code>隔开。</mli><mli>可以填正则表达式。正则格式为以<code>/</code>开头且以<code>/</code>结尾，如<code>/测.*试/</code>。</mli><mli>关键字对大小写不敏感，而正则会区分大小写。</mli></mul>",MATERIAL_LOTTERY_IGNORE_QUESTIONABLE_LOTTERY:"忽略奖品名中含特定关键字或匹配特定正则表达式的存疑抽奖。<mh3>注意：</mh3><mul><mli>若要填写多个，每一项之间用半角逗号<code>,</code>隔开。</mli><mli>可以填正则表达式。正则格式为以<code>/</code>开头且以<code>/</code>结尾，如<code>/测.*试/</code>。</mli><mli>关键字对大小写不敏感，而正则会区分大小写。</mli></mul>",FT_NOTICE:"<a href = 'https://sc.ftqq.com/' target = '_blank'>方糖（点我注册）</a>，即「Server酱」，英文名「ServerChan」，是一款「程序员」和「服务器」之间的通信软件。说人话？就是从服务器推报警和日志到手机的工具。<br>使用前请先前往方糖官网完成注册，然后回到脚本界面填写SCKEY。<br><mul><mli>检测到实物/天选中奖后会发一条包含中奖具体信息的微信推送提醒你中奖了。</mli></mul>",BUY_MEDAL:"调用官方api，消耗20硬币购买某位UP的粉丝勋章。<mul><mli>默认值为当前房间号。点击购买按钮后有确认界面，无需担心误触。</mli></mul>",btnArea:"<mul><mli>重置所有为默认：指将设置和任务执行时间缓存重置为默认。</mli><mli>再次执行所有任务，再次执行主站任务会使相关缓存重置为默认，可以在勾选了新的任务设置后使用。</mli><mli>导出配置：导出一个包含当前脚本设置的json到浏览器的默认下载路径，文件名为<code>BLTH_CONFIG.json</code>。</mli><mli>导入配置：从一个json文件导入脚本配置，导入成功后脚本会自动刷新页面使配置生效。</mli></mul>",LITTLE_HEART:"通过发送客户端心跳包获取小心心（无论目标房间是否开播都能获取）。<mul><mli>检测到包裹内有24个7天的小心心后会停止。</mli><mli>在获取完所有小心心之前直播间不刷新。</mli><mli>B站随时可以通过热更新使该功能失效。</mli></mul>",STORM:"仅会参加被广播的节奏风暴。若无法参加请尝试实名后再参加。",SEND_ALL_GIFT:"若不勾选该项，自动送礼只会送出在【允许被送出的礼物类型】中的礼物。",AUTO_GIFT_ROOMID:"送礼时优先给这些房间送礼，送到对应粉丝牌亲密度上限后再送其它的。<mul><mli>如果要填写多个房间，每个房间号之间需用半角逗号<code>,</code>隔开。如<code>666,777,888</code>。</mli></mul>",EXCLUDE_ROOMID:"不给这些房间送礼。<mul><mli>如果要填写多个房间，每个房间号之间需用半角逗号<code>,</code>隔开。如<code>666,777,888</code>。</mli></mul>",GIFT_LIMIT:"将要在这个时间段里过期的礼物会被送出。<mh3>注意：</mh3><mul><mli>勾选【无视礼物类型和到期时间限制】时无论礼物是否将要过期都会被送出。</mli></mul>",AUTO_GIFT:"自动给有粉丝勋章的直播间送出包裹内的礼物。<mh3>说明：</mh3><mul><mli>送礼设置优先级：<br>不送礼房间 > 优先送礼房间 > 优先高/低等级粉丝牌。</mli><mli>送礼设置逻辑规则：<br>无论【优先高/低等级粉丝牌】如何设置，会根据【无视礼物类型和到期时间限制】（勾选则无视是否到期补满亲密度，否则只送到期的）条件去按优先送礼房间先后顺序送礼。之后根据【优先高/低等级粉丝牌】决定先送高级还是低级。</mli></mul>",SPARE_GIFT_ROOM:"【剩余礼物】指送满了所有粉丝牌，但仍有剩余的将在1天内过期的礼物。<mul><mli>该项填<code>0</code>则不送剩余礼物。</mli></mul>",COIN:"自动给视频投币，每天最多投5个。<mul><mli>脚本会根据今日你已获得的投币经验值判断你已经投了多少个币，然后自动投剩余没投的币。<blockquote>如今日已获得投币经验20，脚本投币数量设置为4，则会投2个币。</blockquote></mli></mul>",COIN_UID:"该项若填<code>0</code>则给动态中的视频依次投币(不存在UID为0的用户)。<mul><mli>可以填写多个uid，每两个uid间用半角逗号<code>,</code>隔开。</mli><mli>如果填了多个uid，则会依次检查这些UP是否有可投币的视频。</mli></mul>",ANCHOR_INTERVAL:"轮询天选，取关，获取房间列表时每两个请求间的间隔时间。<mh3>注意：</mh3><mul><mli>如果间隔时间过短可能会被风控。</mli></mul>",ANCHOR_WAIT_REPLY:"发起检查直播间天选信息，取关的请求后会等待回复，收到回复后等待一个间隔时间再发起下一个请求。<mh3>任务流程：</mh3><mul><mli>发起请求 - 等待回复 - 等待一个间隔时间 - 发起下一个请求</mli></mul>",ANCHOR_AUTO_DEL_FOLLOW:"如果该UP在白名单内或一开始就在默认分组则不会被取关。",anchorBtnArea:"参加天选时会关注很多UP。可以在参加天选前点击【保存当前关注列表为白名单】，参与完天选后再点【取关不在白名单内的UP主】来清理关注列表。<mul><mli>不建议频繁清理，可能会被风控。</mli><mli>【编辑白名单】每两个uid之间用半角逗号<code>,</code>隔开。</mli><mli>推荐大家使用【取关分组内的UP主】的功能来清理关注列表，【取关不在白名单内的UP主】可以作为一个备选方案。</mli></mul>",ANCHOR_TYPE_POLLING:"高热度房间来源于各分区小时榜和热门房间列表。",ANCHOR_UPLOAD_DATA:"使用这个功能前你必须先拥有自己的直播间。  <mul><mli>上传数据格式：经<a href = 'https://baike.baidu.com/item/base64/8545775' target = '_blank'>Base64</a>编码的JSON字符串，编码后每两个字符间插入一个<code>-</code>。JSON格式：<code>{ roomList: [直播间1, 直播间2, ...], ts: 时间戳, msg?: 附加信息 }</code>。</mli><mli>【间隔__秒】：这个设置项若填<code>10</code>秒，则每<code>10</code>秒检查一次是否收集到了新的数据，若有才上传。</mli></mul>",ANCHOR_UPLOAD_MSG:'在上传天选数据的同时可以上传一段附加信息。<mul><mli>可以填写html<br>如：<code>&lt;span style="color:red;"&gt;测试&lt;/span&gt;</code> 效果：<span style="color:red;">测试</span></mli><mli>如果想把附加信息设为空，请点击编辑界面上的<code>留空</code>按钮。</mli></mul>',ANCHOR_MAXLIVEROOM_SAVE:"个人简介有长度限制（约为一万个字符），若【个人简介储存房间最大数量】太大会无法上传。",ANCHOR_MAXROOM:"若收集的房间总数超过【检查房间最大数量】则会删除一部分最开始缓存的房间。<mh3>注意：</mh3><mul><mli>这一项并不是数值越大效率就越高。如果把这个值设置得过高会浪费很多时间去检查热度较低的，甚至已经下播的房间。【个人简介储存房间最大数量】同理。</mli></mul>",ANCHOR_TYPE_LIVEROOM:"因为在云上部署了脚本，<strong>默认值所填直播间(<a href = 'https://live.bilibili.com/22474988' target = '_blank'>22474988</a>)的个人简介可以持续提供天选数据</strong>（除非被风控或遇到一些突发情况）。<mul><mli>这个功能主要是为了减少请求数量，提高效率同时减少风控的概率。</mli><mli>使用本功能时建议把【天选获取数据间隔】调低一些减少遗漏的天选数量。</mli><mli><a href='https://jq.qq.com/?_wv=1027&amp;k=fCSfWf1O' target = '_blank'>q群（1106094437）</a>的群在线文档中有一些群友上传的能提供天选数据的直播间号。</mli></mul>",ANCHOR_PRIVATE_LETTER:"若中奖，会在开奖后10秒发送私信。<mul><mli>建议改一下私信内容，不要和默认值完全一样。</mli></mul>",ANCHOR_MOVETO_FOLLOW_TAG:`分组的名称为<code>${anchorFollowTagName}</code>。<mul><mli><strong>请勿修改该分组名称。</strong></mli></mul>`,RANDOM_DELAY:"抽奖前额外等待一段时间。<mul><mli>可以填小数。</mli></mul>",RANDOM_SKIP:"随机忽略一部分抽奖。<mul><mli>可以填小数。</mli></mul>",ANCHOR_CHECK_INTERVAL:"检查完一轮天选后等待的时间。<mul><mli>可以填小数。</mli></mul>",TIME_AREA_DISABLE:"处于这个时段内时，脚本会暂停检查小时榜和天选时刻。<br><mul><mli>24小时制，只能填整数。</mli></mul>",MEDAL_DANMU_METHOD:"发送粉丝勋章打卡弹幕的逻辑，有白名单和黑名单两种。后文中的<code>直播间</code>指拥有粉丝勋章的直播间。<mul><mli>白名单：仅给房间列表内的直播间发弹幕。</mli><mli>黑名单：给房间列表以外的直播间发弹幕。</mli><mli>若要填写多个直播间，每两个直播间号之间用半角逗号<code>,</code>隔开。</mli></mul>",ANCHOR_DANMU:"检测到中奖后在发起抽奖的直播间发一条弹幕。<mh3>注意：</mh3><mul><mli>如果要填写多条弹幕，每条弹幕间请用半角逗号<code>,</code>隔开，发弹幕时将从中随机抽取弹幕进行发送。</mli></mul>",topArea:"这里会显示一些统计信息。点击【保存所有设置】按钮即可保存当前设置。<mul><mli>统计信息实时更新，每天0点时重置。</mli><mli><strong>支持输入框回车保存。</strong></mli><mli>单选框和多选框设置发生变化时会自动保存设置。</mli></mul>",ANCHOR_MOVETO_PRIZE_TAG:`分组的名称为<code>${anchorPrizeTagName}</code>。<mul><mli><strong>请勿修改该分组名称。</strong></mli></mul>`,debugSwitch:"开启或关闭控制台日志(可通过<code>ctrl + shift + i</code>打开控制台)。<mul><mli>平时建议关闭，减少资源占用。</mli><mli>该设置只会影响日志(<code>console.log</code>)，不会影响报错(<code>console.error</code>)。</mli></mul>",UPDATE_TIP:"每次更新后第一次运行脚本时显示关于更新内容的弹窗。",ANCHOR_IGNORE_UPLOAD_MSG:"不显示获取到的附加信息。",MEDAL_DANMU_INTERVAL:"每两条弹幕间所等待的时间。<mh3>注意：</mh3><mul><mli>由于B站服务器限制，间隔时间必须大于等于1秒，否则弹幕发送会出错。</mli></mul>",ANCHOR_IGNORE_ROOM:"不检查和参加这些直播间的天选。<mul><mli>如果要填写多个直播间，每两个直播间号之间请用半角逗号<code>,</code>隔开。</mli></mul>",ANCHOR_LOTTERY:"参加B站直播间的天选时刻抽奖。<mul><mli>这些抽奖通常是有参与条件的，如关注主播，投喂礼物，粉丝勋章等级，主站等级，直播用户等级，上舰等。</mli><mli>根据目前B站的规则，参加天选的同时会在发起抽奖的直播间发送一条弹幕（即弹幕口令，参加天选后自动发送）。</mli><mli>脚本会根据用户设置来决定是否要忽略某个天选，以下是判断的先后顺序，一旦检测到不符合要求则忽略该天选并中断后续判断流程：<br><code>忽略直播间</code>，<code>忽略已参加天选</code>，<code>忽略过期天选</code>，<code>忽略关键字</code>，<code>忽略金额</code>，<code>忽略非现金抽奖的天选</code>，<code>忽略付费天选</code>，<code>忽略不满足参加条件（粉丝勋章，大航海，直播用户等级，主站等级）的天选</code>。</mli><mli>收集到的直播间号会缓存在本地以供后续使用。</mli></mul>",SHARE:"并不会真的分享视频，通过调用特定api直接完成任务。",ANCHOR_MONEY_ONLY:"仅参加能识别到金额的天选。<mul><mli>由于部分天选的奖品名较特殊，可能会遗漏或误判一些天选。</mli></mul>",LIGHT_MEDALS:"根据点亮模式的不同，这些直播间的粉丝勋章将会被点亮或排除在外。<mul><mli>如果要填写多个房间，每个房间号之间需用半角逗号<code>,</code>隔开。</mli></mul>",LIGHT_METHOD:"通过给拥有粉丝勋章的直播间送一个小心心来点亮熄灭的勋章。<mul><mli>白名单：只点亮这些房间的粉丝勋章。</mli><mli>黑名单：点亮除了这些房间以外的直播间的粉丝勋章。</mli><mli>如果你不想启用本功能，把【勋章点亮模式】设为白名单，然后在【自动点亮勋章房间号】中填<code>0</code>即可。</mli><mli>脚本会在运行自动送礼前点亮勋章。如果未启用自动送礼，请点击【立刻点亮勋章】按钮。</mli></mul>",ANCHOR_IGNORE_PWDROOM:"部分直播间需输入密码后才能进入。勾选此选项后将忽略这些直播间的天选。",COIN2SILVER:"普通用户每天兑换上限<code>25</code>硬币，老爷或大会员每天兑换上限<code>50</code>硬币。<mul><mli><code>1</code>硬币 = <code>450</code>银瓜子（老爷或大会员<code>500</code>银瓜子）。</mli></mul>",SILVER2COIN:"每日直播用户都可以将部分银瓜子转化为硬币，每天仅一次机会。<mul><mli><code>700</code>银瓜子 = <code>1</code>硬币。</mul></mli>",windowToast:'右上角的提示信息。相对来说不是那么重要，所以不放在日志窗口里。<mul style = "line-height:1em;"><div class="link-toast info fixed"><span class="toast-text">普通消息</span></div><br><br><br><div class="link-toast success fixed"><span class="toast-text">成功</span></div><br><br><br><div class="link-toast error fixed"><span class="toast-text">发生错误</span></div></mul>',GIFT_ALLOW_TYPE:"可以填写礼物的id或者礼物名称。<mul><mli>如果要填写多个，每两项之间请用半角逗号<code>,</code>隔开。</mli><mli>如果填写礼物名称，请确保所填写的名称与官方名称完全一致，否则将无法识别。</mli><mli>若填写礼物名，脚本会在送礼前将其转换成 id（不会修改设置项）。如果直接填写 id 能提高运行效率。<mli>在控制台(可通过<code>ctrl + shift + i</code>打开)中搜索<code>InitData: API.gift.gift_config</code>可以找到一个包含礼物名称和 id 的json。将data下的几项全部展开，再搜索礼物名即可找到 id 。</mli><mli>常用 id ：1: <code>辣条</code> 6: <code>亿圆</code> 30607: <code>小心心</code></mli></mul>",ANCHOR_TYPE_FOLLOWING:"搜寻已关注且开播的直播间的天选时刻。"};let l=!1;e.click(()=>{hideBtnClickable&&(hideBtnClickable=!1,setTimeout((function(){hideBtnClickable=!0}),310),"show"===mainDisplay?(mainDisplay="hide",localStorage.setItem(NAME+"_msgHide",mainDisplay),animChange(layerUiMain,!0),document.getElementById("hiderbtn").innerHTML="显示控制面板",setTimeout(()=>layer.style(mainIndex,{zIndex:0}),300)):(mainDisplay="show",layer.style(mainIndex,{zIndex:1e3}),localStorage.setItem(NAME+"_msgHide",mainDisplay),l?(layerUiMain.show(),l=!1):animChange(layerUiMain,!1),document.getElementById("hiderbtn").innerHTML="隐藏控制面板"))}),$(".attention-btn-ctnr").append(e),(()=>{let e=$(".live-player-mounter").offset(),t=$(".live-player-mounter").height();mainIndex=layer.open({type:1,title:!1,offset:[String(e.top-getScrollPosition().y)+"px",String(e.left-getScrollPosition().x)+"px"],closeBtn:0,shade:0,zIndex:1e3,fixed:!1,area:[,String(t)+"px"],resize:!1,content:o,success:()=>{layerUiMain=$("#layui-layer"+String(2+layerTimes));let e=$("#allsettings");$("#giftCount .anchor .statNum").text(MY_API.GIFT_COUNT.ANCHOR_COUNT),$("#giftCount .material .statNum").text(MY_API.GIFT_COUNT.MATERIAL_COUNT),e.find('div[data-toggle="MATERIAL_LOTTERY_IGNORE_QUESTIONABLE_LOTTERY"] label.str').text(String(MY_API.CONFIG.QUESTIONABLE_LOTTERY.length)+"个"),e.find('div[data-toggle="ANCHOR_IGNORE_BLACKLIST"] label.str').text(String(MY_API.CONFIG.ANCHOR_BLACKLIST_WORD.length)+"个"),e.find('div[data-toggle="ANCHOR_IGNORE_ROOM"] label.str').text(String(MY_API.CONFIG.ANCHOR_IGNORE_ROOMLIST.length)+"个"),e.find('div[data-toggle="GIFT_ALLOW_TYPE"] .str').val(MY_API.CONFIG.GIFT_ALLOW_TYPE).toString(),e.find('div[data-toggle="COIN2SILVER"] .coin_number').val(parseInt(MY_API.CONFIG.COIN2SILVER_NUM).toString()),e.find('div[data-toggle="LIGHT_MEDALS"] .num').val(MY_API.CONFIG.LIGHT_MEDALS.toString()),e.find('div[data-toggle="MEDAL_DANMU_INTERVAL"] .num').val(parseFloat(MY_API.CONFIG.MEDAL_DANMU_INTERVAL).toString()),e.find('div[data-toggle="ANCHOR_IGNORE_MONEY"] .num').val(parseFloat(MY_API.CONFIG.ANCHOR_IGNORE_MONEY).toString()),e.find('div[data-toggle="ANCHOR_MAXLIVEROOM_SAVE"] .roomNum').val(parseInt(MY_API.CONFIG.ANCHOR_MAXLIVEROOM_SAVE).toString()),e.find('div[data-toggle="ANCHOR_UPLOAD_DATA"] .num').val(MY_API.CONFIG.ANCHOR_UPLOAD_DATA_INTERVAL.toString()),e.find('div[data-toggle="ANCHOR_TYPE_LIVEROOM"] .num').val(MY_API.CONFIG.ANCHOR_GETDATA_ROOM.toString()),e.find('div[data-toggle="ANCHOR_INTERVAL"] .num').val(parseInt(MY_API.CONFIG.ANCHOR_INTERVAL).toString()),e.find('div[data-toggle="AHCHOR_NEED_GOLD"] .num').val(parseInt(MY_API.CONFIG.AHCHOR_NEED_GOLD).toString()),e.find('div[data-toggle="ANCHOR_MAXROOM"] .roomNum').val(parseInt(MY_API.CONFIG.ANCHOR_MAXROOM).toString()),e.find('div[data-toggle="ANCHOR_CHECK_INTERVAL"] .num').val(parseFloat(MY_API.CONFIG.ANCHOR_CHECK_INTERVAL).toString()),e.find('div[data-toggle="MATERIAL_LOTTERY_REM"] .num').val(parseInt(MY_API.CONFIG.MATERIAL_LOTTERY_REM).toString()),e.find('div[data-toggle="MATERIAL_LOTTERY_CHECK_INTERVAL"] .num').val(parseInt(MY_API.CONFIG.MATERIAL_LOTTERY_CHECK_INTERVAL).toString()),e.find('div[data-toggle="AUTO_DANMU_SETTINGS"] .Time').val(MY_API.CONFIG.DANMU_INTERVAL_TIME.toString()),e.find('div[data-toggle="AUTO_DANMU_SETTINGS"] .Roomid').val(MY_API.CONFIG.DANMU_ROOMID.toString()),e.find('div[data-toggle="AUTO_DANMU_SETTINGS"] .Danmu').val(MY_API.CONFIG.DANMU_CONTENT.toString()),e.find('div[data-toggle="GIFT_INTERVAL"] .num').val(parseInt(MY_API.CONFIG.GIFT_INTERVAL).toString()),e.find('div[data-toggle="STORM_MAX_COUNT"] .num').val(parseInt(MY_API.CONFIG.STORM_MAX_COUNT).toString()),e.find('div[data-toggle="STORM_ONE_LIMIT"] .num').val(parseInt(MY_API.CONFIG.STORM_ONE_LIMIT).toString()),e.find('div[data-toggle="STORM_QUEUE_SIZE"] .num').val(parseInt(MY_API.CONFIG.STORM_QUEUE_SIZE).toString()),e.find('div[data-toggle="SPARE_GIFT_ROOM"] .num').val(MY_API.CONFIG.SPARE_GIFT_ROOM.toString()),e.find('div[data-toggle="TIME_RELOAD"] .delay-seconds').val(parseInt(MY_API.CONFIG.TIME_RELOAD_MINUTE).toString()),e.find('div[data-toggle="RANDOM_SKIP"] .per').val(parseFloat(MY_API.CONFIG.RANDOM_SKIP).toString()),e.find('div[data-toggle="RANDOM_SEND_DANMU"] .per').val(parseFloat(MY_API.CONFIG.RANDOM_SEND_DANMU).toString()),e.find('div[data-toggle="COIN"] .coin_number').val(parseInt(MY_API.CONFIG.COIN_NUMBER).toString()),e.find('div[data-toggle="COIN_UID"] .num').val(MY_API.CONFIG.COIN_UID.toString()),e.find('div[data-toggle="RANDOM_DELAY"] .RND_DELAY_START').val(parseFloat(MY_API.CONFIG.RND_DELAY_START).toString()),e.find('div[data-toggle="RANDOM_DELAY"] .RND_DELAY_END').val(parseFloat(MY_API.CONFIG.RND_DELAY_END).toString()),e.find('div[data-toggle="TIME_AREA_DISABLE"] .startHour').val(parseInt(MY_API.CONFIG.TIME_AREA_START_H0UR).toString()),e.find('div[data-toggle="TIME_AREA_DISABLE"] .endHour').val(parseInt(MY_API.CONFIG.TIME_AREA_END_H0UR).toString()),e.find('div[data-toggle="TIME_AREA_DISABLE"] .startMinute').val(parseInt(MY_API.CONFIG.TIME_AREA_START_MINUTE).toString()),e.find('div[data-toggle="TIME_AREA_DISABLE"] .endMinute').val(parseInt(MY_API.CONFIG.TIME_AREA_END_MINUTE).toString()),e.find('div[data-toggle="CHECK_HOUR_ROOM"] .num').val(parseInt(MY_API.CONFIG.CHECK_HOUR_ROOM_INTERVAL).toString()),e.find('div[data-toggle="AUTO_GIFT_ROOMID"] .num').val(MY_API.CONFIG.AUTO_GIFT_ROOMID.toString()),e.find('div[data-toggle="EXCLUDE_ROOMID"] .num').val(MY_API.CONFIG.EXCLUDE_ROOMID.toString()),e.find('div[data-toggle="GIFT_SEND_TIME"] .Hour').val(MY_API.CONFIG.GIFT_SEND_HOUR.toString()),e.find('div[data-toggle="GIFT_SEND_TIME"] .Minute').val(MY_API.CONFIG.GIFT_SEND_MINUTE.toString()),e.find('div[data-toggle="GIFT_LIMIT"] .num').val(parseInt(MY_API.CONFIG.GIFT_LIMIT).toString()),e.find('div[data-toggle="BUY_MEDAL"] .num').val(Live_info.room_id);const t=$("#BLTH_config_file");t.on("change",importConfig),e[0].onselectstart=function(){return!1},e.find('button[data-action="save"]').click(()=>{i(e)}),e.find('button[data-action="exportConfig"]').click(()=>{exportConfig(MY_API.CONFIG,nosleepConfig,INVISIBLE_ENTER_config),layer.msg("配置已导出",{time:2500})}),e.find('button[data-action="importConfig"]').click(()=>{readConfigArray[1]=$.Deferred(),t.click(),readConfigArray[1].then(()=>{let e=readConfigArray[0];MYDEBUG("readConfigArray 文件读取结果：",readConfigArray[0]),$.extend(!0,MY_API.CONFIG,e.MY_API_CONFIG),MY_API.saveConfig(!1),localStorage.setItem(NAME+"_NOSLEEP",e.nosleepConfig),localStorage.setItem(NAME+"_INVISIBLE_ENTER",e.INVISIBLE_ENTER_config),layer.msg("配置导入成功，3秒后将自动刷新页面",{time:3e3,icon:1}),setTimeout(()=>{window.location.reload()},3e3)})}),e.find('div[data-toggle="BUY_MEDAL"] [data-action="buy_medal"]').click((function(){const t=parseInt(e.find('div[data-toggle="BUY_MEDAL"] .num').val());MY_API.buyFanMedal(t)})),e.find('button[data-action="reset"]').click(()=>{MY_API.setDefaults()}),e.find('button[data-action="checkUpdate"]').click(()=>{MY_API.checkUpdate()}),e.find('button[data-action="redoAllTasks"]').click(()=>{MY_API.ReDoAllTasks()}),e.find('button[data-action="about"]').click(()=>{layer.open({title:"版本"+GM_info.script.version,content:`<h3 style="text-align:center">B站直播间挂机助手</h3>作者：${linkMsg("andywang425","https://github.com/andywang425/")}<br>许可证：${linkMsg("MIT","https://raw.githubusercontent.com/andywang425/BLTH/master/LICENSE")}<br>github项目地址：${linkMsg("BLTH","https://github.com/andywang425/BLTH")}<br>反馈：${linkMsg("BLTH/issues","https://github.com/andywang425/BLTH/issues")}<br>交流qq群：${linkMsg("1106094437（已满）","https://jq.qq.com/?_wv=1027&amp;k=fCSfWf1O")}，${linkMsg("907502444","https://jq.qq.com/?_wv=1027&k=Bf951teI")}<br>`})}),e.find('button[data-action="lightMedalNow"]').click(()=>{MY_API.CONFIG.AUTO_GIFT?(LIGHT_MEDAL_NOW=!0,MY_API.Gift.run()):window.toast("[立刻点亮勋章] 请先勾选【自动送礼】再点击此按钮","info")}),e.find('button[data-action="edit_ANCHOR_UPLOAD_MSG"]').click(()=>{layer.prompt({formType:2,value:String(MY_API.CONFIG.ANCHOR_UPLOAD_MSG_CONTENT),title:"请输入上传天选信息时的附加信息",btn:["保存","留空","取消"],btn2:function(){MY_API.CONFIG.ANCHOR_UPLOAD_MSG_CONTENT="",MY_API.saveConfig(!1),layer.msg("附加信息已被设为空字符串",{time:2500,icon:1})}},(function(e,t){MY_API.CONFIG.ANCHOR_UPLOAD_MSG_CONTENT=e,MY_API.saveConfig(!1),layer.msg("附加信息保存成功",{time:2500,icon:1}),layer.close(t)}))}),e.find('button[data-action="edit_ANCHOR_IGNORE_ROOMLIST"]').click(()=>{layer.prompt({formType:2,value:String(MY_API.CONFIG.ANCHOR_IGNORE_ROOMLIST),title:"请输入天选时刻忽略直播间",btn:["保存","取消"]},(function(t,o){let i=t.split(",");for(let e=0;e<i.length;e++)""===i[e]&&(i[e]="0");MY_API.CONFIG.ANCHOR_IGNORE_ROOMLIST=i,MY_API.saveConfig(!1),layer.msg("天选时刻忽略直播间保存成功",{time:2500,icon:1}),e.find('div[data-toggle="ANCHOR_IGNORE_ROOM"] label.str').html(MY_API.CONFIG.ANCHOR_IGNORE_ROOMLIST.length+"个"),layer.close(o)}))}),e.find('button[data-action="edit_lightMedalList"]').click(()=>{layer.prompt({formType:2,value:String(MY_API.CONFIG.MEDAL_DANMU_ROOM),title:"请输入粉丝勋章打卡弹幕房间列表",btn:["保存","取消"]},(function(e,t){let o=e.split(",");for(let e=0;e<o.length;e++)""===o[e]&&(o[e]="0");MY_API.CONFIG.MEDAL_DANMU_ROOM=o,MY_API.saveConfig(!1),layer.msg("粉丝勋章打卡弹幕房间列表保存成功",{time:2500,icon:1}),layer.close(t)}))}),e.find('button[data-action="edit_ANCHOR_DANMU_CONTENT"]').click(()=>{layer.prompt({formType:2,value:String(MY_API.CONFIG.ANCHOR_DANMU_CONTENT),title:"请输入天选时刻中奖后弹幕",btn:["保存","取消"]},(function(e,t){let o=e.split(",");for(let e=0;e<o.length;e++)""===o[e]&&(o[e]="我中啦！");MY_API.CONFIG.ANCHOR_DANMU_CONTENT=o,MY_API.saveConfig(!1),layer.msg("天选时刻中奖后弹幕保存成功",{time:2500,icon:1}),layer.close(t)}))}),e.find('button[data-action="edit_medalDanmu"]').click(()=>{layer.prompt({formType:2,value:String(MY_API.CONFIG.MEDAL_DANMU_CONTENT),title:"请输入粉丝勋章打卡弹幕",btn:["保存","取消"]},(function(e,t){let o=e.split(",");for(let e=0;e<o.length;e++)""===o[e]&&(o[e]="(｀・ω・´)");MY_API.CONFIG.MEDAL_DANMU_CONTENT=o,MY_API.saveConfig(!1),layer.msg("粉丝勋章打卡弹幕保存成功",{time:2500,icon:1}),layer.close(t)}))}),e.find('button[data-action="edit_QUESTIONABLE_LOTTERY"]').click(()=>{layer.prompt({formType:2,value:String(MY_API.CONFIG.QUESTIONABLE_LOTTERY),title:"请输入实物抽奖忽略关键字",btn:["保存","取消"]},(function(t,o){let i=t.split(",");for(let e=0;e<i.length;e++)""===i[e]&&(i[e]="test");MY_API.CONFIG.QUESTIONABLE_LOTTERY=i,MY_API.saveConfig(!1),layer.msg("实物抽奖忽略关键字保存成功",{time:2500,icon:1}),e.find('div[data-toggle="MATERIAL_LOTTERY_IGNORE_QUESTIONABLE_LOTTERY"] label.str').html(MY_API.CONFIG.QUESTIONABLE_LOTTERY.length+"个"),layer.close(o)}))}),e.find('button[data-action="edit_ANCHOR_BLACKLIST_WORD"]').click(()=>{layer.prompt({formType:2,value:String(MY_API.CONFIG.ANCHOR_BLACKLIST_WORD),title:"请输入天选时刻忽略关键字",btn:["保存","取消"]},(function(t,o){let i=t.split(",");for(let e=0;e<i.length;e++)""===i[e]&&(i[e]="钓鱼");MY_API.CONFIG.ANCHOR_BLACKLIST_WORD=i,MY_API.saveConfig(!1),layer.msg("天选时刻忽略关键字保存成功",{time:2500,icon:1}),e.find('div[data-toggle="ANCHOR_IGNORE_BLACKLIST"] label.str').html(MY_API.CONFIG.ANCHOR_BLACKLIST_WORD.length+"个"),layer.close(o)}))}),e.find('button[data-action="edit_ANCHOR_LETTER_CONTENT"]').click(()=>{layer.prompt({formType:2,value:MY_API.CONFIG.ANCHOR_LETTER_CONTENT,title:"请输入天选时刻中奖后发送私信内容",btn:["保存","取消"]},(function(e,t){let o=e;o||(o="UP我中天选了，怎么领奖"),MY_API.CONFIG.ANCHOR_LETTER_CONTENT=o,MY_API.saveConfig(!1),layer.msg("天选时刻私信内容保存成功",{time:2500,icon:1}),layer.close(t)}))}),e.find('button[data-action="mainSiteTasks"]').click(()=>{mainSiteTasksBtnClickable&&(mainSiteTasksBtnClickable=!1,setTimeout(()=>mainSiteTasksBtnClickable=!0,2e3),MY_API.DailyReward.run(!0))}),e.find('button[data-action="edit_SCKEY"]').click(()=>{layer.prompt({formType:0,value:MY_API.CONFIG.FT_SCKEY,title:"请输入方糖SCKEY",btn:["保存","取消"]},(function(e,t){MY_API.CONFIG.FT_SCKEY=e,MY_API.saveConfig(!1),layer.msg("方糖SCKEY保存成功",{time:2500,icon:1}),layer.close(t)}))}),e.find('button[data-action="editWhiteList"]').click(()=>{const e=[...(JSON.parse(localStorage.getItem(NAME+"_AnchorFollowingList"))||{list:[]}).list];layer.prompt({formType:2,maxlength:Number.MAX_SAFE_INTEGER,value:String(e),title:"天选时刻UID白名单",btn:["保存","取消"]},(function(e,t){let o=e;o||(o=[]),o=o.split(",");for(let e=0;e<o.length;e++)""===o[e]&&(o[e]="0");localStorage.setItem(NAME+"_AnchorFollowingList",JSON.stringify({list:o})),layer.msg("天选时刻UID白名单保存成功",{time:2500,icon:1}),layer.close(t)}))}),e.find('button[data-action="saveFollowingList"]').click(()=>{if(getFollowBtnClickable)return getFollowBtnClickable=!1,window.toast("[ 保存当前关注列表为白名单 ] 开始获取关注列表"),MY_API.AnchorLottery.getFollowingList()}),e.find('button[data-action="removeAnchorPrizeInTag"]').click(()=>{unFollowBtnClickable&&layer.confirm(`是否取关在【${anchorPrizeTagName}】分组的UP主？<mul><mli>注：不建议取关该分组内UP。</mli></mul>`,{title:"取关不在分组内的UP主",btn:["是","否"]},(function(){return unFollowBtnClickable=!1,layer.msg("开始取关",{time:2e3}),MY_API.AnchorLottery.getTag(anchorPrizeTagName,!0).then(()=>MY_API.AnchorLottery.delAnchorFollowing(3))}),(function(){layer.msg("已取消",{time:2e3})}))}),e.find('button[data-action="removeAnchorFollowingInTag"]').click(()=>{unFollowBtnClickable&&layer.confirm(`是否取关在【${anchorFollowTagName}】分组的UP主？`,{title:"取关不在分组内的UP主",btn:["是","否"]},(function(){return unFollowBtnClickable=!1,layer.msg("开始取关",{time:2e3}),MY_API.AnchorLottery.getTag(anchorFollowTagName,!0).then(()=>MY_API.AnchorLottery.delAnchorFollowing(2))}),(function(){layer.msg("已取消",{time:2e3})}))}),e.find('button[data-action="removeAnchorFollowing"]').click(()=>{unFollowBtnClickable&&layer.confirm("是否取关不在白名单内的UP主？",{title:"取关不在白名单内的UP主",btn:["是","否"]},(function(){return unFollowBtnClickable=!1,layer.msg("开始取关",{time:2e3}),MY_API.AnchorLottery.delAnchorFollowing(1)}),(function(){layer.msg("已取消",{time:2e3})}))}),e.find('button[data-action="sendGiftNow"]').click(()=>{MY_API.CONFIG.AUTO_GIFT?(SEND_GIFT_NOW=!0,MY_API.Gift.run()):window.toast("[ 立刻开始送礼 ] 请先勾选【自动送礼】再点击此按钮","info")}),e.find('button[data-action="sendDanmuNow"]').click(()=>{MY_API.CONFIG.AUTO_DANMU?(SEND_DANMU_NOW=!0,MY_API.AUTO_DANMU.run()):window.toast("[ 立刻发送弹幕 ] 请先勾选【自动发弹幕】再点击此按钮","info")}),e.find('button[data-action="clearDanmuCache"]').click(()=>{MY_API.CACHE.AUTO_SEND_DANMU_TS=[],MY_API.saveCache()&&MY_API.chatLog("清除弹幕缓存成功","success")});for(const t of r){const o=e.find(`div[data-toggle="${t}"] input:checkbox`);MY_API.CONFIG[t]&&o.attr("checked",""),o.change((function(){MY_API.CONFIG[t]=$(this).prop("checked"),MY_API.saveConfig()}))}const o=[{jqPath:'div[data-toggle="INVISIBLE_ENTER"] input:checkbox',lsItem:NAME+"_INVISIBLE_ENTER",toastMsg:["[隐身入场] 配置已保存","info"]},{jqPath:'div[data-toggle="NOSLEEP"] input:checkbox',lsItem:NAME+"_NOSLEEP",toastMsg:["[屏蔽挂机检测] 配置已保存","info"]},{jqPath:'div[data-toggle="debugSwitch"] input:checkbox',lsItem:NAME+"_debugSwitch",toastMsg:["[控制台日志] 配置已保存","info"],changeFn:function(e){debugSwitch=$(e).prop("checked")}},{jqPath:'div[data-toggle="windowToast"] input:checkbox',lsItem:NAME+"_windowToast",changeFn:function(e){windowToast=$(e).prop("checked"),windowToast?$(".link-toast").show():$(".link-toast").hide()}}];for(const t of o){const o=e.find(t.jqPath);"true"===localStorage.getItem(t.lsItem)&&o.attr("checked",""),o.change((function(){t.hasOwnProperty("changeFn")&&t.changeFn(this),localStorage.setItem(t.lsItem,$(this).prop("checked")),t.hasOwnProperty("toastMsg")&&window.toast(t.toastMsg[0],t.toastMsg[1])}))}$("input:text").bind("keydown",(function(t){13==t.keyCode&&i(e)}));for(const e of a){for(let t=1;;t++){const o="toggle"+String(t);if(!e.hasOwnProperty(o))break;MY_API.CONFIG[e.name]===e[o]&&$(`div[data-toggle= ${e[o]}] input:radio`).attr("checked","")}$(`input:radio[name= ${e.name} ]`).change((function(){for(let t=1;;t++){const o="toggle"+String(t);if(!e.hasOwnProperty(o))break;if($(`div[data-toggle= ${e[o]} ] input:radio`).is(":checked")){MY_API.CONFIG[e.name]=e[o],MY_API.saveConfig();break}}}))}$(".helpText").click((function(){const e=$(this).attr("helpData");if(void 0!==e&&n.hasOwnProperty(e))return layer.open({title:"帮助信息 "+e,anim:5,area:[String(.382*$(window).width())+"px",String(.618*$(window).height())+"px"],content:n[e]})}))},end:()=>{mainDisplay="hide",localStorage.setItem(NAME+"_msgHide",mainDisplay),document.getElementById("hiderbtn").innerHTML="显示控制面板"}})})(),"hide"===mainDisplay&&(layerUiMain.hide(),l=!0);new MutationObserver((function(){let e=t.attr("data-player-state"),o=tabContent.offset(),i=o.top,r=o.left;"web-fullscreen"!==e&&"fullscreen"!==e||(mainDisplay="hide",animChange(layerUiMain,!0),document.getElementById("hiderbtn").innerHTML="显示控制面板"),layer.style(logIndex,{top:String(i)+"px",left:String(r)+"px"})})).observe(t[0],{attributes:!0}),$(".attention-btn-ctnr").append(e),MY_API.CACHE.DailyReward_TS||(layer.tips("点我隐藏/显示控制面板","#hiderbtn",{tips:1}),setTimeout(()=>layer.tips("点我查看日志","#logDiv",{tips:1}),6e3))},chatLog:function(e,t="info"){let o=$("<div class='chatLogDiv'>"),i=$("<div class='chatLogMsg'>"),r=new Date;switch(i.html(e),o.text(r.toLocaleString()),o.append(i),t){case"warning":o.addClass("chatLogWarning");break;case"success":o.addClass("chatLogSuccess");break;case"error":o.addClass("chatLogError");break;case"prize":o.addClass("chatLogWinPrize");break;default:o.addClass("chatLogDefault")}JQmenuWindow.append(o);let a=o.find('span[id="time"] .num'),n=o.find('div[class="clickableText"]');const l=Number(a.text()),s=n.attr("id");if(void 0!==l){let e=l,t=setInterval(()=>{e--,e<=0?(o.find('span[id="time"]').html("已开奖"),void 0!==s&&0===s.indexOf(NAME+"_ANCHOR")&&n.remove(),clearInterval(t)):a.text(e)},1e3)}layerLogWindow_ScrollY>=layerLogWindow_ScrollHeight&&layerLogWindow.scrollTop(layerLogWindow.prop("scrollHeight"))},blocked:!1,max_blocked:!1,listen:(e,t,o="本直播间")=>{BAPI.room.getConf(e).then(i=>{MYDEBUG("获取弹幕服务器信息 "+o,i);let r=new BAPI.DanmuWebSocket(t,e,i.data.host_server_list,i.data.token);r.bind(e=>{r=e,MY_API.chatLog(o+"弹幕服务器连接断开，尝试重连","warning")},()=>{MY_API.chatLog(`——————连接弹幕服务器成功——————<br>房间号: ${e} 分区: ${o}`,"success")},()=>{(MY_API.blocked||MY_API.stormBlack)&&(r.close(),MY_API.chatLog("进了小黑屋主动与弹幕服务器断开连接-"+o,"warning")),MY_API.max_blocked&&!MY_API.CONFIG.STORM&&(r.close(),MY_API.chatLog("辣条最大值主动与弹幕服务器断开连接-"+o,"warning"))},e=>{switch(MYDEBUG("弹幕公告"+o,e),e.cmd){case"GUARD_MSG":e.roomid===e.real_roomid?MY_API.checkRoom(e.roomid,o):(MY_API.checkRoom(e.roomid,o),MY_API.checkRoom(e.real_roomid,o));break;case"PK_BATTLE_SETTLE_USER":e.data.winner?MY_API.checkRoom(e.data.winner.room_id,o):MY_API.checkRoom(e.data.my_info.room_id,o),MY_API.checkRoom(e.data.winner.room_id,o);break;case"NOTICE_MSG":switch(e.msg_type){case 1:break;case 2:case 3:case 4:case 8:e.roomid===e.real_roomid?MY_API.checkRoom(e.roomid,o):(MY_API.checkRoom(e.roomid,o),MY_API.checkRoom(e.real_roomid,o));break;case 5:break;case 6:window.toast(`监控到房间 ${e.roomid} 的节奏风暴`,"info"),MY_API.Storm.run(e.roomid);break}break;case"SPECIAL_GIFT":if(e.data[39])switch(e.data[39].action){case"start":window.toast(`监控到房间 ${e.roomid} 的节奏风暴`,"info"),MY_API.Storm.run(e.roomid);case"end":}break;default:return}})},()=>{MY_API.chatLog("获取弹幕服务器地址错误","error")})},EntryRoom_list_history:{add:function(e){let t=[];try{t=[...JSON.parse(localStorage.getItem(NAME+"_EntryRoom_list")).list],t.push(e),t.length>100&&t.splice(0,50),localStorage.setItem(NAME+"_EntryRoom_list",JSON.stringify({list:t}))}catch(o){t.push(e),localStorage.setItem(NAME+"_EntryRoom_list",JSON.stringify({list:t}))}},isIn:function(e){let t=[];try{const o=JSON.parse(localStorage.getItem(NAME+"_EntryRoom_list"));return t=null===o?[]:[...o.list],t.indexOf(e)>-1}catch(o){return localStorage.setItem(NAME+"_EntryRoom_list",JSON.stringify({list:t})),MYDEBUG("读取"+NAME+"_EntryRoom_list缓存错误已重置"),t.indexOf(e)>-1}}},RoomId_list:[],err_roomId:[],auto_danmu_list:["(=・ω・=)","（￣▽￣）","nice","666","kksk","(⌒▽⌒)","(｀・ω・´)","╮(￣▽￣)╭","(￣3￣)","Σ( ￣□￣||)","(^・ω・^ )","_(:3」∠)_"],checkRoom:function(e,t="本直播间"){MY_API.blocked||MY_API.max_blocked||MY_API.RoomId_list.indexOf(e)>=0||(MY_API.RoomId_list.push(e),!MY_API.EntryRoom_list_history.isIn(e)&&MY_API.CONFIG.LOTTERY&&(BAPI.room.room_entry_action(e),MY_API.EntryRoom_list_history.add(e)),probability(MY_API.CONFIG.RANDOM_SEND_DANMU)&&BAPI.room.get_info(e).then(t=>{MYDEBUG(`API.room.get_info roomId=${e} res`,t),BAPI.sendLiveDanmu(MY_API.auto_danmu_list[Math.floor(Math.random()*MY_API.auto_danmu_list.length)],t.data.room_id).then(e=>{MYDEBUG("[活跃弹幕]弹幕发送返回信息",e)})}),BAPI.xlive.lottery.check(e).then(o=>{MY_API.RoomId_list.rmVal(e),MYDEBUG("检查房间返回信息",o);const i=o.data;if(0===o.code){if(i.gift){const o=i.gift;for(let i in o)o.hasOwnProperty(i)&&MY_API.creat_join(e,o[i],"gift",t)}if(i.guard){const o=i.guard;for(let i in o)o.hasOwnProperty(i)&&MY_API.creat_join(e,o[i],"guard",t)}if(i.pk){const o=i.pk;for(let i in o)o.hasOwnProperty(i)&&MY_API.creat_join(e,o[i],"pk",t)}}else MY_API.chatLog("[检查房间出错]"+response.msg,"error"),MY_API.err_roomId.indexOf(e)>-1?MYDEBUG(`[检查此房间出错多次]${e}${o.message}`):(MY_API.err_roomId.push(e),MY_API.checkRoom(e,t),MYDEBUG(`[检查房间出错_重试一次]${e}${o.message}`))}))},Id_list_history:{add:function(e,t){const o=[];try{o=[...JSON.parse(localStorage.getItem(`${NAME}_${t}Id_list`)).list],o.push(e),o.length>200&&o.splice(0,50),localStorage.setItem(`${NAME}_${t}Id_list`,JSON.stringify({list:o})),MYDEBUG(`${NAME}_${t}Id_list_add`,o)}catch(i){o.push(e),localStorage.setItem(`${NAME}_${t}Id_list`,JSON.stringify({list:o}))}},isIn:function(e,t){let o=[];try{const i=JSON.parse(localStorage.getItem(`${NAME}_${t}Id_list`));return o=null===i?[]:[...i.list],MYDEBUG(`${NAME}_${t}Id_list_read`,i),o.indexOf(e)>-1}catch(i){return localStorage.setItem(`${NAME}_${t}Id_list`,JSON.stringify({list:o})),MYDEBUG(`读取${NAME}_${t}Id_list缓存错误已重置`),o.indexOf(e)>-1}}},raffleId_list:[],guardId_list:[],pkId_list:[],creat_join:function(e,t,o,i="本直播间"){switch(MYDEBUG("礼物信息",t),o){case"gift":if(MY_API.Id_list_history.isIn(t.raffleId,"raffle"))return void MYDEBUG("礼物重复","raffleId "+t.raffleId);MY_API.raffleId_list.push(t.raffleId),MY_API.Id_list_history.add(t.raffleId,"raffle");break;case"guard":if(MY_API.Id_list_history.isIn(t.id,"guard"))return void MYDEBUG("舰长重复","id "+t.id);MY_API.guardId_list.push(t.id),MY_API.Id_list_history.add(t.id,"guard");break;case"pk":if(MY_API.Id_list_history.isIn(t.id,"pk"))return void MYDEBUG("pk重复","id "+t.id);MY_API.pkId_list.push(t.id),MY_API.Id_list_history.add(t.id,"pk");break}let r=t.time_wait||0;MY_API.CONFIG.RANDOM_DELAY&&(r+=Math.floor(Math.random()*(MY_API.CONFIG.RND_DELAY_END-MY_API.CONFIG.RND_DELAY_START+1))+MY_API.CONFIG.RND_DELAY_START);let a=$("<div class='chatLogLottery'>"),n=$("<div class='chatLogMsg'>"),l=$("<div>"),s=new Date;n.text(`[${i}]`+t.thank_text.split("<%")[1].split("%>")[0]+t.thank_text.split("%>")[1]),a.text(s.toLocaleString()),a.append(n),l.css("color","red"),l.text("等待抽奖"),n.append(l),JQmenuWindow.append(a),layerLogWindow_ScrollY>=layerLogWindow_ScrollHeight&&layerLogWindow.scrollTop(layerLogWindow.prop("scrollHeight"));let _=setInterval(()=>{if(l.text(`等待抽奖倒计时${r}秒`),r<=0){if(probability(MY_API.CONFIG.RANDOM_SKIP))l.text("跳过此礼物抽奖");else switch(l.text("进行抽奖..."),o){case"gift":MY_API.gift_join(e,t.raffleId,t.type).then((function(e,o){l.text(e),MY_API.raffleId_list.rmVal(t.raffleId)}));break;case"guard":MY_API.guard_join(e,t.id).then((function(e,o){l.text(e),MY_API.guardId_list.rmVal(t.id)}));break;case"pk":MY_API.pk_join(e,t.id).then((function(e,o){l.text(e),MY_API.pkId_list.rmVal(t.id)}));break}l.css("color","green"),clearInterval(_)}r--},1e3)},gift_join:function(e,t,o){return BAPI.Lottery.Gift.join(e,t,o).then(i=>{let r=$.Deferred();switch(MYDEBUG("抽奖返回信息",i),i.code){case 0:i.data.award_text?r.resolve(i.data.award_text,i.data.award_num):r.resolve(i.data.award_name+"X"+i.data.award_num.toString(),i.data.award_num);break;default:i.msg.indexOf("拒绝")>-1?(MY_API.blocked=!0,r.resolve("访问被拒绝，您的帐号可能已经被关小黑屋，已停止")):r.resolve(`[礼物抽奖](roomid=${e},id=${t},type=${o})${i.msg}`);break}return r})},guard_join:function(e,t){return BAPI.Lottery.Guard.join(e,t).then(o=>{MYDEBUG("上船抽奖返回信息",o);let i=$.Deferred();switch(o.code){case 0:o.data.award_text?i.resolve(o.data.award_text,o.data.award_num):i.resolve(o.data.award_name+"X"+o.data.award_num.toString(),o.data.award_num);break;default:o.msg.indexOf("拒绝")>-1?(MY_API.blocked=!0,i.resolve("访问被拒绝，您的帐号可能已经被关小黑屋，已停止")):i.resolve(`[上船](roomid=${e},id=${t})${o.msg}`);break}return i})},pk_join:function(e,t){return BAPI.Lottery.Pk.join(e,t).then(o=>{MYDEBUG("PK抽奖返回信息",o);let i=$.Deferred();switch(o.code){case 0:o.data.award_text?i.resolve(o.data.award_text,o.data.award_num):i.resolve(o.data.award_name+"X"+o.data.award_num.toString(),o.data.award_num);break;case-1:i.resolve(o.message);break;case-2:i.resolve(o.message);break;default:o.msg.indexOf("拒绝")>-1?(MY_API.blocked=!0,i.resolve("访问被拒绝，您的帐号可能已经被关小黑屋，已停止")):i.resolve(`[PK](roomid=${e},id=${t})${o.msg}`);break}return i})},GroupSign:{getGroups:()=>BAPI.Group.my_groups().then(e=>(MYDEBUG("GroupSign.getGroups: API.Group.my_groups",e),0===e.code?$.Deferred().resolve(e.data.list):(window.toast("[自动应援团签到]'"+e.msg,"caution"),$.Deferred().reject())),()=>(window.toast("[自动应援团签到]获取应援团列表失败，请检查网络","error"),delayCall(()=>MY_API.GroupSign.getGroups()))),signInList:(e,t=0)=>{if(t>=e.length)return $.Deferred().resolve();const o=e[t];return o.owner_uid==Live_info.uid?MY_API.GroupSign.signInList(e,t+1):BAPI.Group.sign_in(o.group_id,o.owner_uid).then(i=>{MYDEBUG("GroupSign.signInList: API.Group.sign_in",i);let r=$.Deferred();return 0!==i.code?(window.toast("[自动应援团签到]'"+i.msg,"caution"),$.Deferred().reject()):(i.data.add_num>0?(window.toast(`[自动应援团签到]应援团(group_id=${o.group_id},owner_uid=${o.owner_uid})签到成功，当前勋章亲密度+${i.data.add_num}`,"success"),r.resolve()):0==i.data.add_num?(window.toast(`[自动应援团签到]应援团(group_id=${o.group_id},owner_uid=${o.owner_uid})已签到`,"caution"),r.resolve()):r.reject(),$.when(MY_API.GroupSign.signInList(e,t+1),r))},()=>(window.toast(`[自动应援团签到]应援团(group_id=${o.group_id},owner_uid=${o.owner_uid})签到失败，请检查网络`,"error"),delayCall(()=>MY_API.GroupSign.signInList(e,t))))},run:()=>{try{return MY_API.CONFIG.AUTO_GROUP_SIGN?checkNewDay(MY_API.CACHE.AUTO_GROUP_SIGH_TS)?(new Date).getHours()<8&&0!=MY_API.CACHE.AUTO_GROUP_SIGH_TS?(setTimeout(MY_API.GroupSign.run,getIntervalTime(8,0)),$.Deferred().resolve()):MY_API.GroupSign.getGroups().then(e=>MY_API.GroupSign.signInList(e).then(()=>(MY_API.CACHE.AUTO_GROUP_SIGH_TS=ts_ms(),MY_API.saveCache(),runTomorrow(MY_API.GroupSign.run,8,0,"应援团签到"),$.Deferred().resolve()),()=>delayCall(()=>MY_API.GroupSign.run())),()=>delayCall(()=>MY_API.GroupSign.run())):(runTomorrow(MY_API.GroupSign.run,8,0,"应援团签到"),$.Deferred().resolve()):$.Deferred().resolve()}catch(e){return window.toast("[自动应援团签到]运行时出现异常，已停止","error"),MYERROR("自动应援团签到出错",e),$.Deferred().reject()}}},DailyReward:{coin_exp:0,login:()=>BAPI.DailyReward.login().then(()=>{MYDEBUG("DailyReward.login: API.DailyReward.login"),window.toast("[自动每日奖励][每日登录]完成","success")},()=>(window.toast("[自动每日奖励][每日登录]完成失败，请检查网络","error"),delayCall(()=>MY_API.DailyReward.login()))),watch:(e,t)=>MY_API.CONFIG.WATCH?BAPI.DailyReward.watch(e,t,Live_info.uid,ts_s()).then(t=>{MYDEBUG("DailyReward.watch: API.DailyReward.watch",t),0===t.code?window.toast(`[自动每日奖励][每日观看]完成(av=${e})`,"success"):window.toast("[自动每日奖励][每日观看]'"+t.msg,"caution")},()=>(window.toast("[自动每日奖励][每日观看]完成失败，请检查网络","error"),delayCall(()=>MY_API.DailyReward.watch(e,t)))):$.Deferred().resolve(),coin:(e,t,o=0,i=!1)=>{if(!MY_API.CONFIG.COIN)return $.Deferred().resolve();if(MY_API.DailyReward.coin_exp>=10*MY_API.CONFIG.COIN_NUMBER)return window.toast("[自动每日奖励][每日投币]今日投币已完成","info"),$.Deferred().resolve();if(o>=e.length)return window.toast("[自动每日奖励][每日投币]动态里可投币的视频不足","caution"),$.Deferred().resolve();const r=JSON.parse(e[o].card);let a=Math.min(2,t);return i&&(a=1),BAPI.x.getCoinInfo("","jsonp",r.aid,ts_ms()).then(n=>2===n.data.multiply?(MYDEBUG("API.x.getCoinInfo","已投币两个 aid = "+r.aid),MY_API.DailyReward.coin(vlist,t,o+1)):(1===n.data.multiply&&(a=1),BAPI.DailyReward.coin(r.aid,a).then(n=>(MYDEBUG("DailyReward.coin: API.DailyReward.coin",n),0===n.code?(MY_API.DailyReward.coin_exp+=10*a,window.toast(`[自动每日奖励][每日投币]投币成功(av=${r.aid},num=${a})`,"success"),MY_API.DailyReward.coin(e,t-a,o+1)):-110===n.code?(window.toast("[自动每日奖励][每日投币]未绑定手机，已停止","error"),$.Deferred().reject()):34003===n.code?i?MY_API.DailyReward.coin(e,t,o+1):MY_API.DailyReward.coin(e,t,o,!0):34005===n.code?MY_API.DailyReward.coin(e,t,o+1):-104===n.code?(window.toast("[自动每日奖励][每日投币]剩余硬币不足，已停止","warning"),$.Deferred().reject()):(window.toast("[自动每日奖励][每日投币]'"+n.msg,"caution"),MY_API.DailyReward.coin(e,t,o+1))),()=>delayCall(()=>MY_API.DailyReward.coin(e,t,o)))))},coin_uid:(e,t,o,i,r=0,a=!1)=>{if(!MY_API.CONFIG.COIN)return $.Deferred().resolve();if(MY_API.DailyReward.coin_exp>=10*MY_API.CONFIG.COIN_NUMBER)return window.toast("[自动每日奖励][每日投币]今日投币已完成","info"),$.Deferred().resolve();if(r>=e.length)return MY_API.DailyReward.UserSpace(i,30,0,o+1,"","pubdate","jsonp");const n=e[r],l=MY_API.CONFIG.COIN_UID[i];if(n.hasOwnProperty("is_union_video")&&1===n.is_union_video&&n.mid!=l)return MYDEBUG("DailyReward.coin_uid","联合投稿且UP不是指定UID用户 aid = "+n.aid),MY_API.DailyReward.coin_uid(e,t,o,i,r+1);let s=Math.min(2,t);return a&&(s=1),BAPI.x.getCoinInfo("","jsonp",n.aid,ts_ms()).then(l=>2===l.data.multiply?(MYDEBUG("API.x.getCoinInfo","已投币两个 aid = "+n.aid),MY_API.DailyReward.coin_uid(e,t,o,i,r+1)):(1===l.data.multiply&&(s=1),BAPI.DailyReward.coin(n.aid,s).then(l=>(MYDEBUG("DailyReward.coin_uid: API.DailyReward.coin_uid",l),0===l.code?(MY_API.DailyReward.coin_exp+=10*s,window.toast(`[自动每日奖励][每日投币]投币成功(av=${n.aid},num=${s})`,"success"),MY_API.DailyReward.coin_uid(e,t-s,o,i,r+1)):-110===l.code?(window.toast("[自动每日奖励][每日投币]未绑定手机，已停止","error"),$.Deferred().reject()):34003===l.code?a?MY_API.DailyReward.coin_uid(e,t,o,i,r+1):MY_API.DailyReward.coin_uid(e,t,r,o,i,!0):34005===l.code?MY_API.DailyReward.coin_uid(e,t,o,i,r+1):-104===l.code?(window.toast("[自动每日奖励][每日投币]剩余硬币不足，已停止","warning"),$.Deferred().reject()):(window.toast("[自动每日奖励][每日投币]'"+l.msg,"caution"),MY_API.DailyReward.coin_uid(e,t,o,i,r+1))),()=>delayCall(()=>MY_API.DailyReward.coin_uid(e,t,o,i,r)))))},share:e=>MY_API.CONFIG.SHARE?BAPI.DailyReward.share(e).then(t=>{MYDEBUG("DailyReward.share: API.DailyReward.share",t),0===t.code?window.toast(`[自动每日奖励][每日分享]分享成功(av=${e})`,"success"):71e3===t.code?window.toast("[自动每日奖励][每日分享]今日分享已完成","info"):window.toast("[自动每日奖励][每日分享]'"+t.msg,"caution")},()=>(window.toast("[自动每日奖励][每日分享]分享失败，请检查网络","error"),delayCall(()=>MY_API.DailyReward.share(e)))):$.Deferred().resolve(),dynamic:async()=>{const e=MY_API.CONFIG.COIN_NUMBER-MY_API.DailyReward.coin_exp/10,t=await BAPI.getuserinfo().then(t=>(MYDEBUG("DailyReward.dynamic: API.getuserinfo",t),t.data.biliCoin<e?t.data.biliCoin:e));return t<e&&window.toast(`[自动每日奖励][每日投币]剩余硬币不足，仅能投${t}个币`,"warning"),BAPI.dynamic_svr.dynamic_new(Live_info.uid,8).then(e=>{if(MYDEBUG("DailyReward.dynamic: API.dynamic_svr.dynamic_new",e),0===e.code){if(e.data.cards){const o=JSON.parse(e.data.cards[0].card),i=MY_API.DailyReward.watch(o.aid,o.cid);let r;r=0==MY_API.CONFIG.COIN_UID||"COIN_DYN"==MY_API.CONFIG.COIN_TYPE?MY_API.DailyReward.coin(e.data.cards,Math.max(t,0)):MY_API.DailyReward.UserSpace(0,30,0,1,"","pubdate","jsonp");const a=MY_API.DailyReward.share(o.aid);return $.when(i,r,a)}window.toast('[自动每日奖励]"动态-投稿视频"中暂无动态',"info")}else window.toast('[自动每日奖励]获取"动态-投稿视频"\''+e.msg,"caution")},()=>(window.toast('[自动每日奖励]获取"动态-投稿视频"失败，请检查网络',"error"),delayCall(()=>MY_API.DailyReward.dynamic())))},UserSpace:(e,t,o,i,r,a,n)=>BAPI.x.getUserSpace(MY_API.CONFIG.COIN_UID[e],t,o,i,r,a,n).then(t=>{if(MYDEBUG("DailyReward.UserSpace: API.dynamic_svr.UserSpace",t),0===t.code){if(t.data.list.vlist){const o=MY_API.CONFIG.COIN_NUMBER-MY_API.DailyReward.coin_exp/10;return MY_API.DailyReward.coin_uid(t.data.list.vlist,Math.max(o,0),i,e)}if(e<MY_API.CONFIG.COIN_UID.length-1){const o=MY_API.CONFIG.COIN_NUMBER-MY_API.DailyReward.coin_exp/10;return MY_API.DailyReward.coin_uid(t.data.list.vlist,Math.max(o,0),i,e+1)}window.toast(`[自动每日奖励]"UID = ${String(MY_API.CONFIG.COIN_UID)}的空间-投稿视频"中暂无视频`,"info")}else window.toast(`[自动每日奖励]获取UID = ${MY_API.CONFIG.COIN_UID[e]}的"空间-投稿视频"'${t.msg}`,"caution")},()=>(window.toast('[自动每日奖励]获取"空间-投稿视频"失败，请检查网络',"error"),delayCall(()=>MY_API.DailyReward.UserSpace(uid,t,o,i,r,a,n)))),run:(e=!1)=>{try{return MY_API.CONFIG.LOGIN||MY_API.CONFIG.COIN||MY_API.CONFIG.WATCH?checkNewDay(MY_API.CACHE.DailyReward_TS)||e?BAPI.DailyReward.exp().then(e=>{MYDEBUG("DailyReward.run: API.DailyReward.exp",e),0===e.code?(MY_API.DailyReward.coin_exp=e.number,MY_API.DailyReward.login(),MY_API.DailyReward.dynamic(),MY_API.CACHE.DailyReward_TS=ts_ms(),MY_API.saveCache(),runMidnight(MY_API.DailyReward.run,"每日任务")):window.toast("[自动每日奖励]"+e.message,"caution")},()=>(window.toast("[自动每日奖励]获取每日奖励信息失败，请检查网络","error"),delayCall(()=>MY_API.DailyReward.run()))):(runMidnight(()=>MY_API.DailyReward.run(),"每日任务"),$.Deferred().resolve()):$.Deferred().resolve()}catch(e){return window.toast("[自动每日奖励]运行时出现异常","error"),MYERROR("自动每日奖励出错",e),$.Deferred().reject()}}},LiveReward:{dailySignIn:()=>BAPI.xlive.dosign().then(e=>{MYDEBUG("LiveReward.dailySignIn: API.xlive.dosign",e),0===e.code?(window.toast("[自动直播签到]完成","success"),$(".hinter").remove(),$(".checkin-btn").remove()):1011040===e.code?window.toast("[自动直播签到]今日直播签到已完成","info"):(window.toast(`[自动直播签到]${e.message}，尝试点击签到按钮`,"caution"),$(".checkin-btn").click())},()=>(window.toast("[自动直播签到]直播签到失败，请检查网络","error"),delayCall(()=>MY_API.LiveReward.dailySignIn()))),run:()=>{try{if(!MY_API.CONFIG.LIVE_SIGN)return $.Deferred().resolve();if(!checkNewDay(MY_API.CACHE.LiveReward_TS))return runMidnight(MY_API.LiveReward.run,"直播签到"),$.Deferred().resolve();MY_API.LiveReward.dailySignIn(),MY_API.CACHE.LiveReward_TS=ts_ms(),MY_API.saveCache(),runMidnight(MY_API.LiveReward.run,"直播签到")}catch(e){return window.toast("[自动直播签到]运行时出现异常","error"),MYERROR("自动直播签到出错",e),$.Deferred().reject()}}},Exchange:{coin2silver:e=>BAPI.Exchange.coin2silver(e).then(e=>{MYDEBUG("Exchange.coin2silver: API.Exchange.coin2silver",e),0===e.code?window.toast(`[硬币换银瓜子] ${e.msg}，获得${e.data.silver}银瓜子`,"success"):window.toast("[银瓜子换硬币] "+e.msg,"caution")},()=>(window.toast("[硬币换银瓜子] 兑换失败，请检查网络","error"),delayCall(()=>MY_API.Exchange.coin2silver(e)))),silver2coin:()=>BAPI.Exchange.silver2coin().then(e=>{MYDEBUG("Exchange.silver2coin: API.Exchange.silver2coin",e),0===e.code?window.toast("[银瓜子换硬币] "+e.msg,"success"):403===e.code?window.toast("[银瓜子换硬币] "+e.msg,"info"):window.toast("[银瓜子换硬币] "+e.msg,"caution")},()=>(window.toast("[银瓜子换硬币] 兑换失败，请检查网络","error"),delayCall(()=>MY_API.Exchange.silver2coin()))),runC2S:()=>MY_API.CONFIG.COIN2SILVER?checkNewDay(MY_API.CACHE.Coin2Sliver_TS)?MY_API.Exchange.coin2silver(MY_API.CONFIG.COIN2SILVER_NUM).then(()=>{MY_API.CACHE.Coin2Sliver_TS=ts_ms(),MY_API.saveCache(),runMidnight(MY_API.Exchange.runC2S,"硬币换瓜子")},()=>delayCall(()=>MY_API.Exchange.runC2S())):(runMidnight(MY_API.Exchange.runC2S,"硬币换瓜子"),$.Deferred().resolve()):$.Deferred().resolve(),runS2C:()=>{try{return MY_API.CONFIG.SILVER2COIN?checkNewDay(MY_API.CACHE.Silver2Coin_TS)?MY_API.Exchange.silver2coin().then(()=>{MY_API.CACHE.Silver2Coin_TS=ts_ms(),MY_API.saveCache(),runMidnight(MY_API.Exchange.runS2C,"瓜子换硬币")},()=>delayCall(()=>MY_API.Exchange.runS2C())):(runMidnight(MY_API.Exchange.runS2C,"瓜子换硬币"),$.Deferred().resolve()):$.Deferred().resolve()}catch(e){return window.toast("[银瓜子换硬币]运行时出现异常，已停止","error"),MYERROR("银瓜子换硬币出错",e),$.Deferred().reject()}}},Gift:{run_timer:void 0,ruid:void 0,room_id:void 0,medal_list:void 0,bag_list:void 0,time:void 0,remain_feed:void 0,over:!1,sendGiftList:void 0,getMedalList:async(e=1)=>(1===e&&(MY_API.Gift.medal_list=[]),BAPI.i.medal(e,25).then(t=>{if(MYDEBUG("Gift.getMedalList: API.i.medal",t),MY_API.Gift.medal_list=MY_API.Gift.medal_list.concat(t.data.fansMedalList),t.data.pageinfo.curPage<t.data.pageinfo.totalpages)return MY_API.Gift.getMedalList(e+1)},()=>(window.toast("[自动送礼]获取勋章列表失败，请检查网络","error"),delayCall(()=>MY_API.Gift.getMedalList())))),getBagList:async()=>BAPI.gift.bag_list().then(e=>{MYDEBUG("Gift.getBagList: API.gift.bag_list",e),MY_API.Gift.bag_list=e.data.list,MY_API.Gift.time=e.data.time},()=>(window.toast("[自动送礼]获取包裹列表失败，请检查网络","error"),delayCall(()=>MY_API.Gift.getBagList()))),getFeedByGiftID:e=>{if(30607===e)return 50;for(let t=Live_info.gift_list.length-1;t>=0;--t)if(Live_info.gift_list[t].id===e)return Math.ceil(Live_info.gift_list[t].price/100);return 0},sort_medals:e=>{if("GIFT_SORT_HIGH"==MY_API.CONFIG.GIFT_SORT?e.sort((e,t)=>t.level-e.level==0?t.intimacy-e.intimacy:t.level-e.level):e.sort((e,t)=>e.level-t.level==0?e.intimacy-t.intimacy:e.level-t.level),MY_API.CONFIG.AUTO_GIFT_ROOMID){let t=[...MY_API.CONFIG.AUTO_GIFT_ROOMID];t.reverse();for(let o of t){let t=e.findIndex(e=>e.roomid==o);if(-1!=t){let o=e[t];e.splice(t,1),e.unshift(o)}}}return e},auto_light:async e=>{try{const t=MY_API.Gift.getFeedByGiftID(30607);let o=MY_API.CONFIG.LIGHT_MEDALS,i=void 0;if(i="LIGHT_WHITE"==MY_API.CONFIG.LIGHT_METHOD?e.filter(e=>0===e.is_lighted&&e.day_limit-e.today_feed>=t&&o.findIndex(t=>t==e.roomid)>=0):e.filter(e=>0===e.is_lighted&&e.day_limit-e.today_feed>=t&&-1===o.findIndex(t=>t==e.roomid)),MYDEBUG("[auto_light]即将点亮勋章房间列表",i),i&&i.length>0){i=MY_API.Gift.sort_medals(i),await MY_API.Gift.getBagList();let e=MY_API.Gift.bag_list.filter(e=>30607===e.gift_id);if(e&&e.length>0)for(let o of i){let i=e.find(e=>30607===e.gift_id&&e.gift_num>0);if(!i)break;{let e=o.day_limit-o.today_feed;if(e>=t||MY_API.CONFIG.FORCE_LIGHT){let r=await BAPI.room.room_init(parseInt(o.roomid,10)),a=parseInt(r.data.room_id,10),n=1,l=await BAPI.gift.bag_send(Live_info.uid,30607,o.target_id,n,i.bag_id,a,Live_info.rnd);0===l.code?(i.gift_num-=n,o.today_feed+=n*t,e-=n*t,window.toast(`[自动送礼]勋章[${o.medalName}]点亮成功，送出${n}个${i.gift_name}，[${o.today_feed}/${o.day_limit}]距离升级还需[${e}]`,"success"),MYDEBUG("Gift.auto_light",`勋章[${o.medalName}]点亮成功，送出${n}个${i.gift_name}，[${o.today_feed}/${o.day_limit}]`)):window.toast(`[自动送礼]勋章[${o.medalName}]点亮失败【${l.msg}】`,"caution")}}}}}catch(e){console.error(e),window.toast("[自动送礼]点亮勋章出错:"+e,"error")}},run:async()=>{try{if(!MY_API.CONFIG.AUTO_GIFT)return $.Deferred().resolve();if(medalDanmuRunning)return window.toast("[自动送礼]【粉丝牌打卡】任务运行中，暂停运行，30秒后再次检查","warning"),setTimeout(()=>MY_API.Gift.run(),3e4);if(MY_API.Gift.run_timer&&clearTimeout(MY_API.Gift.run_timer),!("GIFT_SEND_TIME"!=MY_API.CONFIG.GIFT_METHOD||isTime(MY_API.CONFIG.GIFT_SEND_HOUR,MY_API.CONFIG.GIFT_SEND_MINUTE)||SEND_GIFT_NOW||LIGHT_MEDAL_NOW)){let e=getIntervalTime(MY_API.CONFIG.GIFT_SEND_HOUR,MY_API.CONFIG.GIFT_SEND_MINUTE);MY_API.Gift.run_timer=setTimeout(()=>MY_API.Gift.run(),e);let t=new Date(ts_ms()+e).toLocaleString();return MYDEBUG("[自动送礼]",`将在${t}进行自动送礼`),$.Deferred().resolve()}if("GIFT_INTERVAL"==MY_API.CONFIG.GIFT_METHOD&&!SEND_GIFT_NOW&&!LIGHT_MEDAL_NOW){let e=6e4*MY_API.CONFIG.GIFT_INTERVAL;if(MY_API.CACHE.GiftInterval_TS){const t=ts_ms()-MY_API.CACHE.GiftInterval_TS;if(t<e){let o=e-t;return MY_API.Gift.run_timer=setTimeout(MY_API.Gift.run,o),MYDEBUG("[自动送礼]",`将在${o}毫秒后进行自动送礼`),$.Deferred().resolve()}}else MY_API.CACHE.GiftInterval_TS=ts_ms(),MY_API.saveCache()}MY_API.Gift.over=!1,(()=>{MY_API.Gift.sendGiftList=MY_API.CONFIG.GIFT_ALLOW_TYPE,MYDEBUG("[自动送礼]","处理前的礼物列表 "+MY_API.Gift.sendGiftList);for(let e=0;e<MY_API.Gift.sendGiftList.length;e++){const t=MY_API.Gift.sendGiftList[e];let o;isNaN(t)&&(o=Live_info.gift_list.find(e=>e.name===t),o&&(MY_API.Gift.sendGiftList[e]=String(o.id)))}MYDEBUG("[自动送礼]","处理后得到的礼物id列表 "+MY_API.Gift.sendGiftList)})(),await MY_API.Gift.getMedalList();let e=MY_API.Gift.medal_list;if(MYDEBUG("Gift.run: Gift.getMedalList().then: Gift.medal_list",e),e&&e.length>0){if(e=e.filter(e=>e.day_limit-e.today_feed>0&&e.level<20),e=MY_API.Gift.sort_medals(e),MY_API.CONFIG.EXCLUDE_ROOMID){const t=MY_API.CONFIG.EXCLUDE_ROOMID;e=e.filter(e=>-1==t.findIndex(t=>t==e.roomid))}if(await MY_API.Gift.auto_light(e),LIGHT_MEDAL_NOW)return LIGHT_MEDAL_NOW=!1,$.Deferred().resolve();for(let t of e){if(MY_API.Gift.over)break;let e=await BAPI.room.room_init(parseInt(t.roomid,10));MY_API.Gift.room_id=parseInt(e.data.room_id,10),MY_API.Gift.ruid=t.target_id,MY_API.Gift.remain_feed=t.day_limit-t.today_feed,MY_API.Gift.remain_feed>0&&(await MY_API.Gift.getBagList(),MY_API.Gift.remain_feed>0?(window.toast(`[自动送礼]勋章[${t.medalName}] 今日亲密度未满[${t.today_feed}/${t.day_limit}]，预计需要[${MY_API.Gift.remain_feed}]送礼开始`,"info"),await MY_API.Gift.sendGift(t)):window.toast(`[自动送礼]勋章[${t.medalName}] 今日亲密度已满`,"info"))}}await MY_API.Gift.sendRemainGift(MY_API.CONFIG.SPARE_GIFT_ROOM)}catch(e){return window.toast("[自动送礼]送礼失败，请检查网络","error"),delayCall(()=>MY_API.Gift.run()),window.toast("[自动送礼]运行时出现异常，已停止","error"),MYERROR("自动送礼出错",e),$.Deferred().reject()}return SEND_GIFT_NOW=!1,(()=>{if("GIFT_SEND_TIME"==MY_API.CONFIG.GIFT_METHOD){let e=getIntervalTime(MY_API.CONFIG.GIFT_SEND_HOUR,MY_API.CONFIG.GIFT_SEND_MINUTE);MY_API.Gift.run_timer=setTimeout(()=>MY_API.Gift.run(),e);let t=new Date(ts_ms()+e).toLocaleString();MYDEBUG("[自动送礼]",`将在${t}进行自动送礼`),MY_API.CACHE.Gift_TS=ts_ms(),MY_API.saveCache()}else{let e=60*MY_API.CONFIG.GIFT_INTERVAL*1e3;MY_API.Gift.run_timer=setTimeout(()=>MY_API.Gift.run(),e),MYDEBUG("[自动送礼]",`将在${MY_API.CONFIG.GIFT_INTERVAL}分钟后进行自动送礼`),MY_API.CACHE.GiftInterval_TS=ts_ms(),MY_API.saveCache()}})(),$.Deferred().resolve()},sendGift:async e=>{let t;if(await MY_API.Gift.getBagList(),MY_API.Gift.remain_feed<=0)return window.toast(`[自动送礼]勋章[${e.medalName}] 送礼结束，今日亲密度已满[${e.today_feed}/${e.day_limit}]`,"info"),$.Deferred().resolve();if(MY_API.Gift.time<=0&&(MY_API.Gift.time=ts_s()),MY_API.CONFIG.SEND_ALL_GIFT){let e=MY_API.Gift.bag_list.filter(e=>e.gift_num>0&&"永久"!=e.corner_mark);if(0==e.length)return void(MY_API.Gift.over=!0);t=e}else{let e=MY_API.Gift.bag_list.filter(e=>MY_API.Gift.sendGiftList.includes(String(e.gift_id))&&e.gift_num>0&&e.corner_mark.substring(0,e.corner_mark.indexOf("天"))<=MY_API.CONFIG.GIFT_LIMIT);if(MYDEBUG("[自动送礼]pass的礼物",e),0==e.length)return void(MY_API.Gift.over=!0);t=e}MYDEBUG("bag_list",t);for(let o of t){if(e.day_limit-e.today_feed<=0)return void window.toast(`[自动送礼]勋章[${e.medalName}] 送礼结束，今日亲密度已满[${e.today_feed}/${e.day_limit}]`,"info");let t=MY_API.Gift.getFeedByGiftID(o.gift_id);if(t>0){let i=Math.floor(MY_API.Gift.remain_feed/t);i>o.gift_num&&(i=o.gift_num),i>0&&(MYDEBUG("[自动送礼]送出礼物类型",o.gift_name),await BAPI.gift.bag_send(Live_info.uid,o.gift_id,MY_API.Gift.ruid,i,o.bag_id,MY_API.Gift.room_id,Live_info.rnd).then(r=>{MYDEBUG("Gift.sendGift: API.gift.bag_send",r),0===r.code?(o.gift_num-=i,e.today_feed+=i*t,MY_API.Gift.remain_feed-=i*t,window.toast(`[自动送礼]勋章[${e.medalName}] 送礼成功，送出${i}个${o.gift_name}，[${e.today_feed}/${e.day_limit}]距离今日亲密度上限还需[${MY_API.Gift.remain_feed}]`,"success")):window.toast(`[自动送礼]勋章[${e.medalName}] 送礼异常:${r.msg}`,"caution")},()=>(window.toast("[自动送礼]包裹送礼失败，请检查网络","error"),delayCall(()=>MY_API.Gift.sendGift(e)))))}}},sendRemainGift:async e=>{if(0==e)return $.Deferred().resolve();let t,o=void 0;if(await BAPI.live_user.get_anchor_in_room(e).then(e=>{if(MYDEBUG("API.live_user.get_anchor_in_room",e),!e.data.info.uid)return window.toast("[自动送礼]【剩余礼物】检查房间出错"),$.Deferred().reject();o=e.data.info.uid}),await MY_API.Gift.getBagList(),MY_API.Gift.time<=0&&(MY_API.Gift.time=ts_s()),MY_API.CONFIG.SEND_ALL_GIFT){let e=MY_API.Gift.bag_list.filter(e=>e.gift_num>0&&"永久"!=e.corner_mark);if(0==e.length)return void(MY_API.Gift.over=!0);t=e}else{let e=MY_API.Gift.bag_list.filter(e=>MY_API.Gift.sendGiftList.includes(String(e.gift_id))&&e.gift_num>0&&"1天"==e.corner_mark);if(0==e.length)return void(MY_API.Gift.over=!0);t=e}MYDEBUG("[自动送礼]【剩余礼物】bag_list",t);for(let i of t){if(MY_API.Gift.getFeedByGiftID(i.gift_id)>0){let t=i.gift_num;t>0&&await BAPI.gift.bag_send(Live_info.uid,i.gift_id,o,t,i.bag_id,e,Live_info.rnd).then(o=>{MYDEBUG("Gift.sendGift: API.gift.bag_send",o),0===o.code?(i.gift_num-=t,window.toast(`[自动送礼]【剩余礼物】房间[${e}] 送礼成功，送出${t}个${i.gift_name}`,"success")):window.toast(`[自动送礼]【剩余礼物】房间[${e}] 送礼异常:${o.msg}`,"caution")},()=>(window.toast("[自动送礼]【剩余礼物】包裹送礼失败，请检查网络","error"),delayCall(()=>MY_API.Gift.sendGift(medal))))}}}},stormQueue:[],stormBlack:!1,stormIdSet:{add:function(e){let t=[];try{t=[...JSON.parse(localStorage.getItem(NAME+"stormIdSet")).list],t.push(e),t.length>50&&t.splice(0,10),localStorage.setItem(NAME+"stormIdSet",JSON.stringify({list:t})),MYDEBUG(NAME+"storm_Id_list_add",t)}catch(o){t.push(e),localStorage.setItem(NAME+"stormIdSet",JSON.stringify({list:t}))}},isIn:function(e){let t=[];try{const o=JSON.parse(localStorage.getItem(NAME+"stormIdSet"));return t=null===o?[]:[...o.list],MYDEBUG(NAME+"storm_Id_list_read",o),t.indexOf(e)>-1}catch(o){return localStorage.setItem(NAME+"stormIdSet",JSON.stringify({list:t})),MYDEBUG("读取"+NAME+"stormIdSet缓存错误已重置"),t.indexOf(e)>-1}}},Storm:{check:e=>MY_API.stormQueue.indexOf(e)>-1,append:e=>{MY_API.stormQueue.push(e),MY_API.stormQueue.length>MY_API.CONFIG.STORM_QUEUE_SIZE&&MY_API.stormQueue.shift()},over:e=>{MY_API.stormQueue.indexOf(e)>-1&&MY_API.stormQueue.splice(e,1)},run:e=>{try{return MY_API.CONFIG.STORM?MY_API.stormBlack?$.Deferred().resolve():BAPI.Storm.check(e).then(t=>{if(MYDEBUG("MY_API.Storm.run: MY_API.API.Storm.check",t),0===t.code){let e=t.data;return MY_API.Storm.join(e.id,e.roomid,Math.round((new Date).getTime()/1e3)+e.time),$.Deferred().resolve()}window.toast(`[自动抽奖][节奏风暴](roomid=${e})${t.msg}`,"caution")},()=>{window.toast(`[自动抽奖][节奏风暴]检查直播间(${e})失败，请检查网络`,"error")}):$.Deferred().resolve()}catch(e){return window.toast("[自动抽奖][节奏风暴]运行时出现异常","error"),MYERROR("节奏风暴出错",e),$.Deferred().reject()}},join:(e,t,o)=>{if(t=parseInt(t,10),e=parseInt(e,10),isNaN(t)||isNaN(e))return $.Deferred().reject();let i=Math.round(e/1e6);if(MY_API.stormIdSet.isIn(i))return $.Deferred().resolve();if(MY_API.stormIdSet.add(i),MY_API.Storm.check(e))return;MY_API.Storm.append(e);let r=0;o<=0&&(o=Math.round((new Date).getTime()/1e3)+90);let a=0;return window.toast(`[自动抽奖][节奏风暴]尝试抽奖(roomid=${t},id=${e})`,"success"),r=setInterval(()=>async function(){try{if(!MY_API.Storm.check(e))return void clearInterval(r);let i,n=Math.round((new Date).getTime()/1e3);if(n>o&&o>0)return MY_API.Storm.over(e),void clearInterval(r);if(a++,a>MY_API.CONFIG.STORM_MAX_COUNT&&MY_API.CONFIG.STORM_MAX_COUNT>0)return MY_API.Storm.over(e),clearInterval(r),void window.toast(`[自动抽奖][节奏风暴]抽奖(roomid=${t},id=${e})到达尝试次数。\r\n尝试次数:${a},距离到期:${o-n}s`,"caution");try{if(i=userToken&&appToken&&tokenData.access_token?await BAPI.Storm.join_ex(e,t,tokenData.access_token,BilibiliToken.appKey,BilibiliToken.headers):await BAPI.Storm.join(e,captcha_token="",captcha_phrase="",t),MYDEBUG("MY_API.Storm.join: MY_API.API.Storm.join",i),!i.code)return MY_API.Storm.over(e),Statistics.appendGift(i.data.gift_name,i.data.gift_num),window.toast(`[自动抽奖][节奏风暴]领取(roomid=${t},id=${e})成功,${i.data.gift_name+"x"+i.data.gift_num}\r\n${i.data.mobile_content}\r\n尝试次数:${a}`,"success"),void clearInterval(r);if(-1!=i.msg.indexOf("领取"))return MY_API.Storm.over(e),clearInterval(r),void window.toast(`[自动抽奖][节奏风暴]领取(roomid=${t},id=${e})成功,${i.msg}\r\n尝试次数:${a}`,"success");if(-1!=i.msg.indexOf("验证码"))return MY_API.Storm.over(e),clearInterval(r),MY_API.stormBlack=!0,void window.toast(`[自动抽奖][节奏风暴]抽奖(roomid=${t},id=${e})失败,疑似账号不支持,${i.msg}`,"caution");if(i.data&&0==i.data.length&&-1!=i.msg.indexOf("下次要更快一点"))return MY_API.Storm.over(e),window.toast(`[自动抽奖][节奏风暴]抽奖(roomid=${t},id=${e})疑似风暴黑屋,终止！`,"error"),clearInterval(r),MY_API.stormBlack=!0,void setTimeout(()=>{MY_API.stormBlack=!1},36e5);if(-1==i.msg.indexOf("下次要更快一点"))return void clearInterval(r)}catch(o){return MY_API.Storm.over(e),window.toast(`[自动抽奖][节奏风暴]抽奖(roomid=${t},id=${e})疑似触发风控,终止！\r\n尝试次数:${a}`,"error"),MYERROR("节奏风暴疑似触发风控","roomid = "+t,"id = "+e,o),void clearInterval(r)}}catch(o){return MY_API.Storm.over(e),window.toast(`[自动抽奖][节奏风暴]抽奖(roomid=${t},id=${e})抽奖异常,终止！`,"error"),MYERROR("节奏风暴抽奖异常","roomid = "+t,"id = "+e,o),void clearInterval(r)}}(),MY_API.CONFIG.STORM_ONE_LIMIT),$.Deferred().resolve()}},LITTLE_HEART:{getInfo:()=>XHR({GM:!0,anonymous:!0,method:"GET",url:"https://passport.bilibili.com/x/passport-login/oauth2/info?"+appToken.signLoginQuery("access_key="+tokenData.access_token),responseType:"json",headers:appToken.headers}),RandomHex:e=>{const t="0123456789abcdef";let o="";o+=t[Math.floor(15*Math.random())+1];for(let i=0;i<e-1;i++)o+=t[Math.floor(16*Math.random())];return o},uuid:()=>MY_API.LITTLE_HEART.RandomHex(32).replace(/(\w{8})(\w{4})\w(\w{3})\w(\w{3})(\w{12})/,`$1-$2-4$3-${"89ab"[Math.floor(4*Math.random())]}$4-$5`),getFansMedal:async()=>{const e=await XHR({GM:!0,anonymous:!0,method:"GET",url:"https://api.live.bilibili.com/fans_medal/v1/FansMedal/get_list_in_room?"+BilibiliToken.signQuery(`access_key=${tokenData.access_token}&target_id=${Live_info.tid}&uid=${Live_info.uid}&${baseQuery}`),responseType:"json",headers:appToken.headers});if(MYDEBUG("[小心心] getFansMedal",e.response),void 0!==e&&200===e.response.status&&0===e.body.code&&e.body.data.length>0)return e.body.data},getGiftNum:async()=>{let e=0;return await BAPI.gift.bag_list().then(t=>{MYDEBUG("[小心心]检查包裹 API.gift.bag_list",t);const o=t.data.list.filter(e=>30607==e.gift_id&&"7天"==e.corner_mark);for(const t of o)e+=t.gift_num}),MYDEBUG("[小心心]检测到包裹内7天小心心数量",e),e},mobileHeartBeat:async e=>{const t=new WasmHash;await t.init();const o=(i=e,t.hash("BLAKE2b512",t.hash("SHA3-384",t.hash("SHA384",t.hash("SHA3-512",t.hash("SHA512",JSON.stringify(i)))))));var i;let r="";for(const t in e)r+=`${t}=${encodeURIComponent(e[t])}&`;r+="client_sign="+o;const a=await XHR({GM:!0,anonymous:!0,method:"POST",url:"https://live-trace.bilibili.com/xlive/data-interface/v1/heartbeat/mobileHeartBeat",data:BilibiliToken.signQuery(`access_key=${tokenData.access_token}&${r}&${baseQuery}`),responseType:"json",headers:appToken.headers});return MYDEBUG("[小心心] mobileHeartBeat",a.response),void 0!==a&&200===a.response.status&&0===a.body.code},run:async()=>{if(!MY_API.CONFIG.LITTLE_HEART)return $.Deferred().resolve();if(!checkNewDay(MY_API.CACHE.LittleHeart_TS))return runMidnight(MY_API.LITTLE_HEART.run,"获取小心心"),$.Deferred().resolve();const e={platform:"android",uuid:MY_API.LITTLE_HEART.uuid(),buvid:appToken.buvid,seq_id:"1",room_id:"{room_id}",parent_id:"6",area_id:"283",timestamp:"{timestamp}",secret_key:"axoaadsffcazxksectbbb",watch_time:"60",up_id:"{target_id}",up_level:"40",jump_from:"30000",gu_id:MY_API.LITTLE_HEART.RandomHex(43),play_type:"0",play_url:"",s_time:"0",data_behavior_id:"",data_source_id:"",up_session:"l:one:live:record:{room_id}:{last_wear_time}",visit_id:MY_API.LITTLE_HEART.RandomHex(32),watch_status:"%7B%22pk_id%22%3A0%2C%22screen_status%22%3A1%7D",click_id:MY_API.LITTLE_HEART.uuid(),session_id:"",player_type:"0",client_ts:"{client_ts}"},t=async(e=!0)=>(e&&await sleep(5e3),!e||await MY_API.LITTLE_HEART.getGiftNum()>=24?(window.toast("[小心心]今日小心心已全部获取","success"),MY_API.CACHE.LittleHeart_TS=ts_ms(),MY_API.saveCache(),runMidnight(MY_API.LITTLE_HEART.run,"获取小心心")):(window.toast("[小心心]小心心未全部获取，60秒后将再次运行","info"),setTimeout(()=>MY_API.LITTLE_HEART.run(),6e4)));if(void 0===await setToken())return;if(!tokenData.access_token&&!tokenData.mid&&!tokenData.refresh_token){const e=await MY_API.LITTLE_HEART.getInfo();if(MYDEBUG("[小心心]userInfo",e),void 0===e)return MYERROR("小心心","获取用户信息错误");if(0!==e.body.code&&void 0===await setToken())return;if(e.body.data.mid!==Live_info.uid&&void 0===await setToken())return}MYDEBUG("[小心心] 开始客户端心跳 tokenData",tokenData.access_token),window.toast("[小心心]开始获取小心心","success");const o=await MY_API.LITTLE_HEART.getGiftNum();if(!(o<24))return t(!1);{const i=await MY_API.LITTLE_HEART.getFansMedal();if(void 0!==i){const r=24-o,a=5*Math.ceil(r/i.length);for(let t=0;t<a;t++){let t=0;for(const o of i){if(t>=r)break;const i=Object.assign({},e,{room_id:o.room_id.toString(),timestamp:(BilibiliToken.TS-60).toString(),up_id:o.target_id.toString(),up_session:`l:one:live:record:${o.room_id}:${o.last_wear_time}`,client_ts:BilibiliToken.TS.toString()});await MY_API.LITTLE_HEART.mobileHeartBeat(i),t++}await sleep(6e4)}return t()}}}},AUTO_DANMU:{setValue:(e,t)=>void 0===MY_API.CONFIG[e][t]&&t>0?MY_API.AUTO_DANMU.setValue(e,t-1):MY_API.CONFIG[e][t],sendDanmu:async(e,t)=>{let o=t;return Number(t)<=1e4&&(o=await BAPI.room.get_info(t).then(e=>(MYDEBUG(`API.room.get_info roomId=${t} res`,e),e.data.room_id))),BAPI.sendLiveDanmu(e,o).then(o=>{MYDEBUG(`[自动发弹幕]弹幕发送内容【${e}】，房间号【${t}】`,o),0===o.code?window.toast(`[自动发弹幕]弹幕【${e}】（房间号【${t}】）发送成功`,"success"):window.toast(`[自动发弹幕]弹幕【${e}】（房间号【${t}】）出错 ${o.msg}`,"caution")},()=>(window.toast(`[自动发弹幕]弹幕【${e}】（房间号【${t}】）发送失败`,"error"),$.Deferred().reject()))},getMaxLength:()=>{let e=void 0;const t=MY_API.CONFIG.DANMU_CONTENT.length,o=MY_API.CONFIG.DANMU_ROOMID.length,i=MY_API.CONFIG.DANMU_INTERVAL_TIME.length;return e=t>=o?t:o,e<i&&(e=i),e},run:async()=>{if(!MY_API.CONFIG.AUTO_DANMU)return $.Deferred().resolve();if(medalDanmuRunning)return window.toast("[自动发弹幕]【粉丝牌打卡】任务运行中，暂停运行，30秒后再次检查","warning"),setTimeout(()=>MY_API.AUTO_DANMU.run(),3e4);if(danmuTaskRunning=!0,SEND_DANMU_NOW){for(let e=0;e<MY_API.CONFIG.DANMU_CONTENT.length;e++){let t=MY_API.AUTO_DANMU.setValue("DANMU_CONTENT",e),o=parseInt(MY_API.AUTO_DANMU.setValue("DANMU_ROOMID",e));await MY_API.AUTO_DANMU.sendDanmu(t,o),await sleep(1e3)}SEND_DANMU_NOW=!1}else{let e=MY_API.AUTO_DANMU.getMaxLength();for(let t=0;t<e;t++){let e=MY_API.AUTO_DANMU.setValue("DANMU_CONTENT",t),o=parseInt(MY_API.AUTO_DANMU.setValue("DANMU_ROOMID",t)),i=MY_API.AUTO_DANMU.setValue("DANMU_INTERVAL_TIME",t),r=void 0,a=MY_API.CACHE.AUTO_SEND_DANMU_TS,n=void 0,l=void 0,s=void 0,_=void 0,d=[],I=0;if(i.indexOf(":")>-1){l=!0;const e=i.split(":"),t=parseInt(e[0]),o=parseInt(e[1]),r=parseInt(e[2]);d=[t,o,r],I=isTime(t,o,r)?864e5:getIntervalTime(t,o,r)}else if(l=!1,i=i.toLowerCase(),i.indexOf("h")>-1||i.indexOf("m")>-1||i.indexOf("s")>-1){const e=i.split("h"),t=void 0===e[1]?e[0].split("m"):e[1].split("m"),o=void 0===t[1]?t[0].split("s"):t[1].split("s"),r=e[0],a=t[0],n=o[0],l=isNaN(r)?0:r||0,s=isNaN(a)?0:a||0,d=isNaN(n)?0:n||0;_=36e5*l+6e4*s+1e3*d}else _=6e4*i;MYDEBUG("[自动发弹幕]MY_API.CACHE.AUTO_SEND_DANMU_TS => jsoncache",a);for(const t of a)if(t.roomid==o&&t.content==e){r=t.sendTs,n=a.indexOf(t);break}l||(s=r?ts_ms()-r:ts_ms());const A=()=>{const t={roomid:o,content:e,sendTs:ts_ms()};return r?a[n].sendTs=ts_ms():a.push(t),MY_API.CACHE.AUTO_SEND_DANMU_TS=a,MY_API.saveCache(!1)},c=(t,i)=>(i||A(),setTimeout(async()=>(await MY_API.AUTO_DANMU.sendDanmu(e,o),i||A(),c(t,i)),t));!l&&s>=_?(await MY_API.AUTO_DANMU.sendDanmu(e,o),MYDEBUG(`[自动发弹幕]弹幕发送内容【${e}】，房间号【${o}】，距下次发送还有`,i),c(_,l)):l&&!I?(await MY_API.AUTO_DANMU.sendDanmu(e,o),MYDEBUG(`[自动发弹幕]弹幕发送内容【${e}】，房间号【${o}】，距下次发送还有`,"24小时"),c(I,l)):(MYDEBUG(`[自动发弹幕]弹幕发送内容【${e}】，房间号【${o}】，距下次发送还有`,(l?I/6e4:(_-s)/6e4)+"分钟"),setTimeout(async()=>{await MY_API.AUTO_DANMU.sendDanmu(e,o),c(l?864e5:_,l)},l?I:_-s)),await sleep(1500)}}danmuTaskRunning=!1}},MEDAL_DANMU:{medal_list:[],getMedalList:async(e=1)=>(1===e&&(MY_API.MEDAL_DANMU.medal_list=[]),BAPI.i.medal(e,25).then(t=>{if(MYDEBUG("MEDAL_DANMU.getMedalList: API.i.medal",t),MY_API.MEDAL_DANMU.medal_list=MY_API.MEDAL_DANMU.medal_list.concat(t.data.fansMedalList),t.data.pageinfo.curPage<t.data.pageinfo.totalpages)return MY_API.MEDAL_DANMU.getMedalList(e+1)},()=>(MY_API.chatLog("[粉丝牌打卡弹幕]<br>获取勋章列表失败，请检查网络","error"),delayCall(()=>MY_API.MEDAL_DANMU.getRoomList())))),sendDanmu:async(e,t,o)=>{let i=t;return Number(t)<=1e4&&(i=await BAPI.room.get_info(t).then(e=>(MYDEBUG(`API.room.get_info roomId=${t} res`,e),e.data.room_id))),BAPI.sendLiveDanmu(e,i).then(i=>(MYDEBUG(`[粉丝牌打卡弹幕] 弹幕发送内容【${e}】，房间号【${t}】，粉丝勋章【${o}】`,i),0===i.code?window.toast(`[粉丝牌打卡弹幕] 弹幕【${e}】发送成功，房间号【${t}】，粉丝勋章【${o}】已点亮，当前亲密度+100`,"success"):window.toast(`[粉丝牌打卡弹幕] 弹幕【${e}】（房间号【${t}】，粉丝勋章【${o}】）出错 ${i.msg}`,"caution")),()=>(window.toast(`[粉丝牌打卡弹幕] 弹幕【${e}】（房间号【${t}】，粉丝勋章【${o}】）发送失败`,"error"),$.Deferred().reject()))},run:async()=>{if(!MY_API.CONFIG.MEDAL_DANMU)return $.Deferred().resolve();if(!checkNewDay(MY_API.CACHE.MedalDanmu_TS))return runMidnight(()=>MY_API.MEDAL_DANMU.run(),"粉丝勋章打卡弹幕"),$.Deferred().resolve();if(danmuTaskRunning)return window.toast("[粉丝牌打卡]【自动发弹幕】任务运行中，暂停运行，30秒后再次检查","warning"),setTimeout(()=>MY_API.MEDAL_DANMU.run(),3e4);let e;medalDanmuRunning=!0,await MY_API.MEDAL_DANMU.getMedalList(),e="MEDAL_DANMU_WHITE"===MY_API.CONFIG.MEDAL_DANMU_METHOD?MY_API.MEDAL_DANMU.medal_list.filter(e=>MY_API.CONFIG.MEDAL_DANMU_ROOM.findIndex(t=>t==e.roomid)>-1):MY_API.MEDAL_DANMU.medal_list.filter(e=>-1===MY_API.CONFIG.MEDAL_DANMU_ROOM.findIndex(t=>t==e.roomid)),MYDEBUG("[粉丝牌打卡] 过滤后的粉丝勋章房间列表",e);let t=0;const o=MY_API.CONFIG.MEDAL_DANMU_CONTENT.length;for(const i of e){t>=o&&(t=0);const e=i.medal_name,r=i.roomid,a=MY_API.CONFIG.MEDAL_DANMU_CONTENT[t];await MY_API.MEDAL_DANMU.sendDanmu(a,r,e),t++,await sleep(1e3*MY_API.CONFIG.MEDAL_DANMU_INTERVAL)}return medalDanmuRunning=!1,window.toast("[粉丝牌打卡弹幕] 今日已完成","success"),MY_API.CACHE.MedalDanmu_TS=ts_ms(),MY_API.saveCache(),runMidnight(MY_API.MEDAL_DANMU.run,"粉丝勋章打卡弹幕")}},MaterialObject:{list:[],firstAid:void 0,run:()=>{try{if(!MY_API.CONFIG.MATERIAL_LOTTERY)return $.Deferred().resolve();if(MY_API.CACHE.MaterialObject_TS){const e=ts_ms()-MY_API.CACHE.MaterialObject_TS,t=6e4*MY_API.CONFIG.MATERIAL_LOTTERY_CHECK_INTERVAL||6e5;if(e<t)return MYDEBUG("[实物抽奖]",t-e+"毫秒后再次运行"),setTimeout(MY_API.MaterialObject.run,t-e),$.Deferred().resolve()}return MY_API.chatLog("[实物抽奖] 开始寻找可参加的抽奖"),MY_API.MaterialObject.check().then(e=>{e&&(MY_API.CACHE.last_aid=e,MY_API.CACHE.MaterialObject_TS=ts_ms(),MY_API.saveCache()),MYDEBUG("[实物抽奖]",`将在${MY_API.CONFIG.MATERIAL_LOTTERY_CHECK_INTERVAL}分钟后再次运行实物抽奖`),setTimeout(MY_API.MaterialObject.run,6e4*MY_API.CONFIG.MATERIAL_LOTTERY_CHECK_INTERVAL||6e5)},()=>delayCall(()=>MY_API.MaterialObject.run()))}catch(e){return MY_API.chatLog("[实物抽奖]运行时出现异常","error"),MYERROR("实物抽奖出错",e),$.Deferred().reject()}},check:(aid,valid=639,rem=MY_API.CONFIG.MATERIAL_LOTTERY_REM||9)=>(aid=parseInt(aid||MY_API.CACHE.last_aid,10),isNaN(aid)&&(aid=valid),MYDEBUG("API.MaterialObject.check: aid=",aid),BAPI.Lottery.MaterialObject.getStatus(aid).then(response=>{if(MYDEBUG("API.MaterialObject.check: API.MY_API.MaterialObject.getStatus",response),0===response.code&&response.data){if(3!=response.data.typeB[response.data.typeB.length-1].status&&void 0===MY_API.MaterialObject.firstAid&&(MY_API.MaterialObject.firstAid=aid),MY_API.CONFIG.MATERIAL_LOTTERY_IGNORE_QUESTIONABLE_LOTTERY)for(const str of MY_API.CONFIG.QUESTIONABLE_LOTTERY)if("/"!=str.charAt(0)&&"/"!=str.charAt(str.length-1)){if(response.data.title.toLowerCase().indexOf(str.toLowerCase())>-1)return MY_API.chatLog(`[实物抽奖] 忽略存疑抽奖<br>${response.data.title} (aid = ${aid})<br>含有关键字：`+str,"warning"),MY_API.MaterialObject.check(aid+1,aid)}else{const reg=eval(str);if(reg.test(response.data.title))return MY_API.chatLog(`[实物抽奖] 忽略存疑抽奖<br>${response.data.title} (aid = ${aid})<br>匹配正则：`+str,"warning"),MY_API.MaterialObject.check(aid+1,aid)}return MY_API.MaterialObject.join(aid,response.data.title,response.data.typeB).then(()=>MY_API.MaterialObject.check(aid+1,aid))}if(-400===response.code||null==response.data)return rem?MY_API.MaterialObject.check(aid+1,valid,rem-1):$.Deferred().resolve(MY_API.MaterialObject.firstAid||valid);MY_API.chatLog("[实物抽奖] "+response.msg,"warning")},()=>(MY_API.chatLog(`[实物抽奖] 检查抽奖(aid = ${aid})失败，请检查网络`,"error"),delayCall(()=>MY_API.MaterialObject.check(aid,valid))))),join:(e,t,o,i=0)=>{if(i>=o.length)return $.Deferred().resolve();if(MY_API.MaterialObject.list.some(t=>t.aid===e&&t.number===i+1))return MY_API.MaterialObject.join(e,t,o,i+1);let r={title:t,aid:e,number:i+1,status:o[i].status,join_start_time:o[i].join_start_time,join_end_time:o[i].join_end_time,list:o[i].list,jpName:""};for(const e of r.list)r.jpName=r.jpName.concat(" ",e.jp_name);switch(r.status){case-1:{MY_API.chatLog(`[实物抽奖] 将在<br>${new Date(1e3*(r.join_start_time+1)).toLocaleString()}参加抽奖<br>"${r.title}"<br>aid = ${r.aid}，第${i+1}轮<br>奖品：${r.jpName}`,"info"),MY_API.MaterialObject.list.push(r);const e=$.Deferred();e.then(()=>MY_API.MaterialObject.draw(r)),setTimeout(()=>{e.resolve()},1e3*(r.join_start_time-ts_s()+1))}break;case 0:return MY_API.MaterialObject.draw(r).then(()=>MY_API.MaterialObject.join(e,t,o,i+1));case 1:{MY_API.chatLog(`[实物抽奖] 已参加抽奖<br>"${r.title}"<br>aid = ${r.aid} 第${i+1}轮<br>奖品：${r.jpName}`,"info"),MY_API.MaterialObject.list.push(r);const e=$.Deferred();e.then(()=>MY_API.MaterialObject.notice(r)),setTimeout(()=>{e.resolve()},1e3*(r.join_end_time-ts_s()+1))}break}return MY_API.MaterialObject.join(e,t,o,i+1)},draw:e=>BAPI.Lottery.MaterialObject.draw(e.aid,e.number).then(t=>{if(MYDEBUG("API.MaterialObject.check: API.MY_API.MaterialObject.draw",t),0===t.code){$.each(MY_API.MaterialObject.list,(t,o)=>{if(o.aid===e.aid&&o.number===e.number)return o.status=1,MY_API.MaterialObject.list[t]=o,!1}),MY_API.chatLog(`[实物抽奖] 成功参加抽奖<br>${e.title}<br>aid = ${e.aid}，第${e.number}轮<br>奖品：${e.jpName}`,"success"),MY_API.addMaterial();const t=$.Deferred();t.then(()=>MY_API.MaterialObject.notice(e)),setTimeout(()=>{t.resolve()},1e3*(e.join_end_time-ts_s()+1))}else MY_API.chatLog(`[实物抽奖] "${e.title}"(aid = ${e.aid}，第${e.number}轮)<br>${t.msg}`,"warning")},()=>(MY_API.chatLog(`[实物抽奖] 参加"${e.title}"(aid = ${e.aid}，第${e.number}轮)<br>失败，请检查网络`,"error"),delayCall(()=>MY_API.MaterialObject.draw(e)))),notice:e=>BAPI.Lottery.MaterialObject.getWinnerGroupInfo(e.aid,e.number).then(t=>{if(MYDEBUG("API.MaterialObject.check: API.MY_API.MaterialObject.getWinnerGroupInfo",t),0===t.code){$.each(MY_API.MaterialObject.list,(t,o)=>{if(o.aid===e.aid&&o.number===e.number)return o.status=3,MY_API.MaterialObject.list[t]=o,!1});for(const i of t.data.groups)for(const t of i.list)if(t.uid===Live_info.uid){if(MY_API.chatLog(`[实物抽奖] 抽奖"${e.title}"<br>aid = ${e.aid}，第${e.number}轮<br>获得奖励："${i.giftTitle}"`,"prize"),winPrizeNum++,winPrizeTotalCount++,JQlogRedPoint.text(winPrizeNum),JQlogRedPoint.is(":hidden")&&JQlogRedPoint.show(),MY_API.CONFIG.FT_NOTICE){function o(){return FT_sendMsg(MY_API.CONFIG.FT_SCKEY,`【${GM_info.script.name}】实物抽奖中奖通知 ${e.title}，第${e.number}轮`,`###实物抽奖中奖\n###中奖账号id：${Live_info.uname}\n###${e.title}\n###aid = ${e.aid}\n###第${e.number}轮\n###获得奖励：\n###${i.giftTitle}\n###请及时填写领奖信息`).then(e=>{MYDEBUG("FT_sendMsg response",e),0==e.body.errno?window.toast("[实物抽奖] 方糖中奖提示发送成功","success"):window.toast("[实物抽奖] 方糖中奖提示发送失败 "+e.errmsg,"error")}),()=>(MY_API.chatLog("[实物抽奖] 方糖中奖提示发送出错，请检查网络","error"),delayCall(()=>o()))}o()}return MY_API.CONFIG.GM_NOTICE&&GM_notice("实物抽奖中奖",`${e.title}，奖品：${i.giftTitle}`),!0}MY_API.chatLog(`[实物抽奖] 抽奖"${e.title}"(aid = ${e.aid}，第${e.number}轮)未中奖`,"info")}else MY_API.chatLog(`[实物抽奖] 抽奖"${e.title}"(aid = ${e.aid}，第${e.number}轮)<br>${t.msg}`,"warning")},()=>(MY_API.chatLog(`[实物抽奖] 获取抽奖"${e.title}"(aid = ${e.aid}，第${e.number}轮)<br>获取中奖名单失败，请检查网络`,"error"),delayCall(()=>MY_API.MaterialObject.notice(e))))},AnchorLottery:{allRoomList:eval("["+localStorage.getItem(NAME+"_AnchorRoomidList")+"]")||[],roomidList:[],liveUserList:[],liveRoomList:[],oldLotteryResponseList:[],lotteryResponseList:[],introRoomList:[],myLiveRoomid:0,followingList:[],unfollowList:[],uidInTagList:[],uidInOriginTag:[],medal_list:[],anchorFollowTagid:void 0,anchorPrizeTagid:void 0,getMedalList:async(e=1)=>(1===e&&(MY_API.AnchorLottery.medal_list=[]),BAPI.i.medal(e,25).then(t=>{if(MYDEBUG("AnchorLottery.getMedalList: API.i.medal",t),MY_API.AnchorLottery.medal_list=MY_API.AnchorLottery.medal_list.concat(t.data.fansMedalList),t.data.pageinfo.curPage<t.data.pageinfo.totalpages)return MY_API.AnchorLottery.getMedalList(e+1)},()=>(MY_API.chatLog("[天选时刻]<br>获取勋章列表失败，请检查网络","error"),delayCall(()=>MY_API.AnchorLottery.getMedalList())))),getFollowingList:(e=1,t=50)=>(1===e&&(MY_API.AnchorLottery.followingList=[]),BAPI.relation.getFollowings(Live_info.uid,e,t).then(o=>{MYDEBUG(`getFollowingList API.relation.getFollowings ${e}, ${t}`,o);let i=$.Deferred();if(0===o.code){i.resolve();const r=o.data.total;for(const e of o.data.list)MY_API.AnchorLottery.followingList.push(String(e.mid));return r-MY_API.AnchorLottery.followingList.length>0?$.when(MY_API.AnchorLottery.getFollowingList(e+1,t),i):(window.toast("[保存当前关注列表为白名单] 保存关注列表成功","success"),localStorage.setItem(NAME+"_AnchorFollowingList",JSON.stringify({list:MY_API.AnchorLottery.followingList})),getFollowBtnClickable=!0,i)}return window.toast("[保存当前关注列表为白名单] 获取关注列表出错 "+o.message,"error"),i.reject()},()=>(MY_API.chatLog("[天选时刻] 获取关注列表出错，请检查网络","error"),delayCall(()=>MY_API.AnchorLottery.getFollowingList())))),getLiveUsers:()=>BAPI.dynamic_svr.w_live_users().then(e=>{MYDEBUG("API.dynamic_svr.w_live_users",e);let t=$.Deferred();return 0===e.code?BAPI.dynamic_svr.w_live_users(e.data.count).then(o=>0===e.code?(MY_API.AnchorLottery.liveUserList=o.data.items,t.resolve()):(MY_API.chatLog("[天选时刻] 获取正在直播的已关注UP出错 "+o.msg,"caution"),t.reject())):(MY_API.chatLog("[天选时刻] 获取正在直播的已关注UP出错 "+e.msg,"caution"),t.reject())},()=>(MY_API.chatLog("[天选时刻] 获取正在直播的已关注UP出错，请检查网络","error"),delayCall(()=>MY_API.AnchorLottery.getLiveUsers()))),getTag:async(e,t=!1)=>MY_API.AnchorLottery.anchorFollowTagid&&MY_API.AnchorLottery.anchorPrizeTagid?$.Deferred().resolve():("string"==typeof e&&(e=[e]),BAPI.relation.getTags().then(o=>{if(MYDEBUG("API.relation.getTags",o),0===o.code){for(const t of o.data)t.name===anchorFollowTagName?e.indexOf(anchorFollowTagName)>-1&&(MY_API.AnchorLottery.anchorFollowTagid=t.tagid):t.name===anchorPrizeTagName&&e.indexOf(anchorPrizeTagName)>-1&&(MY_API.AnchorLottery.anchorPrizeTagid=t.tagid);if(t)return e.indexOf(anchorFollowTagName)>-1&&void 0===MY_API.AnchorLottery.anchorFollowTagid&&MY_API.chatLog(`[天选时刻] 分组【${anchorFollowTagName}】不存在，请先勾选【把参与天选时关注的UP移到新分组】和【参加天选时刻抽奖】，再次运行脚本。`,"warning"),e.indexOf(anchorPrizeTagName)>-1&&void 0===MY_API.AnchorLottery.anchorPrizeTagid&&MY_API.chatLog(`[天选时刻] 分组【${anchorPrizeTagName}】不存在，请先勾选【把发起抽奖的UP移到新分组】和【参加天选时刻抽奖】，再次运行脚本。`,"warning"),$.Deferred().resolve();{let e=$.Deferred(),t=$.Deferred();return void 0===MY_API.AnchorLottery.anchorFollowTagid&&MY_API.CONFIG.ANCHOR_MOVETO_FOLLOW_TAG?MY_API.AnchorLottery.creatTag(anchorFollowTagName).then(()=>e.resolve()):e.resolve(),void 0===MY_API.AnchorLottery.anchorPrizeTagid&&MY_API.CONFIG.ANCHOR_MOVETO_PRIZE_TAG?e.then(()=>MY_API.AnchorLottery.creatTag(anchorPrizeTagName).then(()=>t.resolve())):t.resolve(),$.when(e,t)}}return MY_API.chatLog("[天选时刻] 获取关注分组出错 "+o.message,"error"),p.reject()},()=>(MY_API.chatLog("[天选时刻] 获取关注分组出错，请检查网络","error"),delayCall(()=>MY_API.AnchorLottery.getTag(e))))),creatTag:e=>BAPI.relation.createTag(e).then(t=>{MYDEBUG("API.relation.createTag "+e,t);let o=$.Deferred();return 0===t.code?(e===anchorFollowTagName?MY_API.AnchorLottery.anchorFollowTagid=t.data.tagid:e===anchorPrizeTagName&&(MY_API.AnchorLottery.anchorPrizeTagid=t.data.tagid),o.resolve()):(MY_API.chatLog(`[天选时刻] 创建分组【${e}】出错 ${t.message}`,"error"),o.reject())},()=>(MY_API.chatLog("[天选时刻] 创建关注分组出错，请检查网络","error"),delayCall(()=>MY_API.AnchorLottery.creatTag(e)))),getUpInOriginTag:(e,t=0,o=1,i=50)=>BAPI.relation.getUpInTag(e,t,o,i).then(r=>{let a=$.Deferred();if(MYDEBUG(`API.relation.getUpInOriginTag ${t} ${o} ${i}`,r),0===r.code){if(a.resolve(),0===r.data.length)return a;for(const e of r.data)MY_API.AnchorLottery.uidInOriginTag.push(String(e.mid));return $.when(MY_API.AnchorLottery.getUpInOriginTag(e,t,o+1,i),a)}return window.toast("获取默认分组关注列表出错 "+r.message,"error"),a.reject()},()=>(MY_API.chatLog("[天选时刻] 获取Tag内UP列表出错，请检查网络","error"),delayCall(()=>MY_API.AnchorLottery.getUpInOriginTag(e,t=0,o=1,i=50)))),delAnchorFollowing:(e=1,t=1,o=50)=>{function i(e,t,o=1,r=50){return 1===o&&(MY_API.AnchorLottery.unfollowList=[]),BAPI.relation.getUpInTag(e,t,o,r).then(a=>{let n=$.Deferred();if(MYDEBUG(`API.relation.getUpInTag ${t} ${o} ${r}`,a),0===a.code){if(n.resolve(),0===a.data.length)return n;for(const e of a.data)MY_API.AnchorLottery.uidInTagList.push(String(e.mid));return $.when(i(e,t,o+1,r),n)}return window.toast("[取关BLTH天选分组内的UP] 获取关注列表出错 "+a.message,"error"),n.reject()},()=>(MY_API.chatLog("[天选时刻] 获取Tag内UP列表出错，请检查网络","error"),delayCall(()=>i(e,t,o=1,r=50))))}function r(e){let t,o;if(t=JSON.parse(localStorage.getItem(NAME+"_AnchorFollowingList"))||{list:[]},0===t.list.length)return window.toast("[取关不在白名单内的UP主] 请先点击【保存当前关注列表为白名单】!","info"),$.Deferred().resolve();o=[...t.list];let i=[],a=[];for(const t of e)-1===o.indexOf(String(t))&&i.push(t);for(let e=0;e<=i.length;e++)a[e]=$.Deferred(),MY_API.CONFIG.ANCHOR_WAIT_REPLY||a[e].resolve();a[0].resolve();for(let e=0;e<i.length;e++)a[e].then(()=>{let t=$.Deferred();setTimeout(()=>t.resolve(),MY_API.CONFIG.ANCHOR_INTERVAL),t.then(()=>{BAPI.relation.modify(i[e],2).then(t=>{MYDEBUG(`API.relation.modify ${i[e]}, 2`,t),0===t.code?(window.toast(`[天选时刻取关UP主] 取关UP(uid = ${i[e]})成功`,"success"),a[e+1].resolve()):(window.toast(`[天选时刻取关UP主] 取关UP(uid = ${i[e]})出错  ${t.message}`,"error"),a[e+1].reject())},()=>(MY_API.chatLog("[天选时刻] 取消关注出错，请检查网络","error"),delayCall(()=>r())))})});return $.when(...a)}return 1===e?function e(t,o){return BAPI.relation.getFollowings(Live_info.uid,t,o).then(i=>{MYDEBUG(`delAnchorFollowing API.relation.getFollowings(${t}, ${o})`,i);let r=$.Deferred();if(0===i.code){r.resolve();const a=i.data.total;for(const e of i.data.list)MY_API.AnchorLottery.unfollowList.push(String(e.mid));return a-MY_API.AnchorLottery.unfollowList.length>0?$.when(e(t+1,o),r):r}return window.toast("[取关不在白名单内的UP主] 获取关注列表出错 "+i.message,"error"),r.reject()},()=>(MY_API.chatLog("[天选时刻] 获取关注列表出错，请检查网络","error"),delayCall(()=>e(t,o))))}(t,o).then(()=>r(MY_API.AnchorLottery.unfollowList).then(()=>{unFollowBtnClickable=!0})):2===e?i(Live_info.uid,MY_API.AnchorLottery.anchorFollowTagid).then(()=>r(MY_API.AnchorLottery.uidInTagList).then(()=>{unFollowBtnClickable=!0})):3===e?i(Live_info.uid,MY_API.AnchorLottery.anchorPrizeTagid).then(()=>r(MY_API.AnchorLottery.uidInTagList).then(()=>{unFollowBtnClickable=!0})):void 0},getRoomList:async()=>{let e=await BAPI.room.getList().then(e=>(MYDEBUG("直播间列表",e),e.data),()=>(MY_API.chatLog("[天选时刻] 获取各分区的房间号出错，请检查网络","error"),delayCall(()=>MY_API.AnchorLottery.getRoomList())));const t=async()=>{for(const o of e)await BAPI.rankdb.getTopRealTimeHour(o.id).then(e=>{if(MYDEBUG(`API.rankdb.getTopRealTimeHour(${o.id})`,e),0===e.code){const t=e.data.list;MY_API.chatLog(`[天选时刻] 获取${o.name+"小时榜"}的直播间`,"info"),MYDEBUG(`[天选时刻] 获取${o.name+"小时榜"}房间列表`,e);for(const e of t)MY_API.AnchorLottery.roomidList.addVal(e.roomid)}else MY_API.chatLog(`[天选时刻] 获取${o.name+"小时榜"}的直播间出错<br>${e.message}`,"warning")},()=>(MY_API.chatLog("[天选时刻] 获取小时榜直播间出错，请检查网络","error"),delayCall(()=>t()))),await sleep(MY_API.CONFIG.ANCHOR_INTERVAL)},o=async()=>{for(const t of e)await BAPI.room.getRoomList(t.id,0,0,1,50).then(e=>{if(MYDEBUG(`API.room.getRoomList(${t.id}, 0, 0, 1, 50)`,e),0===e.code){const o=e.data.list;MY_API.chatLog(`[天选时刻] 获取${t.name+"分区"}的直播间`,"info"),MYDEBUG(`[天选时刻] 获取${t.name+"分区"}房间列表`,e);for(const e of o)-1===MY_API.AnchorLottery.roomidList.indexOf(e.roomid)&&MY_API.AnchorLottery.roomidList.unshift(e.roomid)}else MY_API.chatLog(`[天选时刻] 获取${t.name+"分区"}的直播间出错<br>${e.message}`,"warning")},()=>(MY_API.chatLog("[天选时刻] 获取分区直播间出错，请检查网络","error"),delayCall(()=>o()))),await sleep(MY_API.CONFIG.ANCHOR_INTERVAL)};return t().then(async()=>(await o(),MY_API.chatLog("[天选时刻] 高热度直播间收集完毕","success"),$.Deferred().resolve()))},uploadRoomList:async()=>{let e=void 0,t=$.Deferred();if(0===MY_API.AnchorLottery.lotteryResponseList.length){let t;await BAPI.room.getRoomBaseInfo(MY_API.CONFIG.ANCHOR_GETDATA_ROOM).then(t=>{MYDEBUG(`API.room.getRoomBaseInfo(${MY_API.CONFIG.ANCHOR_GETDATA_ROOM})`,t),0===t.code?e=t.data.by_room_ids[MY_API.CONFIG.ANCHOR_GETDATA_ROOM].description:MY_API.chatLog("[天选时刻] 获取直播间个人简介错误 "+t.message,"error")},()=>{MY_API.chatLog("[天选时刻] 获取直播间个人简介出错，请检查网络","error")});try{if(void 0===e)throw"undefined";if(t=JSON.parse(Base64.decode64(e.replaceAll("-",""))),"object"!=typeof t||!t)throw"Not a JSON";if(!t.hasOwnProperty("roomList"))throw"Missing property roomList";if(!t.hasOwnProperty("ts"))throw"Missing property ts"}catch(e){MYDEBUG("MY_API.AnchorLottery.uploadRoomList",`获取到的直播间简介格式有误 ${e}，上传初始值设为undefined`),t=void 0}if(void 0!==t){for(const e of t.roomList)MY_API.AnchorLottery.lotteryResponseList.push(e);MY_API.AnchorLottery.oldLotteryResponseList=[...MY_API.AnchorLottery.lotteryResponseList]}}if(MY_API.AnchorLottery.oldLotteryResponseList.length===MY_API.AnchorLottery.lotteryResponseList.length)return setTimeout(()=>MY_API.AnchorLottery.uploadRoomList(),1e3*MY_API.CONFIG.ANCHOR_UPLOAD_DATA_INTERVAL);if(0===MY_API.AnchorLottery.myLiveRoomid&&await BAPI.room.getRoomInfoOld(Live_info.uid).then(e=>{if(MYDEBUG(`API.room.getRoomInfoOld(${Live_info.uid})`,e),0!==e.code)return MY_API.chatLog("[天选时刻] 获取直播间信息出错 "+e.data.message,"error"),t.reject();MY_API.AnchorLottery.myLiveRoomid=e.data.roomid},()=>(MY_API.chatLog("[天选时刻] 获取直播间信息出错，请检查网络","error"),delayCall(()=>MY_API.AnchorLottery.uploadRoomList()))),0===MY_API.AnchorLottery.myLiveRoomid)return MY_API.chatLog("[天选时刻] 请先开通直播间再使用上传数据的功能","warning"),t.reject();MY_API.AnchorLottery.lotteryResponseList.length>MY_API.CONFIG.ANCHOR_MAXLIVEROOM_SAVE&&(MY_API.AnchorLottery.lotteryResponseList=MY_API.AnchorLottery.lotteryResponseList.splice(0,MY_API.CONFIG.ANCHOR_MAXLIVEROOM_SAVE));let o={roomList:MY_API.AnchorLottery.lotteryResponseList,ts:ts_ms()};MY_API.CONFIG.ANCHOR_UPLOAD_MSG&&(o.msg=MY_API.CONFIG.ANCHOR_UPLOAD_MSG_CONTENT);const i=Base64.encode64(JSON.stringify(o));let r="";for(let e=0;e<i.length;e++)r+=i[e]+(e===i.length-1?"":"-");return(a=MY_API.AnchorLottery.myLiveRoomid,n=r,BAPI.room.update(a,n).then(e=>(MYDEBUG("BAPI.room.update MY_API.AnchorLottery.myLiveRoomid encode64(uploadRawStr)",e),0==e.code?(MY_API.chatLog(`[天选时刻] 房间列表上传成功（共${MY_API.AnchorLottery.lotteryResponseList.length}个房间）`,"success"),MY_API.AnchorLottery.oldLotteryResponseList=[...MY_API.AnchorLottery.lotteryResponseList],t.resolve()):1===e.code?"出错啦，再试试吧"===e.message?(MY_API.chatLog(`[天选时刻] 上传失败，${MY_API.CONFIG.ANCHOR_UPLOAD_DATA_INTERVAL}秒后再次尝试`,"warning"),t.resolve()):"简介内容过长"===e.message?(MY_API.chatLog("[天选时刻] 上传失败，内容过长，清空数据","warning"),MY_API.AnchorLottery.lotteryResponseList=[],MY_API.AnchorLottery.oldLotteryResponseList=[],t.resolve()):"您所填写的简介可能涉及不符合相关法律法规和政策的内容，请修改"===e.message?(MY_API.chatLog("[天选时刻] 上传失败，"+e.message,"warning"),MY_API.AnchorLottery.oldLotteryResponseList=[...MY_API.AnchorLottery.lotteryResponseList],t.resolve()):(MY_API.chatLog("[天选时刻] 上传失败 "+e.message,"warning"),t.reject()):(MY_API.chatLog("[天选时刻] 房间列表上传失败 "+e.message,"error"),t.reject())),()=>(MY_API.chatLog("[天选时刻] 房间列表上传出错，请检查网络","error"),delayCall(()=>MY_API.AnchorLottery.uploadRoomList())))).then(()=>setTimeout(()=>MY_API.AnchorLottery.uploadRoomList(),1e3*MY_API.CONFIG.ANCHOR_UPLOAD_DATA_INTERVAL));var a,n},getLotteryInfoFromRoom:async()=>{let e,t=void 0;await BAPI.room.getRoomBaseInfo(MY_API.CONFIG.ANCHOR_GETDATA_ROOM).then(e=>{MYDEBUG(`API.room.getRoomBaseInfo(${MY_API.CONFIG.ANCHOR_GETDATA_ROOM})`,e),0===e.code?t=e.data.by_room_ids[MY_API.CONFIG.ANCHOR_GETDATA_ROOM].description:MY_API.chatLog("[天选时刻] 获取直播间个人简介错误 "+e.message,"error")},()=>{MY_API.chatLog("[天选时刻] 获取直播间个人简介出错，请检查网络","error")});try{if(void 0===t)throw"undefined";if(e=JSON.parse(Base64.decode64(t.replaceAll("-",""))),"object"!=typeof e||!e)throw"Not a JSON";if(!e.hasOwnProperty("roomList"))throw"Missing property roomList";if(!e.hasOwnProperty("ts"))throw"Missing property ts"}catch(e){return MY_API.chatLog(`[天选时刻] 直播间${MY_API.CONFIG.ANCHOR_GETDATA_ROOM}个人简介的数据格式不符合要求<br>`+e,"error"),setTimeout(()=>MY_API.AnchorLottery.getLotteryInfoFromRoom(),6e4*MY_API.CONFIG.ANCHOR_CHECK_INTERVAL)}return MY_API.AnchorLottery.introRoomList=[...e.roomList],MY_API.chatLog(`[天选时刻] 简介数据获取完毕（共${e.roomList.length}个房间）<br>数据来源：直播间${linkMsg(MY_API.CONFIG.ANCHOR_GETDATA_ROOM,liveRoomUrl+MY_API.CONFIG.ANCHOR_GETDATA_ROOM)}的个人简介${!MY_API.CONFIG.ANCHOR_IGNORE_UPLOAD_MSG&&e.hasOwnProperty("msg")&&e.msg.length>0&&!/<script\b[^<]*(?:(?!<\/script>)<[^<]*)*<\/script>/gi.test(e.msg)?"<br>附加信息："+e.msg:""}<br>该数据最后上传时间：${new Date(e.ts).toLocaleString()}`,"success")},moneyCheck:e=>{const t=e.replaceAll(" ","").toLowerCase();let o=t.match(/\d+(\.\d+)?/g),i=t.match(/([一二两三四五六七八九十]千零?[一二两三四五六七八九十]?百?[一二三四五六七八九十]?十?[一二三四五六七八九十]?)|([一二两三四五六七八九十]百[一二三四五六七八九十]?十?[一二三四五六七八九十]?)|([一二三四五六七八九十]?十[一二三四五六七八九十]?)|[一二两三四五六七八九十]/g);const r={"零":0,"一":1,"二":2,"三":3,"四":4,"五":5,"六":6,"七":7,"八":8,"九":9},a={"十":{value:10,secUnit:!1},"百":{value:100,secUnit:!1},"千":{value:1e3,secUnit:!1},"万":{value:1e4,secUnit:!0},"亿":{value:1e8,secUnit:!0}};if(null!==i&&null===o)return n();if(null===i&&null!==o)return l();if(null!==i&&null!==o){let e=l();return e[0]?e:n()}return[!1];function n(){let e=[];i.sort((function(e,t){return t.length-e.length}));for(const o of i)e.push(d(t,o,e));for(let o=0;o<i.length;o++){const r=i[o];if(void 0!==r){const a=_(r),n=e[o],l=r.length,d=e[o+1],I=n+l;let A="";if(I<d)for(let e=I;e<t.length;e++)if(void 0!==d){if(!(e<d))break;A+=t[e]}else A+=t[e];else A=t.slice(I,t.length);let c=s(a,A);if(void 0===c){if(o===i.length-1)return[!1];continue}return[!0,c]}}}function l(){let e=[];o.sort((function(e,t){return t.length-e.length}));for(const i of o)e.push(d(t,i,e));for(let i=0;i<o.length;i++){const r=o[i],a=t.indexOf(r),n=r.length,l=e[i+1],_=a+n;let d="";if(_<l)for(let e=_;e<t.length;e++)if(void 0!==l){if(!(e<l))break;d+=t[e]}else d+=t[e];else d=t.slice(_,t.length);let I=s(r,d);if(void 0!==I)return[!0,I];if(i===o.length-1)return[!1]}}function s(e,t){const o=["元","r","块"],i=["rmb","cny","人民币","软妹币","微信红包","红包","qq红包","现金"],r=["毛","角"],a=["分"],n=["金瓜子"],l=t[0];let s=void 0;const _=Number(e);for(const e of i)if(t.indexOf(e)>-1){s=_;break}for(const e of n)if(t.indexOf(e)>-1){s=.001*_;break}if(void 0===s)if(o.indexOf(l)>-1)s=_;else if(r.indexOf(l)>-1)s=.1*_;else if(a.indexOf(l)>-1){const e=["分钟"];for(const o of e)if(0===t.indexOf(o))return;s=.01*_}return s}function _(e){let t=0,o=0,i=0,n=!1,l=("十"===e[0]?"一"+e:e).split("");for(let e=0;e<l.length;e++){let s=r[l[e]];if(void 0!==s)i=s,e===l.length-1&&(o+=i);else{if(!a.hasOwnProperty(l[e]))return;let r=a[l[e]].value;n=a[l[e]].secUnit,n?(o=(o+i)*r,t+=o,o=0):o+=i*r,i=0}}return t+o}function d(e,t,o,i=0,r=0){let a=e.indexOf(t,i),n=o.indexOf(a,r);return n>-1?d(e,t,o,a+1,n+1):a}},check:(roomid,uid)=>MY_API.CONFIG.ANCHOR_IGNORE_ROOM&&MY_API.CONFIG.ANCHOR_IGNORE_ROOMLIST.indexOf(String(roomid))>-1?(MY_API.chatLog(`[天选时刻] 忽略直播间<br>不参加直播间${linkMsg(roomid,liveRoomUrl+roomid)}的天选`,"warning"),$.Deferred().resolve()):BAPI.xlive.anchor.check(roomid).then(response=>{if(MYDEBUG(`API.xlive.anchor.check(${roomid}) response`,response),0!==response.code||!response.data)return!1;{if(0===response.data.time)return MY_API.chatLog(`[天选时刻] 忽略过期天选<br>roomid = ${linkMsg(roomid,liveRoomUrl+roomid)}, id = ${response.data.id}`,"info"),!1;if(2===response.data.status)return MY_API.chatLog(`[天选时刻] 忽略已参加天选<br>roomid = ${linkMsg(roomid,liveRoomUrl+roomid)}, id = ${response.data.id}<br>奖品名：${response.data.award_name}<br>`,"info"),!1;MY_API.AnchorLottery.lotteryResponseList.addVal(response.data.room_id);const joinPrice=response.data.gift_num*response.data.gift_price,joinTextTitle=`${NAME}_ANCHOR_${response.data.id}`,ts=ts_ms();let defaultJoinData={id:response.data.id,gift_id:0===joinPrice?void 0:response.data.gift_id,gift_num:0===joinPrice?void 0:response.data.gift_num,roomid:roomid,award_name:response.data.award_name,time:response.data.time,require_type:response.data.require_type,joinPrice:joinPrice,uid:uid},medalJson=void 0,joinText=null,joinDisplay="block";switch(response.data.require_type){case 0:case 1:joinText="点击参加";break;case 2:joinText=1===response.data.require_value?"点击购买粉丝勋章并参加":"点击购买粉丝勋章";break;default:joinDisplay="none"}const joinHtml=(e=joinText,t=joinDisplay)=>`<div class = "clickableText" title = "${joinTextTitle}" ts = "${ts}" style = "display:${t};">${e}</div>`;function joinAnchorListener(){let e=$('div[title="'+joinTextTitle+'"][ts="'+ts+'"]'),t=setTimeout(()=>e.remove(),1e3*response.data.time);e.click(()=>{let e=$.Deferred();switch(response.data.require_type){case 2:let t=$.Deferred();defaultJoinData.uid?t.resolve():BAPI.live_user.get_anchor_in_room(roomid).then(e=>{MYDEBUG(`API.live_user.get_anchor_in_room(${roomid})`,e),e.data?(defaultJoinData.uid=e.data.info.uid,medalJson={anchorInfo:{uid:e.data.info.uid,uname:e.data.info.uname,face:e.data.info.face},medal_level:1,target_id:e.data.info.uid},t.resolve()):(MY_API.chatLog(`[天选时刻] 获取uid出错<br>roomid = ${roomid}<br>${e.msg}`,"error"),t.reject())},()=>{MY_API.chatLog("[天选时刻] 获取uid出错，请检查网络","error"),t.reject()}),t.then(()=>{BAPI.link_group.buy_medal(defaultJoinData.uid).then(t=>{MYDEBUG("API.link_group.buy_medal re",t),0===t.code?(1===response.data.require_value?(layer.msg("粉丝勋章购买成功，约2秒后参加天选",{time:2e3,icon:1}),setTimeout(()=>e.resolve(),2e3)):(layer.msg("粉丝勋章购买成功",{time:2e3,icon:1}),e.reject()),void 0!==medalJson&&MY_API.AnchorLottery.medal_list.push(medalJson)):(layer.msg("粉丝勋章购买失败 "+t.message,{time:3500,icon:2}),e.reject())},()=>{MY_API.chatLog("[天选时刻] 购买粉丝勋章出错，请检查网络","error"),e.reject()})});break;default:e.resolve()}e.then(()=>{BAPI.xlive.anchor.randTime(response.data.id).then(e=>{if(MYDEBUG("API.xlive.anchor.randTime "+response.data.id,e),0===response.code){if(!(response.data.time>0))return MY_API.chatLog(`[天选时刻] 该天选已过期<br>roomid = ${linkMsg(roomid,liveRoomUrl+roomid)}, id = ${response.data.id}<br>奖品名：${response.data.award_name}`,"info");{defaultJoinData.time=e.data.time,MY_API.AnchorLottery.join(defaultJoinData);let o=$('div[title="'+joinTextTitle+'"]');o.unbind("click"),o.remove(),clearTimeout(t)}}},()=>{MY_API.chatLog("[天选时刻] 获取天选开奖剩余时间失败，请检查网络","error")})})})}if(MY_API.CONFIG.ANCHOR_IGNORE_BLACKLIST)for(const str of MY_API.CONFIG.ANCHOR_BLACKLIST_WORD)if("/"!==str.charAt(0)&&"/"!==str.charAt(str.length-1)){if(response.data.award_name.toLowerCase().indexOf(str.toLowerCase())>-1)return MY_API.chatLog(`[天选时刻] 忽略存疑天选<br>roomid = ${linkMsg(roomid,liveRoomUrl+roomid)}, id = ${response.data.id}<br>奖品名：${response.data.award_name}<br>含有关键字：${str}<br>${"无"===response.data.require_text?"":"参加条件："+response.data.require_text+"<br>"}${0===joinPrice?"无需金瓜子":"所需金瓜子："+joinPrice}<br>${MY_API.AnchorLottery.countDown(response.data.time)}${joinHtml()}`,"warning"),joinAnchorListener(),!1}else try{const reg=eval(str);if(reg.test(response.data.award_name))return MY_API.chatLog(`[天选时刻] 忽略存疑天选<br>roomid = ${linkMsg(roomid,liveRoomUrl+roomid)}, id = ${response.data.id}<br>奖品名：${response.data.award_name}<br>匹配正则：${str}<br>${"无"===response.data.require_text?"":"参加条件："+response.data.require_text+"<br>"}${0===joinPrice?"无需金瓜子":"所需金瓜子："+joinPrice}<br>${MY_API.AnchorLottery.countDown(response.data.time)}${joinHtml()}`,"warning"),joinAnchorListener(),!1}catch(e){MYDEBUG("[天选时刻] 正则eval出错：",str)}if(MY_API.CONFIG.ANCHOR_IGNORE_MONEY>0||MY_API.CONFIG.ANCHOR_MONEY_ONLY){const e=MY_API.AnchorLottery.moneyCheck(response.data.award_name);if(e[0]){if(e[1]<MY_API.CONFIG.ANCHOR_IGNORE_MONEY)return MY_API.chatLog(`[天选时刻] 忽略金额小于${MY_API.CONFIG.ANCHOR_IGNORE_MONEY}元的天选<br>roomid = ${linkMsg(roomid,liveRoomUrl+roomid)}, id = ${response.data.id}<br>奖品名：${response.data.award_name}<br>${"无"===response.data.require_text?"":"参加条件："+response.data.require_text+"<br>"}识别到的金额：${e[1]}元<br>${0===joinPrice?"无需金瓜子":"所需金瓜子："+joinPrice}<br>${MY_API.AnchorLottery.countDown(response.data.time)}${joinHtml()}`,"warning"),joinAnchorListener(),!1}else if(MY_API.CONFIG.ANCHOR_MONEY_ONLY)return MY_API.chatLog(`[天选时刻] 忽略非现金抽奖的天选<br>roomid = ${linkMsg(roomid,liveRoomUrl+roomid)}, id = ${response.data.id}<br>奖品名：${response.data.award_name}<br>${"无"===response.data.require_text?"":"参加条件："+response.data.require_text+"<br>"}${0===joinPrice?"无需金瓜子":"所需金瓜子："+joinPrice}<br>${MY_API.AnchorLottery.countDown(response.data.time)}${joinHtml()}`,"warning"),!1}if(joinPrice>MY_API.CONFIG.AHCHOR_NEED_GOLD)return MY_API.chatLog(`[天选时刻] 忽略付费天选<br>roomid = ${linkMsg(roomid,liveRoomUrl+roomid)}, id = ${response.data.id}<br>奖品名：${response.data.award_name}<br>${"无"===response.data.require_text?"":"参加条件："+response.data.require_text+"<br>"}${0===joinPrice?"无需金瓜子":"所需金瓜子："+joinPrice}<br>${MY_API.AnchorLottery.countDown(response.data.time)}${joinHtml()}`,"warning"),joinAnchorListener(),!1;switch(response.data.require_type){case 0:case 1:return defaultJoinData;case 2:return BAPI.live_user.get_anchor_in_room(roomid).then(e=>{if(MYDEBUG(`API.live_user.get_anchor_in_room(${roomid})`,e),e.data){defaultJoinData.uid=e.data.info.uid,medalJson={anchorInfo:{uid:e.data.info.uid,uname:e.data.info.uname,face:e.data.info.face},medal_level:1,target_id:e.data.info.uid};for(const e of MY_API.AnchorLottery.medal_list)if(e.target_id===defaultJoinData.uid)return e.medal_level<response.data.require_value?(MY_API.chatLog(`[天选时刻] 忽略粉丝勋章等级不足的天选<br>roomid = ${linkMsg(roomid,liveRoomUrl+roomid)}, id = ${response.data.id}<br>奖品名：${response.data.award_name}<br>所需勋章等级：${response.data.require_value}<br>你的勋章等级：${e.level}<br>${MY_API.AnchorLottery.countDown(response.data.time)}`,"warning"),!1):defaultJoinData;return MY_API.chatLog(`[天选时刻] 忽略有粉丝勋章要求的天选<br>roomid = ${linkMsg(roomid,liveRoomUrl+roomid)}, id = ${response.data.id}<br>奖品名：${response.data.award_name}<br>所需勋章等级：${response.data.require_value}<br>你没有该勋章<br>${MY_API.AnchorLottery.countDown(response.data.time)}${joinHtml()}`,"warning"),joinAnchorListener(),!1}return MY_API.chatLog("[天选时刻] 获取uid出错<br>"+e.msg,"error"),!1},()=>(MY_API.chatLog("[天选时刻] 获取uid出错，请检查网络","error"),!1));case 3:return BAPI.xlive.getInfoByUser(roomid).then(e=>{if(MYDEBUG("API.xlive.getInfoByUser "+roomid,e),0===e.code){const o=e.data.privilege.privilege_type;if(0!==o&&o<=response.data.require_value)return defaultJoinData;{function t(e){switch(e){case 0:return"无";case 1:return"总督";case 2:return"提督";case 3:return"舰长";default:return"未知"}}const e=t(response.data.require_value),i=t(o);return MY_API.chatLog(`[天选时刻] 忽略大航海等级不足的天选<br>roomid = ${linkMsg(roomid,liveRoomUrl+roomid)}, id = ${response.data.id}<br>奖品名：${response.data.award_name}<br>所需大航海等级：${e}<br>你的大航海等级：${i}<br>${MY_API.AnchorLottery.countDown(response.data.time)}`,"warning"),!1}}return!1});case 4:return Live_info.user_level>=response.data.require_value?defaultJoinData:(MY_API.chatLog(`[天选时刻] 忽略直播等级不足的天选<br>roomid = ${linkMsg(roomid,liveRoomUrl+roomid)}, id = ${response.data.id}<br>奖品名：${response.data.award_name}<br>所需直播等级：${response.data.require_value}<br>你的直播等级：UL.${Live_info.user_level}<br>${MY_API.AnchorLottery.countDown(response.data.time)}`,"warning"),!1);case 5:return Live_info.level>=response.data.require_value?defaultJoinData:(MY_API.chatLog(`[天选时刻] 忽略主站等级不足的天选<br>roomid = ${linkMsg(roomid,liveRoomUrl+roomid)}, id = ${response.data.id}<br>奖品名：${response.data.award_name}<br>所需直播等级：${response.data.require_value}<br>你的主站等级：Lv${Live_info.level}<br>${MY_API.AnchorLottery.countDown(response.data.time)}`,"warning"),!1);default:return MYDEBUG("[天选时刻] 未被收录的类型 require_value = "+response.data.require_value,response),!1}}},()=>(MY_API.chatLog("[天选时刻] 天选检查出错，请检查网络","error"),delayCall(()=>MY_API.AnchorLottery.check(roomid)))),reCheck:e=>BAPI.xlive.anchor.check(e.roomid).then(t=>{if(MYDEBUG(`API.xlive.anchor.reCheck(${e.roomid}) response`,t),0===t.code&&t.data&&t.data.hasOwnProperty("award_users")&&t.data.award_users){let o=e.uid,i=!1;for(const e of t.data.award_users)if(e.uid===Live_info.uid){i=!0;break}if(i){if(MY_API.chatLog(`[天选时刻] 天选时刻<br>roomid = ${linkMsg(e.roomid,liveRoomUrl+e.roomid)}, id = ${e.id}中奖<br>奖品：${e.award_name}<br>`,"prize"),winPrizeNum++,winPrizeTotalCount++,JQlogRedPoint.text(winPrizeNum),JQlogRedPoint.is(":hidden")&&JQlogRedPoint.show(),MY_API.CONFIG.ANCHOR_PRIVATE_LETTER){const e={sender_uid:Live_info.uid,receiver_id:o,receiver_type:1,msg_type:1,msg_status:0,content:'{"content":"'+MY_API.CONFIG.ANCHOR_LETTER_CONTENT+'"}',dev_id:getMsgDevId()};setTimeout(()=>{BAPI.sendMsg(e).then(t=>{MYDEBUG("API.sendMsg "+e,t),0===t.code?window.toast(`[天选自动私信] 私信UP(uid = ${o})成功`,"success"):window.toast(`[天选自动私信] 私信UP(uid = ${o})失败 ${t.message}`,"error")},()=>{MY_API.chatLog(`[天选自动私信] 私信UP(uid = ${o})出错，请检查网络`)})},8e3)}if(MY_API.CONFIG.ANCHOR_MOVETO_PRIZE_TAG&&BAPI.relation.addUsers(o,MY_API.AnchorLottery.anchorPrizeTagid).then(e=>{MYDEBUG(`API.relation.addUsers ${o} ${MY_API.AnchorLottery.anchorPrizeTagid}`,e),0===e.code?window.toast(`[天选时刻] 移动UP（uid = ${o}）至分组【${anchorPrizeTagName}】成功`,"success"):window.toast(`[天选时刻] 移动UP（uid = ${o}）至分组【${anchorPrizeTagName}】失败 ${e.message}`,"warning")},()=>{MY_API.chatLog(`[天选时刻] 移动UP（uid = ${o}）到分组【${anchorPrizeTagName}】出错，请检查网络`,"error")}),MY_API.CONFIG.FT_NOTICE){!function t(){return FT_sendMsg(MY_API.CONFIG.FT_SCKEY,`${GM_info.script.name} 天选时刻中奖通知 ${(new Date).toLocaleString()}`,`###天选时刻中奖\n###中奖账号id：${Live_info.uname}\n###房间号roomid = ${e.roomid}\n###主播uid = ${o}\n###抽奖id = ${e.id}\n###获得奖品：\n###${e.award_name}\n###请及时私信主播发放奖励`).then(e=>{MYDEBUG("FT_sendMsg response",e),0==e.body.errno?window.toast("[天选时刻] 方糖中奖提示发送成功","success"):window.toast("[天选时刻] 方糖中奖提示发送失败 "+e.errmsg,"error")},()=>(MY_API.chatLog("[天选时刻] 方糖中奖提示发送出错，请检查网络","error"),delayCall(()=>t())))}()}if(MY_API.CONFIG.GM_NOTICE&&GM_notice("天选时刻中奖",`房间号：${e.roomid}，奖品：${e.award_name}`),MY_API.CONFIG.ANCHOR_DANMU){const t=MY_API.CONFIG.ANCHOR_DANMU_CONTENT[Math.floor(Math.random()*MY_API.CONFIG.MEDAL_DANMU_CONTENT.length)];MY_API.AnchorLottery.sendDanmu(t,e.roomid)}if(MY_API.CONFIG.ANCHOR_ADD_TO_WHITELIST){let e=[...(JSON.parse(localStorage.getItem(NAME+"_AnchorFollowingList"))||{list:[]}).list];e.push(String(o)),localStorage.setItem(NAME+"_AnchorFollowingList",JSON.stringify({list:e})),window.toast(`[天选时刻] 已将UP（uid = ${o}）添加至白名单`,"success")}}else if(MY_API.CONFIG.ANCHOR_AUTO_DEL_FOLLOW){if(-1===[...(JSON.parse(localStorage.getItem(NAME+"_AnchorFollowingList"))||{list:[]}).list].indexOf(String(o))&&-1===MY_API.AnchorLottery.uidInOriginTag.indexOf(String(o)))return BAPI.relation.modify(o,2).then(e=>{MYDEBUG("API.relation.modify response.info.uid, 2",e),0===e.code?window.toast(`[天选自动取关] 取关UP(uid = ${o})成功`,"success"):window.toast(`[天选自动取关] 取关UP(uid = ${o})出错  ${e.message}`,"error")},()=>{MY_API.chatLog(`[天选自动取关] 取关UP(uid = ${o})出错，请检查网络`)})}}},()=>(MY_API.chatLog("[天选时刻] 天选检查出错，请检查网络","error"),delayCall(()=>MY_API.AnchorLottery.check(roomid)))),sendDanmu:async(e,t)=>{let o=t;return Number(t)<=1e4&&(o=await BAPI.room.get_info(t).then(e=>(MYDEBUG(`API.room.get_info roomId=${t} res`,e),e.data.room_id))),BAPI.sendLiveDanmu(e,o).then(o=>{MYDEBUG(`[天选中奖弹幕] 弹幕发送内容【${e}】，房间号【${t}】`,o),0===o.code?window.toast(`[天选中奖弹幕] 弹幕【${e}】发送成功（房间号【${t}】）`,"success"):window.toast(`[天选中奖弹幕] 弹幕【${e}】（房间号【${t}】）出错 ${o.msg}`,"caution")},()=>(window.toast(`[天选中奖弹幕] 弹幕【${e}】（房间号【${t}】）发送失败`,"error"),$.Deferred().reject()))},countDown:(e,t="#da4939")=>void 0!==e?`<span id="time" style="color:${t};">距开奖还有<span class = 'num'>${e}</span>秒</span>`:"",pwdCheck:(e,t="")=>BAPI.room.verify_room_pwd(e,t).then(o=>(MYDEBUG(`API.room.verify_room_pwd(${e}, ${t})`,o),-1===o.code||0!==o.code),()=>{MY_API.chatLog("[天选时刻] 直播间加密检查出错，请检查网络","error")}),join:e=>BAPI.xlive.anchor.join(e.id,e.gift_id,e.gift_num).then(t=>{if(MYDEBUG(`API.xlive.anchor.join(${e.id}) response`,t),0!==t.code)return 500===t.code?(MY_API.chatLog(`[天选时刻] 天选参加失败<br>roomid = ${linkMsg(e.roomid,liveRoomUrl+e.roomid)}, id = ${e.id}<br>奖品：${e.award_name}<br>${t.msg}<br>3秒后再次尝试参加`,"warning"),setTimeout(()=>MY_API.AnchorLottery.join(e),3e3)):MY_API.chatLog(`[天选时刻] 天选参加失败<br>roomid = ${linkMsg(e.roomid,liveRoomUrl+e.roomid)}, id = ${e.id}<br>奖品：${e.award_name}<br>${t.msg}`,"warning");{MY_API.chatLog(`[天选时刻] 成功参加天选<br>roomid = ${linkMsg(e.roomid,liveRoomUrl+e.roomid)}, id = ${e.id}<br>${0===e.joinPrice?"":"花费金瓜子："+e.joinPrice+"<br>"}奖品：${e.award_name}<br>${MY_API.AnchorLottery.countDown(e.time)}`,"success");let t=$.Deferred();e.uid?t.resolve():BAPI.live_user.get_anchor_in_room(e.roomid).then(o=>{MYDEBUG(`API.live_user.get_anchor_in_room(${e.roomid})`,o),0===o.code?(e.uid=o.data.info.uid,t.resolve()):(MY_API.chatLog(`[天选时刻] 获取uid出错，中断后续操作<br>roomid = ${linkMsg(e.roomid,liveRoomUrl+e.roomid)}, id = ${e.id}<br>${o.msg}`,"error"),t.reject())},()=>{MY_API.chatLog(`[天选时刻] 获取uid出错，中断后续操作<br>roomid = ${linkMsg(e.roomid,liveRoomUrl+e.roomid)}, id = ${e.id}<br>请检查网络`,"error"),t.reject()}),t.then(()=>{if(MY_API.addAnchor(),MYDEBUG("天选时刻join data",e),1===e.require_type&&MY_API.CONFIG.ANCHOR_MOVETO_FOLLOW_TAG){if(MY_API.AnchorLottery.uidInOriginTag.indexOf(String(e.uid))>-1)return;setTimeout(()=>{BAPI.relation.addUsers(e.uid,MY_API.AnchorLottery.anchorFollowTagid).then(t=>{MYDEBUG(`API.relation.addUsers ${e.uid} ${MY_API.AnchorLottery.anchorFollowTagid}`,t),0===t.code?window.toast(`[天选时刻] 移动UP（uid = ${e.uid}）至分组【${anchorFollowTagName}】成功`,"success"):window.toast(`[天选时刻] 移动UP（uid = ${e.uid}）至分组【${anchorFollowTagName}】失败 ${t.message}`,"warning")},()=>{MY_API.chatLog(`[天选时刻] 移动UP（uid = ${e.uid}）到分组【${anchorFollowTagName}】出错，请检查网络`)})},4e3)}setTimeout(()=>MY_API.AnchorLottery.reCheck(e),1e3*e.time+1500)})}},()=>(MY_API.chatLog("[天选时刻] 天选参加出错，请检查网络","error"),delayCall(()=>MY_API.AnchorLottery.join(e)))),sleepCheck:()=>!!MY_API.CONFIG.TIME_AREA_DISABLE&&(!!inTimeArea(MY_API.CONFIG.TIME_AREA_START_H0UR,MY_API.CONFIG.TIME_AREA_END_H0UR,MY_API.CONFIG.TIME_AREA_START_MINUTE,MY_API.CONFIG.TIME_AREA_END_MINUTE)&&getIntervalTime(MY_API.CONFIG.TIME_AREA_END_H0UR,MY_API.CONFIG.TIME_AREA_END_MINUTE)),run:async()=>{if(!MY_API.CONFIG.ANCHOR_LOTTERY)return $.Deferred().resolve();function e(e,t=!1,o=!1){const i=MY_API.AnchorLottery.sleepCheck();if(i)return MYDEBUG("[天选时刻]",`处于休眠时段，${i}毫秒后再次检查天选`),MY_API.chatLog(`[天选时刻] 处于休眠时段，将会在<br>${new Date(ts_ms()+i).toLocaleString()}<br>结束休眠并继续检查天选`,"warning"),setTimeout(()=>e(),i);{const i=ts_ms()-MY_API.CACHE.AnchorLottery_TS,r=6e4*MY_API.CONFIG.ANCHOR_CHECK_INTERVAL,a=r-i;return o?(MYDEBUG("[天选时刻]",`将在${r}毫秒后检查天选`),t?MY_API.chatLog(`[天选时刻] <br>将在${MY_API.CONFIG.ANCHOR_CHECK_INTERVAL}分钟后开始检查天选`,"success"):MY_API.chatLog(`[天选时刻] 本次检查结束，将在<br>${MY_API.CONFIG.ANCHOR_CHECK_INTERVAL}分钟后继续检查天选`,"success"),setTimeout(()=>e(),r)):a<=0?e():(MYDEBUG("[天选时刻]",`将在${a}毫秒后检查天选`),t?MY_API.chatLog(`[天选时刻] <br>将在${parseInt(a/6e4)}分${parseInt(a%6e4/1e3)}秒后开始检查天选`,"success"):MY_API.chatLog(`[天选时刻] 本次检查结束，将在<br>${parseInt(a/6e4)}分${parseInt(a%6e4/1e3)}秒后继续检查天选`,"success"),setTimeout(()=>e(),a))}}return MY_API.chatLog("[天选时刻] 开始获取粉丝勋章信息"),await MY_API.AnchorLottery.getMedalList(),MY_API.chatLog("[天选时刻] 开始获取关注分组信息"),(MY_API.CONFIG.ANCHOR_MOVETO_FOLLOW_TAG||MY_API.CONFIG.ANCHOR_MOVETO_PRIZE_TAG)&&await MY_API.AnchorLottery.getTag([anchorFollowTagName,anchorPrizeTagName]),await MY_API.AnchorLottery.getUpInOriginTag(Live_info.uid),e((async function t(){if(MY_API.CONFIG.ANCHOR_TYPE_POLLING&&(MY_API.CONFIG.ANCHOR_UPLOAD_DATA&&await MY_API.AnchorLottery.uploadRoomList(),await MY_API.AnchorLottery.getRoomList()),MY_API.CONFIG.ANCHOR_TYPE_LIVEROOM&&await MY_API.AnchorLottery.getLotteryInfoFromRoom(),MY_API.CONFIG.ANCHOR_TYPE_FOLLOWING){await MY_API.AnchorLottery.getLiveUsers();for(const e of MY_API.AnchorLottery.liveUserList){const t=e.link.match(/(?<=https?:\/\/live\.bilibili\.com\/)\d+/)[0],o=String(e.uid);MY_API.AnchorLottery.liveRoomList.addVal(t+"|"+o)}MY_API.chatLog("[天选时刻] 已关注的开播直播间获取完毕","success")}const o=[...MY_API.AnchorLottery.liveRoomList,...MY_API.AnchorLottery.introRoomList,...MY_API.AnchorLottery.roomidList];for(const e of o)MY_API.AnchorLottery.allRoomList.addVal(e);MY_API.AnchorLottery.allRoomList.length>MY_API.CONFIG.ANCHOR_MAXROOM&&(MY_API.AnchorLottery.allRoomList=MY_API.AnchorLottery.allRoomList.splice(0,MY_API.CONFIG.ANCHOR_MAXROOM)),localStorage.setItem(NAME+"_AnchorRoomidList",MY_API.AnchorLottery.allRoomList),MY_API.chatLog(`[天选时刻] 开始检查天选（共${MY_API.AnchorLottery.allRoomList.length}个房间）`,"success");for(const e of MY_API.AnchorLottery.allRoomList){let t=$.Deferred();const o=String(e).split("|"),i=o[0],r=o[1];MY_API.CONFIG.ANCHOR_WAIT_REPLY||t.resolve(),MY_API.AnchorLottery.check(i,r).then(e=>{if(e){if(MY_API.CONFIG.ANCHOR_IGNORE_PWDROOM)return MY_API.AnchorLottery.pwdCheck(i).then(o=>{o?(MY_API.chatLog(`[天选时刻] 忽略加密直播间的天选<br>roomid = ${linkMsg(o[3],liveRoomUrl+o[3])}, id = ${o[0]}<br>${0===o[8]?"":"所需金瓜子："+o[8]+"<br>"}奖品：${o[4]}<br>${MY_API.AnchorLottery.countDown(o[5])}`,"warning"),t.resolve()):MY_API.AnchorLottery.join(e).then(()=>t.resolve())},()=>{MY_API.chatLog("[天选时刻] 直播间加密检查出错，请检查网络","error")});MY_API.AnchorLottery.join(e).then(()=>t.resolve())}else t.resolve()}),await t,await sleep(MY_API.CONFIG.ANCHOR_INTERVAL)}return MY_API.CACHE.AnchorLottery_TS=ts_ms(),MY_API.saveCache(),e(t,!1,!0)}),!0)}}};MY_API.init().then(()=>{try{let e=$.Deferred();if("false"!==localStorage.getItem(NAME+"_showEula")){const t=GM_getResourceText("eula");layer.open({title:GM_info.script.name+"最终用户许可协议",btn:["同意协议并继续","不同意"],closeBtn:0,area:[String(.618*$(window).width())+"px",String(.8*$(window).height())+"px"],content:t,yes:function(t){localStorage.setItem(NAME+"_showEula",!1),layer.close(t),e.resolve()},btn2:function(){layer.msg("脚本已停止运行",{time:3e3,icon:2}),MY_API.chatLog("由于未同意最终用户许可协议，<br>脚本已停止运行。","warning"),localStorage.setItem(NAME+"_showEula",!0),e.reject()},success:()=>{layerTimes++}})}else e.resolve();e.then(()=>{if(0===parseInt(Live_info.uid)||isNaN(parseInt(Live_info.uid)))return MY_API.chatLog("未登录，请先登录再使用脚本","warning");MY_API.CONFIG.UPDATE_TIP&&MY_API.newMessage(GM_info.script.version),MYDEBUG("MY_API.CONFIG",MY_API.CONFIG),main(MY_API)})}catch(e){MYERROR("初始化错误",e)}})}async function main(e){fixVersionDifferences(e,GM_info.script.version);let t=()=>{for(const t in e.GIFT_COUNT)"CLEAR_TS"!==t&&(e.GIFT_COUNT[t]=0);e.GIFT_COUNT.CLEAR_TS=ts_ms(),e.saveGiftCount(),$("#giftCount .anchor .statNum").text(e.GIFT_COUNT.ANCHOR_COUNT),$("#giftCount .material .statNum").text(e.GIFT_COUNT.MATERIAL_COUNT),MYDEBUG("已重置统计")};checkNewDay(e.GIFT_COUNT.CLEAR_TS)&&t(),runExactMidnight(()=>t(),"重置统计"),e.creatSetBox(),e.removeUnnecessary();let o=[...(JSON.parse(localStorage.getItem(NAME+"_AnchorFollowingList"))||{list:[]}).list];if(0!==o.length&&"number"==typeof o[0]){for(let e=0;e<o.length;e++)o[e]=String(o[e]);localStorage.setItem(NAME+"_AnchorFollowingList",JSON.stringify({list:o}))}if(runAllTasks(5e3,200,[e.MEDAL_DANMU.run,e.GroupSign.run,e.DailyReward.run,e.LiveReward.run,e.Exchange.runS2C,e.Exchange.runC2S,e.AUTO_DANMU.run,e.LITTLE_HEART.run,e.Gift.run,e.MaterialObject.run,e.AnchorLottery.run]),e.CONFIG.LOTTERY){let t;if(await BAPI.room.getList().then(o=>{MYDEBUG("直播间列表",o),t=o.data;for(const t of o.data)BAPI.room.getRoomList(t.id,0,0,1,1).then(o=>{MYDEBUG("直播间列表",o);for(let i=0;i<o.data.list.length;++i)e.listen(o.data.list[i].roomid,Live_info.uid,t.name+"区")},()=>{MY_API.chatLog("[礼物抽奖] 获取直播间列表出错，请检查网络","error")})},()=>{MY_API.chatLog("[礼物抽奖] 获取各分区的房间号出错，请检查网络","error")}),e.CONFIG.CHECK_HOUR_ROOM){let o=async()=>{if(e.blocked||e.max_blocked)return e.blocked?(e.chatLog("进入小黑屋检查小时榜已停止运行"),void clearInterval(i)):void e.chatLog("辣条已达到最大值检查小时榜已停止运行");if(e.CONFIG.TIME_AREA_DISABLE&&inTimeArea(e.CONFIG.TIME_AREA_START_H0UR,e.CONFIG.TIME_AREA_END_H0UR,e.CONFIG.TIME_AREA_START_MINUTE,e.CONFIG.TIME_AREA_END_MINUTE))e.chatLog("当前时间段不检查小时榜礼物","warning");else for(const o of t)await BAPI.rankdb.getTopRealTimeHour(o.id).then(t=>{let i=t.data.list;e.chatLog(`检查${o.name+"小时榜"}房间的礼物`,"warning");for(const t of i)e.checkRoom(t.roomid,`小时榜-${t.area_v2_parent_name}区`)})};setTimeout(o,6e3);let i=setInterval(o,parseInt(1e3*e.CONFIG.CHECK_HOUR_ROOM_INTERVAL))}}const i=t=>{let o=setTimeout(()=>{if(e.raffleId_list.length>0||e.guardId_list.length>0||e.pkId_list.length>0)return MYDEBUG("[刷新直播间]","还有礼物没抽，延迟15s后刷新直播间"),i(15e3);if(checkNewDay(e.CACHE.LittleHeart_TS))return MYDEBUG("[刷新直播间]","正在获取小心心，10分钟后再次检查"),clearTimeout(o),i(6e5);if(e.CONFIG.TIME_AREA_DISABLE&&inTimeArea(e.CONFIG.TIME_AREA_START_H0UR,e.CONFIG.TIME_AREA_END_H0UR,e.CONFIG.TIME_AREA_START_MINUTE,e.CONFIG.TIME_AREA_END_MINUTE)){let t=getIntervalTime(e.CONFIG.TIME_AREA_START_MINUTE,e.CONFIG.TIME_AREA_END_MINUTE)+6e4;return MYDEBUG("[刷新直播间]",`处于休眠时间段，将在${t}毫秒后刷新直播间`),i(t)}window.location.reload()},t)};e.CONFIG.TIME_RELOAD&&i(6e4*e.CONFIG.TIME_RELOAD_MINUTE)}function versionStringCompare(e="",t=""){let o=e.split("."),i=t.split("."),r=Math.max(o.length,i.length),a=!0;for(let e=0;e<r;e++){let t=o.length>e?o[e]:0,r=isNaN(Number(t))?t.charCodeAt():Number(t),n=i.length>e?i[e]:0,l=isNaN(Number(n))?n.charCodeAt():Number(n);if(r<l){a=!1;break}if(r>l){a=!0;break}}return a}function runAllTasks(e,t,o){let i=0;setTimeout(()=>{for(const e of o)setTimeout(()=>e(),t*i++)},e)}function fixVersionDifferences(e,t){if(versionStringCompare(storageLastFixVersion,"5.6.5"))return;const o=["AUTO_GIFT_ROOMID","EXCLUDE_ROOMID","COIN_UID"];if(!o.every(t=>$.isArray(e.CONFIG[t])))for(const t of o)$.isArray(e.CONFIG[t])||(e.CONFIG[t]=String(e.CONFIG[t]).split(","));"ANCHOR_LIVEROOM"==e.CONFIG.ANCHOR_TYPE&&(e.CONFIG.ANCHOR_TYPE_LIVEROOM=!0,e.CONFIG.ANCHOR_TYPE_POLLING=!1),"high"==e.CONFIG.GIFT_SORT?e.CONFIG.GIFT_SORT="GIFT_SORT_HIGH":"low"==e.CONFIG.GIFT_SORT&&(e.CONFIG.GIFT_SORT="GIFT_SORT_LOW");const i=JSON.parse(localStorage.getItem(NAME+"_CACHE")),r=[["materialobject_ts","MaterialObject_TS"],["medalDanmu_TS","MedalDanmu_TS"]];for(const t of r)i.hasOwnProperty(t[0])&&(e.CACHE[t[1]]=i[t[0]]);e.saveConfig(!1),e.saveCache(),localStorage.removeItem(NAME+"AnchorRoomidList");const a=localStorage.getItem(NAME+"AnchorFollowingList");null!==a&&localStorage.setItem(NAME+"_AnchorFollowingList",a),localStorage.removeItem(NAME+"AnchorFollowingList"),localStorage.setItem(NAME+"_lastFixVersion",t)}function animChange(e,t){t?(e.removeClass("layer-anim"),e.removeClass("layer-anim-00"),e.addClass("layer-anim"),e.addClass("layer-anim-close")):(e.removeClass("layer-anim"),e.removeClass("layer-anim-close"),e.addClass("layer-anim"),e.addClass("layer-anim-00"))}function downFile(e,t){let o=document.createElement("a");o.setAttribute("href","data:text/plain;charset=utf-8,"+JSON.stringify(t)),o.setAttribute("download",e),o.style.display="none",document.body.appendChild(o),o.click(),document.body.removeChild(o)}function exportConfig(e,t,o){return downFile("BLTH_CONFIG.json",{MY_API_CONFIG:e,nosleepConfig:t,INVISIBLE_ENTER_config:o})}function importConfig(){let e=document.getElementById("BLTH_config_file").files[0],t=new FileReader;function o(){return layer.msg("文件格式错误",{time:2e3,icon:2})}t.readAsText(e),t.onload=function(){MYDEBUG("importConfig 文件读取结果：",this.result);try{if(readConfigArray[0]=JSON.parse(this.result),"object"==typeof readConfigArray[0]&&readConfigArray[0]){const e=["MY_API_CONFIG","nosleepConfig","INVISIBLE_ENTER_config"];for(const t of e)if(!readConfigArray[0].hasOwnProperty(t))return o();return readConfigArray[1].resolve()}return o()}catch(e){return MYDEBUG("importConfig error：",e),o()}}}function getIntervalTime(e,t,o){const i=new Date,r=3600*e*1e3+60*t*1e3+(o?1e3*o:0)-(3600*i.getHours()*1e3+60*i.getMinutes()*1e3+1e3*i.getSeconds());return MYDEBUG("[getIntervalTime]获取间隔时间",r+"毫秒"),r<0?864e5+r:r}function isTime(e,t,o){let i=new Date,r=i.getHours(),a=i.getMinutes(),n=i.getSeconds();return r==e&&a==t&&!o||r==e&&a==t&&n==o||(MYDEBUG("isTime 错误时间",`目标时间${e}时${t}分${o||0}秒，当前时间${r}时${a}分${n}秒`),!1)}function inTimeArea(e,t,o,i){if(e>23||t>24||e<0||t<1||o>59||o<0||i>59||i<0)return!1;const r=36e5,a=6e4,n=new Date,l=n.getHours()*r+n.getMinutes()*a,s=e*r+o*a,_=t*r+i*a;return s<_?l>=s&&l<=_:l>=s||l<=_}function sleep(e){return new Promise(t=>{setTimeout(()=>{t()},e)})}function probability(e){if(e<=0)return!1;return e/100>=Math.random()}String.prototype.replaceAll=function(e,t){return this.replace(new RegExp(e,"gm"),t)},Array.prototype.rmVal=function(e){const t=this.indexOf(e);if(t>-1)return this.splice(t,1)},Array.prototype.addVal=function(e,t=1){if(-1===this.indexOf(e))return 1===t?this.unshift(e):this.push(e)},$((function(){if(void 0===W.BilibiliLive)return;if(newWindow.init(),nosleepConfig){const e=screen.availWidth,t=screen.availHeight;let o=document.createEvent("MouseEvents");setInterval(()=>{let i=parseInt(Math.random()*e),r=parseInt(Math.random()*t);o.initMouseEvent("mousemove",!0,!0,W,0,i,r,i,r,!1,!1,!0,!1,0,null),W.dispatchEvent(o)},3e5),W.addEventListener=(...e)=>e[0].indexOf("visibilitychange")>-1?void 0:eventListener(...e)}if(INVISIBLE_ENTER_config)try{ah.proxy({onRequest:(e,t)=>{e.url.includes("//api.live.bilibili.com/xlive/web-room/v1/index/getInfoByUser")&&(MYDEBUG("getInfoByUser request",e),e.url="//api.live.bilibili.com/xlive/web-room/v1/index/getInfoByUser?room_id=22474988"),t.next(e)},onResponse:async(e,t)=>{e.config.url.includes("//api.live.bilibili.com/xlive/web-room/v1/index/getInfoByUser")&&(MYDEBUG("getInfoByUser response",e),e.response.includes('"code":0')||(MYDEBUG("隐身入场出错，取消隐身入场并以当前房间号再次获取用户数据"),e.response=await BAPI.xlive.getInfoByUser(W.BilibiliLive.ROOMID).then(e=>{if(MYDEBUG("API.xlive.getInfoByUser(W.BilibiliLive.ROOMID)",e),0===e.code)return JSON.stringify(e);window.toast("获取房间基础信息失败","error")})),e.response=e.response.replace('"is_room_admin":false','"is_room_admin":true')),t.next(e)}})}catch(e){MYDEBUG("ah.proxy Ajax-hook代理运行出错",e)}try{let e=localStorage.getItem(NAME+"_UNIQUE_CHECK_CACHE")||0;const t=ts_ms();if(t-e>=0&&t-e<=15e3)return window.toast("有其他直播间页面的脚本正在运行，本页面脚本停止运行","caution"),$.Deferred().resolve();let o;const i=()=>{o=setTimeout(i,1e4),e=ts_ms(),localStorage.setItem(NAME+"_UNIQUE_CHECK_CACHE",e)};window.addEventListener("unload",()=>{o&&(clearTimeout(o),localStorage.setItem(NAME+"_UNIQUE_CHECK_CACHE",0))}),i()}catch(e){return MYDEBUG("重复运行检测错误",e),$.Deferred().reject()}const e=(t=0)=>setTimeout(async()=>{if(0===parseInt(W.BilibiliLive.UID)||isNaN(parseInt(W.BilibiliLive.UID)))return e(1e3);Live_info.room_id=W.BilibiliLive.ROOMID,Live_info.uid=W.BilibiliLive.UID,Live_info.tid=W.BilibiliLive.ANCHOR_UID,await BAPI.gift.gift_config().then(e=>{MYDEBUG("InitData: API.gift.gift_config",e),e.data&&$.isArray(e.data)?Live_info.gift_list=e.data:e.data.list&&$.isArray(e.data.list)?Live_info.gift_list=e.data.list:(Live_info.gift_list=[{id:6,price:1e3},{id:1,price:100},{id:30607,price:5e3}],window.toast("直播间礼物数据获取失败，使用备用数据","warning"))}),await BAPI.getuserinfo().then(e=>{MYDEBUG("InitData: API.getuserinfo",e),e.data?(Live_info.uname=e.data.uname,Live_info.user_level=e.data.user_level):window.toast("API.getuserinfo 获取用户信息失败 "+e.message,"error")}),await BAPI.x.getAccInfo(Live_info.uid).then(e=>{MYDEBUG("InitData: API.x.getAccInfo",e),0===e.code?Live_info.level=e.data.level:window.toast("API.x.getAccInfo 获取用户信息失败 "+e.message,"error")}),Live_info.bili_jct=BAPI.getCookie("bili_jct"),Live_info.ruid=W.BilibiliLive.ANCHOR_UID,Live_info.rnd=W.BilibiliLive.RND,Live_info.visit_id=W.__statisObserver?W.__statisObserver.__visitId:"",MYDEBUG("Live_info",Live_info),init()},t);return e()}));const checkNewDay=e=>{if(0===e)return!0;let t=new Date(e),o=new Date,i=t.getDate();return o.getDate()!==i};function FT_sendMsg(e,t,o){return XHR({GM:!0,anonymous:!0,method:"POST",url:`http://sc.ftqq.com/${e}.send`,data:`text=${t}&desp=${o}`,responseType:"json"})}function GM_notice(e,t,o=1e4){return GM_notification({title:e,text:t,timeout:o,onclick:function(){logDiv.hasClass("active")&&logDiv.click()}})}function getMsgDevId(e=NAME){let t=window.localStorage.getItem("im_deviceid_".concat(e));if(!e||!t){let t="xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,(function(e){let t=16*Math.random()|0;return("x"===e?t:3&t|8).toString(16).toUpperCase()}));return function(e,t){Object.keys(localStorage).forEach((function(e){e.match(/^im_deviceid_/)&&window.localStorage.removeItem(e)})),window.localStorage.setItem("im_deviceid_".concat(t),e)}(t,e),t}return t}function XHR(e){return new Promise(t=>{const o=o=>{MYERROR("XHR出错","参数"+e,o),t(void 0)};if(e.GM)"POST"===e.method&&(void 0===e.headers&&(e.headers={}),void 0===e.headers["Content-Type"]&&(e.headers["Content-Type"]="application/x-www-form-urlencoded; charset=utf-8")),e.timeout=3e4,e.onload=e=>t({response:e,body:e.response}),e.onerror=o,e.ontimeout=o,GM_xmlhttpRequest(e);else{const i=new XMLHttpRequest;i.open(e.method,e.url),"POST"===e.method&&null===i.getResponseHeader("Content-Type")&&i.setRequestHeader("Content-Type","application/x-www-form-urlencoded; charset=utf-8"),e.cookie&&(i.withCredentials=!0),void 0!==e.responseType&&(i.responseType=e.responseType),i.timeout=3e4,i.onload=e=>{const o=e.target;t({response:o,body:o.response})},i.onerror=o,i.ontimeout=o,i.send(e.data)}})}})();